<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español</title>
    <meta name="description" content="ToDayList: Tu gestor de tareas diarias y lista to-do minimalista y eficiente en español. Organiza tus pendientes, establece prioridades, añade subtareas y fechas límite. Con integración Google Drive y Calendar. ¡Mejora tu productividad hoy!">
    <meta name="keywords" content="lista de tareas, to-do list, gestor de tareas diarias, organizador personal, productividad, planificación diaria, tareas pendientes, subtareas, prioridades, web app, enrique gil, ToDayList, google drive, google calendar, español, en español, tareas recurrentes, programar eventos">
    <meta name="author" content="Enrique Gil">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.todaylist.es/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.todaylist.es/">
    <meta property="og:title" content="ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español">
    <meta property="og:description" content="Organiza tus pendientes con ToDayList: tu gestor de tareas diarias y lista to-do minimalista y eficiente en español con integración de Google Drive y Calendar. Programa eventos recurrentes fácilmente.">
    <meta property="og:image" content="https://www.todaylist.es/ToDayList.png">
    <meta property="og:site_name" content="ToDayList">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.todaylist.es/">
    <meta property="twitter:title" content="ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español">
    <meta property="twitter:description" content="Organiza tus pendientes con ToDayList: tu gestor de tareas diarias y lista to-do minimalista y eficiente en español con integración de Google Drive y Calendar. Programa eventos recurrentes fácilmente.">
    <meta property="twitter:image" content="https://www.todaylist.es/ToDayList.png">

    <!-- Favicons -->
    <link rel="icon" href="/favicon-96x96.png" type="image/png" sizes="96x96">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" sizes="any">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español",
      "description": "ToDayList es tu gestor de tareas diarias y lista to-do minimalista y eficiente en español. Organiza tus pendientes, establece prioridades, añade subtareas, fechas límite y programa eventos recurrentes en Google Calendar. Con integración Google Drive. ¡Mejora tu productividad hoy!",
      "url": "https://www.todaylist.es/",
      "primaryImageOfPage": "https://www.todaylist.es/ToDayList.png",
      "mainEntity": {
        "@type": "SoftwareApplication",
        "name": "ToDayList",
        "applicationCategory": "https://schema.org/ProductivityApplication",
        "operatingSystem": "Web Browser",
        "description": "ToDayList es un gestor de tareas diarias y lista to-do minimalista y eficiente en español que te ayuda a organizar tus pendientes, establecer prioridades, añadir subtareas, agendar en Google Calendar (incluyendo eventos recurrentes) y sincronizar con Google Drive. Ideal para simplificar y organizar tus tareas diarias y aumentar tu productividad.",
        "url": "https://www.todaylist.es/",
        "author": {
          "@type": "Person",
          "name": "Enrique Gil"
        },
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD",
          "availability": "https://schema.org/OnlineOnly"
        },
        "image": [
           "https://www.todaylist.es/ToDayList.png",
           "https://www.todaylist.es/favicon-96x96.png",
           "https://www.todaylist.es/favicon.svg"
        ],
        "softwareVersion": "2.1.1", // Actualizar si es necesario (ej. nueva versión con IndexedDB)
        "datePublished": "2024-03-15", 
        "keywords": "lista de tareas, to-do list, gestor de tareas diarias, organizador personal, productividad, planificación diaria, tareas pendientes, subtareas, prioridades, web app, task management, daily planner, online organizer, google drive sync, google calendar integration, free app, español, en español, tareas recurrentes, programar eventos, recurring events, temporizador tareas, task timer, contador dias tarea, indexeddb"
      }
    }
    </script>

    <style>
         .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :root {
            --bg-color: #d4ccbc;
            --text-color: #333;
            --heading-color: #222;
            --item-bg: #f2eee6;
            --border-color: #e0e0e0;
            --input-bg: #f2eee6;
            --input-text-color: #333;
            --placeholder-color: #888;
            --button-color: #555;
            --button-hover-color: #e74c3c;
            --delete-button-color: var(--button-color);
            --delete-button-hover-color: var(--button-hover-color);
            --completed-text-color: #999;
            --progress-bg: #e0ffe0;
            --progress-bar-color: #66c266;
            --progress-bar-completed-color: #28a745;
            --empty-list-color: #888;
            --fixed-button-bg: #f2eee6;
            --fixed-button-border: #ccc;
            --fixed-button-shadow: 0 2px 5px rgba(0,0,0,0.2);
            --legend-text-color: #666;
            --sort-button-color: #555;
            --sort-button-hover-color: #3498db;
            --footer-text-color: #aaa;
            --medal-color: #ffd700;
            --total-score-label-color: #7f8c8d;
            --total-score-value-color: var(--text-color);
            --medal-text-color: var(--text-color);
            --subtitle-color: #777;
            --app-description-color: #555;
            --priority-red-color: #e74c3c;
            --priority-orange-color: #f39c12;
            --priority-yellow-color: #f1c40f;
            --priority-green-color: #2ecc71;
            --priority-none-color: var(--border-color);
            --welcome-button-bg: #e74c3c;
            --welcome-button-text: #fff;
            --welcome-button-hover-bg: #c0392b;
            --drive-icon-color: #4285F4;
            --accent-color: #3498db;
            --modal-input-background-color: #f2eee6;
            --modal-input-border-color: var(--border-color);
            --schedule-link-text-color: var(--accent-color);
            --schedule-link-hover-text-color: #2980b9;
            --schedule-link-disabled-text-color: #7f8c8d;
            --checkbox-checkmark-color: var(--item-bg);
            --reset-button-text-color: #95a5a6;
            --reset-button-hover-text-color: #e74c3c;
            --quick-calendar-section-bg: #e9e4d9;
            --quick-calendar-border-color: #d1c8b8;
            --focus-visible-outline-color: #3498db;
        }

        body.dark-mode {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --heading-color: #ecf0f1;
            --item-bg: #34495e;
            --border-color: #4a627a;
            --input-bg: #445b71;
            --input-text-color: #ecf0f1;
            --placeholder-color: #bdc3c7;
            --button-color: #bdc3c7;
            --button-hover-color: #f39c12;
            --delete-button-color: var(--button-color);
            --delete-button-hover-color: var(--button-hover-color);
            --completed-text-color: #7f8c8d;
            --progress-bg: #4a627a;
            --progress-bar-color: #8bc34a;
            --progress-bar-completed-color: #28a745;
            --empty-list-color: #bdc3c7;
            --fixed-button-bg: #34495e;
            --fixed-button-border: #4a627a;
            --fixed-button-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --legend-text-color: #a0a0a0;
            --sort-button-color: #bdc3c7;
            --sort-button-hover-color: #3498db;
            --checkbox-checkmark-color: var(--bg-color);
            --footer-text-color: #777;
            --medal-text-color: var(--text-color);
            --total-score-label-color: #95a5a6;
            --total-score-value-color: var(--text-color);
            --subtitle-color: #bdc3c7;
            --app-description-color: #a0a0a0;
            --welcome-button-bg: #f39c12;
            --welcome-button-text: #2c3e50;
            --welcome-button-hover-bg: #e67e22;
            --drive-icon-color: #4A90E2;
            --accent-color: #5dade2;
            --modal-input-background-color: var(--input-bg);
            --modal-input-border-color: var(--border-color);
            --schedule-link-text-color: var(--accent-color);
            --schedule-link-hover-text-color: #3498db;
            --schedule-link-disabled-text-color: #7f8c8d;
            --reset-button-text-color: #7f8c8d;
            --reset-button-hover-text-color: #f39c12;
            --quick-calendar-section-bg: #2f4254;
            --quick-calendar-border-color: #3e5265;
            --focus-visible-outline-color: #5dade2;
        }

        body {
            font-family: 'Lexend', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 120px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 0 10px;
            box-sizing: border-box;
            flex-grow: 1;
            position: relative;
            padding-bottom: 20px;
        }

        #page-title {
            text-indent: 101%;
            overflow: hidden;
            white-space: nowrap;
            font-size: 0;
            line-height: 0;
            color: transparent;
            padding: 0;
            background-image: url('/Logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: block;
            width: 100%;
            max-width: 300px;
            height: 90px;
            margin: 40px auto 10px auto;
            cursor: default;
        }

        .subtitle {
            text-align: center;
            font-family: 'Lexend', sans-serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--subtitle-color);
            margin-top: 0;
            margin-bottom: 10px;
            letter-spacing: 0.2px;
        }
        .app-description-static {
            text-align: center;
            font-family: 'Lexend', sans-serif;
            font-size: 0.9rem;
            font-weight: 300;
            color: var(--app-description-color);
            margin-top: 0;
            margin-bottom: 40px;
            line-height: 1.5;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }

        #welcome-section {
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        .welcome-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            border-radius: 12px;
        }
        #welcome-section h2 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.8rem;
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 15px;
        }
        #welcome-section p {
            font-size: 0.95rem;
            color: var(--text-color);
            margin-bottom: 15px;
            line-height: 1.6;
        }
        #welcome-section p:first-of-type {
             margin-bottom: 40px;
        }

        #welcome-section ul {
            list-style: none;
            padding-left: 0;
            margin: 20px auto;
            max-width: 400px;
            text-align: left;
        }
        #welcome-section ul li {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
            line-height: 1.5;
        }
        #welcome-section ul li::before {
            content: "\f00c";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 0;
            top: 3px;
            color: var(--progress-bar-completed-color);
        }
        body.dark-mode #welcome-section ul li::before {
            color: var(--progress-bar-color);
        }
        #start-app-button {
            background-color: var(--welcome-button-bg);
            color: var(--welcome-button-text);
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            margin-top: 20px;
            display: inline-block;
            outline: none;
        }
        #start-app-button:hover {
            background-color: var(--welcome-button-hover-bg);
            transform: translateY(-2px);
        }
        #start-app-button:focus-visible {
             outline: 3px solid var(--button-hover-color);
             outline-offset: 2px;
        }

        #install-instructions-section {
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 18px 22px;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            font-size: 0.85rem;
            color: var(--text-color);
        }
        #install-instructions-section h4 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.2rem;
            color: var(--subtitle-color);
            margin-top: 0;
            margin-bottom: 8px;
            text-align: center;
        }
        #install-instructions-section p {
            font-size: 0.95em;
            color: var(--text-color);
            margin-bottom: 12px;
            line-height: 1.45;
            text-align: center;
        }
        #install-instructions-section ul {
            list-style: none;
            padding-left: 5px;
            margin: 0 auto;
            max-width: 480px;
        }
        #install-instructions-section ul li {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.92em;
            padding-left: 25px;
            position: relative;
            text-align: left;
        }
        #install-instructions-section ul li::before {
            font-family: "Font Awesome 6 Brands", "Font Awesome 6 Free";
            font-weight: 400;
            position: absolute;
            left: 0px;
            top: 1px;
            width: 20px;
            text-align: center;
            color: var(--button-color);
            font-size: 1.1em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #install-instructions-section ul li:nth-child(1)::before { content: "\f268"; font-weight: 400; }
        #install-instructions-section ul li:nth-child(2)::before { content: "\f17b"; font-weight: 400; }
        #install-instructions-section ul li:nth-child(3)::before { content: "\f179"; font-weight: 400; }
        #install-instructions-section ul li:nth-child(4)::before { content: "\f267"; font-weight: 400; }

        #install-instructions-section ul li strong {
            color: var(--heading-color);
            font-weight: 700;
        }
        #install-instructions-section ul li i.fas.fa-download,
        #install-instructions-section ul li i.fas.fa-ellipsis-v,
        #install-instructions-section ul li i.fas.fa-share-square {
            color: var(--button-hover-color);
            margin: 0 2px;
            font-size: 0.9em;
        }

        .hidden {
            display: none !important;
        }

        #medal-counter-container {
            text-align: center;
            font-size: 1.2rem;
            color: var(--medal-text-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            flex-wrap: wrap;
        }
        #medal-counter-container .daily-medals .fa-medal {
            color: var(--medal-color);
            margin-right: 5px;
        }
        #medal-count {
            font-weight: bold;
        }
        #medal-counter-container .total-score-counter {
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        #total-score-label {
            color: var(--total-score-label-color);
            font-weight: 300;
            margin-right: 6px;
        }
        #total-score-value {
            font-weight: 400;
            color: var(--total-score-value-color);
            min-width: 2.5ch;
            text-align: left;
        }
        #reset-total-score-button {
            font-size: 0.7em;
            color: var(--reset-button-text-color);
            background: none;
            border: none;
            padding: 0 0 0 5px;
            margin-left: 3px;
            cursor: pointer;
            line-height: 1;
            vertical-align: middle;
            outline: none;
        }
        #reset-total-score-button:hover {
            color: var(--reset-button-hover-text-color);
        }
        #reset-total-score-button i {
            font-size: 0.9em;
        }
        #reset-total-score-button:focus-visible {
             outline: 1px dotted var(--reset-button-hover-text-color);
             outline-offset: 1px;
        }


        #priority-legend {
            text-align: center;
            font-size: 0.75rem;
            color: var(--legend-text-color);
            margin-top: 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px 10px;
        }
         #priority-legend .priority-legend-item {
             display: inline-flex;
             align-items: center;
             gap: 4px;
        }
         #priority-legend .priority-color-label {
             width: 10px;
             height: 10px;
             margin-right: 0;
             flex-shrink: 0;
         }
         #priority-legend .priority-color-label:hover {
             transform: none;
         }

        #todo-list {
            list-style: none;
            padding: 0;
            margin: 0 0 30px 0;
        }

        .todo-item {
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, padding 0.3s ease, border-left-color 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 5px solid var(--border-color);
            padding-left: 10px;
        }
         .todo-item:last-child {
             margin-bottom: 0;
         }

        .todo-item[data-priority-color="red"] { border-left-color: var(--priority-red-color); }
        .todo-item[data-priority-color="orange"] { border-left-color: var(--priority-orange-color); }
        .todo-item[data-priority-color="yellow"] { border-left-color: var(--priority-yellow-color); }
        .todo-item[data-priority-color="green"] { border-left-color: var(--priority-green-color); }
        .todo-item[data-priority-color="none"] { border-left-color: var(--priority-none-color); }


         .app-button {
             background: none;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             transition: color 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
             flex-shrink: 0;
             padding: 6px 10px;
             font-size: 1rem;
             line-height: 1;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             text-decoration: none;
             color: var(--button-color);
             outline: none;
         }
         .app-button:hover {
             color: var(--button-hover-color);
         }
         .app-button:focus-visible {
              outline: 2px solid var(--focus-visible-outline-color);
              outline-offset: 2px;
         }
         .app-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
         }
         .app-button:disabled:hover {
            color: var(--button-color);
         }
         .app-button:disabled:focus-visible {
             outline: none;
         }

         .add-button {
             color: var(--button-color);
             font-weight: bold;
         }
         .add-button:hover {
             color: var(--button-hover-color);
         }
         .delete-button {
             color: var(--delete-button-color);
         }
         .delete-button:hover {
             color: var(--delete-button-hover-color);
         }
         .sort-button {
             color: var(--sort-button-color);
             font-weight: normal;
             padding: 10px 15px;
             font-size: 1.1rem;
         }
         .sort-button:hover {
             color: var(--sort-button-hover-color);
         }

         #dark-mode-toggle {
             position: fixed;
             bottom: 20px;
             right: 20px;
             font-size: 1.3rem;
             color: var(--button-color);
             z-index: 1000;
             background-color: var(--fixed-button-bg);
             border: 1px solid var(--fixed-button-border);
             border-radius: 50%;
             width: 45px;
             height: 45px;
             display: flex;
             justify-content: center;
             align-items: center;
             box-shadow: var(--fixed-button-shadow);
             transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
         }
         #dark-mode-toggle:hover {
             color: var(--button-hover-color);
         }
         #dark-mode-toggle i {
             line-height: 1;
         }

        #new-todo-input,
        .todo-item .subtask-input-container input[type="text"] {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex-grow: 1;
            min-width: 150px;
            font-size: 0.95rem;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--input-text-color);
            outline: none;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        #new-todo-input:focus,
        .todo-item .subtask-input-container input[type="text"]:focus {
            border-color: var(--button-hover-color);
            box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
        }
        body.dark-mode #new-todo-input:focus,
        body.dark-mode .todo-item .subtask-input-container input[type="text"]:focus {
            box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.2);
        }

        #new-todo-input::placeholder,
        .todo-item .subtask-input-container input[type="text"]::placeholder {
             color: var(--placeholder-color);
             opacity: 1;
        }

         .custom-checkbox {
             margin-right: 10px;
             border: 1px solid var(--text-color);
             border-radius: 50%;
             appearance: none;
             -webkit-appearance: none;
             width: 20px;
             height: 20px;
             background-color: var(--item-bg);
             cursor: pointer;
             position: relative;
             flex-shrink: 0;
             box-sizing: border-box;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             outline: none;
         }
         .custom-checkbox:checked {
              background-color: var(--text-color);
              border-color: var(--text-color);
         }
         .custom-checkbox:focus-visible {
             outline: 2px solid var(--focus-visible-outline-color);
             outline-offset: 1px;
         }

         .custom-checkbox:checked::after {
             content: '';
             position: absolute;
             box-sizing: content-box;
             width: 5px;
             height: 9px;
             border: solid var(--checkbox-checkmark-color);
             border-width: 0 2px 2px 0;
             top: 3px;
             left: 6px;
             transform: rotate(45deg);
         }

        .todo-item .main-task-header {
            display: flex;
            align-items: flex-start; /* Alinea checkbox y texto/acciones */
            margin-bottom: 15px;
            padding: 0;
            gap: 8px;
            transition: margin-bottom 0.3s ease;
        }
        .todo-item .main-task-header .task-prefix-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            padding-top: 2px; /* Ajuste fino para alinear mejor con el texto si este es multilínea */
        }

        .todo-item .priority-color-label {
             display: inline-block;
             width: 16px;
             height: 16px;
             border: 1px solid var(--border-color);
             border-radius: 4px;
             cursor: pointer;
             flex-shrink: 0;
             transition: border-color 0.2s ease, transform 0.1s ease, background-color 0.2s ease;
             box-sizing: border-box;
             outline: none;
        }
         .todo-item .priority-color-label:hover {
             transform: scale(1.1);
         }
         .todo-item .priority-color-label:focus-visible {
             outline: 2px solid var(--focus-visible-outline-color);
             outline-offset: 1px;
         }

        .priority-color-label[data-color="red"] { background-color: var(--priority-red-color); border-color: var(--priority-red-color); }
        .priority-color-label[data-color="orange"] { background-color: var(--priority-orange-color); border-color: var(--priority-orange-color); }
        .priority-color-label[data-color="yellow"] { background-color: var(--priority-yellow-color); border-color: var(--priority-yellow-color); }
        .priority-color-label[data-color="green"] { background-color: var(--priority-green-color); border-color: var(--priority-green-color); }
        .priority-color-label[data-color="none"] { background-color: transparent; border-color: var(--border-color); }

        .todo-item .main-task-header .task-body {
            display: flex; /* Contenedor de (texto+info) y (acciones) */
            flex-grow: 1;
            align-items: flex-start; /* Alinea el grupo de texto/info y el grupo de acciones */
            gap: 8px; /* Espacio entre texto/info y acciones */
            min-width: 0; /* Para que el contenido interno se ajuste */
        }

        /* --- NUEVO CONTENEDOR PARA TEXTO Y CONTADOR DE DÍAS --- */
        .todo-item .main-task-header .task-body .task-text-and-info {
            display: flex;
            flex-direction: column; /* Texto arriba, contador de días abajo */
            flex-grow: 1; /* Ocupa el espacio disponible antes de las acciones */
            min-width: 0; /* Permite que el texto de la tarea se ajuste (word-break) */
        }

        /* Estilo para el span del texto de la tarea principal (modificado) */
        .todo-item .main-task-header .task-body .task-text-and-info > span:first-child:not(.task-timer-countdown):not(.task-days-ago) {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-color);
            transition: color 0.3s ease, text-decoration 0.3s ease, font-size 0.3s ease;
            word-break: break-word;
            line-height: 1.45;
        }

        /* --- NUEVO ESTILO PARA EL CONTADOR DE DÍAS --- */
        .task-days-ago {
            font-size: 0.75rem;
            color: var(--legend-text-color);
            margin-top: 2px; /* Pequeño espacio debajo del texto de la tarea */
            line-height: 1.2;
        }
        .todo-item.completed .task-days-ago {
            display: none; /* Ocultar contador en tareas completadas */
        }
        /* --- FIN NUEVOS ESTILOS CONTADOR --- */


        .todo-item .main-task-header .task-body .task-actions-group {
            display: flex;
            align-items: center; /* Alinea los botones de acción verticalmente */
            gap: 2px;
            margin-left: auto; /* Empuja las acciones a la derecha (opcional si task-text-and-info tiene flex-grow) */
            flex-shrink: 0; /* Evita que el grupo de acciones se encoja */
        }


        .todo-item .main-task-header .task-body .task-actions-group .link-button,
        .todo-item .main-task-header .task-body .task-actions-group .google-calendar-button,
        .todo-item .main-task-header .task-body .task-actions-group .task-timer-button {
            padding-left: 4px;
            padding-right: 4px;
            font-size: 1rem;
        }

        .todo-item .main-task-header .task-body .task-actions-group .google-calendar-button i {
            color: var(--button-color);
            transition: color 0.2s ease;
        }
        .todo-item .main-task-header .task-body .task-actions-group .google-calendar-button:hover i {
            color: var(--button-hover-color);
        }

        .todo-item .main-task-header .task-body .link-button {
            font-size: 1rem;
            opacity: 0.5;
        }
        .todo-item .main-task-header .task-body .link-button.link-on {
            opacity: 1;
        }

        .todo-item .main-task-header .task-body .task-actions-group .delete-button {
             padding: 4px 8px;
             font-size: 1rem;
             margin-left: 6px;
        }


        .todo-item .add-subtasks-toggle {
             display: block;
             width: fit-content;
             margin: 10px 0 0 auto;
             padding: 4px 8px;
             font-size: 1.1rem;
             font-weight: normal;
             color: var(--legend-text-color);
             transition: opacity 0.3s ease, visibility 0.3s ease;
        }
         .todo-item .add-subtasks-toggle:hover {
             color: var(--button-hover-color);
         }

        .todo-item .subtask-input-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding: 0;
            align-items: center;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
         .todo-item .subtask-input-container button {
             padding: 8px 12px;
             font-size: 1rem;
         }

        .todo-item .subtasks-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            border-left: 2px solid var(--border-color);
            padding-left: 20px;
            transition: border-left-color 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
        }
        .todo-item .subtasks-list li {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            gap: 5px;
        }
         .todo-item .subtasks-list li:last-child {
             margin-bottom: 0;
         }

        .todo-item .subtasks-list li input[type="checkbox"] {
             width: 18px;
             height: 18px;
             border-color: var(--text-color);
             border-radius: 50%;
             appearance: none;
             -webkit-appearance: none;
             background-color: var(--item-bg);
             cursor: pointer;
             position: relative;
             flex-shrink: 0;
             box-sizing: border-box;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             outline: none;
        }
         .todo-item .subtasks-list li input[type="checkbox"]:checked {
              background-color: var(--text-color);
              border-color: var(--text-color);
         }
         .todo-item .subtasks-list li input[type="checkbox"]:focus-visible {
             outline: 2px solid var(--focus-visible-outline-color);
             outline-offset: 1px;
         }

        .todo-item .subtasks-list li input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            box-sizing: content-box;
            width: 4px;
            height: 8px;
            border: solid var(--checkbox-checkmark-color);
            border-width: 0 1.8px 1.8px 0;
            top: 2.5px;
            left: 5px;
            transform: rotate(45deg);
        }


        .todo-item .subtasks-list li span:not(.task-timer-countdown) {
             flex-grow: 1;
             color: var(--button-color);
             text-decoration: none;
             transition: color 0.3s ease, text-decoration 0.3s ease;
             word-break: break-word;
             font-size: 0.85em;
             font-weight: 300;
             line-height: 1.3;
        }
         .todo-item .subtasks-list li .subtask-move-button {
             color: var(--button-color);
             padding: 4px;
             font-size: 0.9rem;
         }
         .todo-item .subtasks-list li .subtask-move-button:hover {
             color: var(--button-hover-color);
         }
         .todo-item .subtasks-list li .subtask-move-button:disabled {
             opacity: 0.3;
             cursor: not-allowed;
             color: var(--button-color);
         }
         .todo-item .subtasks-list li .subtask-move-button:disabled:hover {
             color: var(--button-color);
         }
         .todo-item .subtasks-list li .delete-button {
             padding: 4px 8px;
             font-size: 1rem;
         }

        .todo-item .progress-container {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            margin-top: 15px;
            margin-bottom: 0;
            overflow: hidden;
            background-color: var(--progress-bg);
            transition: background-color 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
        }
        .todo-item .progress-bar {
            height: 100%;
            background-color: var(--progress-bar-color);
            width: 0%;
            transition: width 0.5s ease-in-out, background-color 0.3s ease;
        }
         .todo-item .progress-text { display: none; }

        #todo-list:empty:before {
            content: "No hay tareas. ¡Agrega una!";
            display: block;
            text-align: center;
            color: var(--empty-list-color);
            margin-top: 20px;
            font-style: italic;
            transition: color 0.3s ease;
        }

        .todo-item.show-subtask-ui .subtask-input-container {
             display: flex;
        }
        .todo-item.show-subtask-ui .add-subtasks-toggle {
             display: none;
        }

        /* Estilo para el span del texto de la tarea principal CUANDO ESTÁ COMPLETADA (y subtareas) */
        .todo-item.completed .main-task-header .task-body .task-text-and-info > span:first-child:not(.task-timer-countdown):not(.task-days-ago),
        .todo-item.completed .subtasks-list li span:not(.task-timer-countdown) {
            color: var(--completed-text-color);
            text-decoration: line-through;
        }
        /* Ajuste específico para el tamaño de fuente del texto principal completado */
        .todo-item.completed .main-task-header .task-body .task-text-and-info > span:first-child:not(.task-timer-countdown):not(.task-days-ago) {
             font-size: 1rem; /* Reducir tamaño cuando completada */
        }


        .todo-item.completed .progress-bar {
            background-color: var(--progress-bar-completed-color);
        }

        .todo-item.completed .priority-color-label {
            background-color: transparent !important;
            border-color: var(--border-color) !important;
            cursor: default;
        }

        .todo-item.completed .subtasks-list li .app-button {
            opacity: 0.7;
            cursor: default;
        }


        .todo-item.completed .main-task-header .task-body .task-actions-group .google-calendar-button,
        .todo-item.completed .main-task-header .task-body .task-actions-group .task-timer-button {
            opacity: 0.7;
            cursor: default;
            pointer-events: none;
        }
        .todo-item.completed .main-task-header .task-body .task-actions-group .google-calendar-button:hover i,
        .todo-item.completed .main-task-header .task-body .task-actions-group .task-timer-button:hover i {
            color: var(--completed-text-color) !important;
        }


        .todo-item.completed .main-task-header .task-body .task-actions-group .delete-button {
            opacity: 0.7;
        }
        .todo-item.completed .main-task-header .task-body .task-actions-group .delete-button:hover {
            opacity: 0.7;
            color: var(--delete-button-color);
        }

        .todo-item.completed .main-task-header .task-body .link-button.link-on {
            opacity: 0.8;
            cursor: pointer;
        }
        .todo-item.completed .main-task-header .task-body .link-button.link-on:hover {
            color: var(--button-hover-color);
            opacity: 1;
        }
        .todo-item.completed .main-task-header .task-body .link-button.link-off {
            opacity: 0.4;
            cursor: default;
        }
        .todo-item.completed .main-task-header .task-body .link-button.link-off:hover {
            color: var(--button-color);
            opacity: 0.4;
        }

        .todo-item.completed .priority-color-label:hover,
        .todo-item.completed .subtasks-list li .app-button:hover {
            color: inherit;
            text-decoration: none;
            transform: none;
        }
        .todo-item.completed .priority-color-label:focus-visible,
        .todo-item.completed .app-button:focus-visible,
        .todo-item.completed .custom-checkbox:focus-visible {
            outline: none;
        }


         .todo-item.completed .main-task-header .task-prefix-group .custom-checkbox {
             border-color: var(--completed-text-color);
             background-color: var(--completed-text-color);
         }
         .todo-item.completed .main-task-header .task-prefix-group .custom-checkbox:checked::after {
              border-color: var(--checkbox-checkmark-color) !important;
         }

         #todo-input-container {
             display: flex;
             gap: 10px;
             padding: 0;
             align-items: center;
             margin-bottom: 20px;
             flex-wrap: wrap;
         }
          #todo-input-container label.sr-only {
              flex-shrink: 0;
          }

          #todo-input-container #add-todo-button {
               margin-left: 0;
               padding: 10px 15px;
               font-size: 1.1rem;
          }
          
          #reorder-buttons-group {
            display: flex;
            gap: 5px; /* Espacio entre botones de ordenamiento */
            margin-left: auto; /* Empuja el grupo a la derecha */
          }


        #quick-notes-container {
            margin-top: 25px;
            margin-bottom: 50px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #quick-notes-area {
            width: 100%;
            min-height: 70px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'Lexend', sans-serif;
            font-weight: 300;
            font-size: 0.85rem;
            line-height: 1.4;
            background-color: var(--input-bg);
            color: var(--input-text-color);
            box-sizing: border-box;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        #quick-notes-area::placeholder {
            color: var(--placeholder-color);
            opacity: 1;
        }
        #quick-notes-area:focus {
            border-color: var(--button-hover-color);
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.15);
        }
        body.dark-mode #quick-notes-area:focus {
            box-shadow: 0 0 0 2px rgba(243, 156, 18, 0.2);
        }


        #clear-notes-button {
            align-self: flex-end;
            padding: 5px 10px;
            font-size: 0.8rem;
            color: var(--button-color);
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        #clear-notes-button:hover {
            color: var(--button-hover-color);
            border-color: var(--button-hover-color);
            background-color: var(--fixed-button-bg);
        }
        #clear-notes-button i {
            margin-right: 4px;
        }

        #quick-calendar-event-section {
            margin-top: 30px;
            margin-bottom: 25px;
            padding: 12px 15px;
            background-color: var(--quick-calendar-section-bg);
            border: 1px solid var(--quick-calendar-border-color);
            border-radius: 6px;
            box-shadow: none;
        }
        #quick-calendar-event-section h4 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.1rem;
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 8px;
            text-align: center;
        }
        #quick-calendar-event-section p {
            font-size: 0.8rem;
            color: var(--legend-text-color);
            text-align: center;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        #open-quick-schedule-modal-button {
            display: block;
            margin: 0 auto;
            padding: 7px 12px !important;
            font-size: 0.85rem !important;
            min-width: auto;
            max-width: 280px;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            color: var(--button-color);
            font-weight: 400;
            border-radius: 6px;
        }
        #open-quick-schedule-modal-button:hover {
            border-color: var(--button-hover-color) !important;
            background-color: var(--fixed-button-bg);
            color: var(--button-hover-color);
        }
        #open-quick-schedule-modal-button i {
            margin-right: 6px;
        }


        #data-management-section {
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        #data-management-section h4 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.2rem;
            color: var(--subtitle-color);
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
        }
        .data-management-intro {
            font-size: 0.85rem;
            color: var(--legend-text-color);
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        .data-options-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .data-options-row:last-child {
            margin-bottom: 0;
        }

        .data-action-button {
            min-width: 200px;
            max-width: 300px;
            padding: 9px 15px !important;
            font-size: 0.9rem !important;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            color: var(--button-color);
            font-weight: 400;
            border-radius: 6px;
        }
        .data-action-button:hover {
            border-color: var(--button-hover-color) !important;
            background-color: var(--fixed-button-bg);
            color: var(--button-hover-color);
        }
        .data-action-button i {
            margin-right: 8px;
            font-size: 0.95em;
        }

        .drive-button-style i.fab.fa-google-drive {
             color: var(--drive-icon-color);
        }
        .drive-button-style:disabled i.fab.fa-google-drive {
            color: inherit;
            opacity: 0.7;
        }
        .drive-button-style:disabled {
            background-color: var(--input-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--placeholder-color) !important;
            opacity: 0.7;
        }


        #info-button {
            position: absolute;
            top: 15px;
            left: 15px;
            font-family: 'Quicksand', sans-serif;
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--button-color);
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 900;
            line-height: 1;
            padding: 0;
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }
        #info-button:hover {
            color: var(--button-hover-color);
            background-color: var(--fixed-button-bg);
            border-color: var(--button-hover-color);
        }

        footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: var(--footer-text-color);
            margin-top: 30px;
            padding: 20px 10px 15px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
        }
        .footer-logo {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            border-radius: 12px;
        }
        .footer-text {
            margin: 0 0 8px 0;
            color: var(--footer-text-color);
            font-size: 0.85em;
        }
        .footer-version {
            font-size: 0.75em;
            color: var(--legend-text-color);
            margin-top: -6px;
            margin-bottom: 10px;
        }

        #support-section-footer {
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .support-intro-text {
            font-size: 0.7rem;
            color: var(--legend-text-color);
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .paypal-link-footer {
            display: inline-flex;
            align-items: center;
            font-size: 0.7rem;
            color: var(--legend-text-color);
            text-decoration: none;
            transition: color 0.2s ease;
            outline: none;
        }
        .paypal-link-footer:focus-visible {
             outline: 1px dashed var(--button-hover-color);
             outline-offset: 1px;
        }

        .paypal-link-footer:hover {
            color: var(--button-hover-color);
            text-decoration: underline;
        }

        .paypal-link-footer i.fab.fa-paypal {
            margin-right: 4px;
            font-size: 0.9em;
        }
        .footer-legal-links {
            margin-top: 15px;
            font-size: 0.75em;
        }
        .footer-legal-links a {
            margin: 0 5px;
            color: var(--legend-text-color);
            text-decoration: none;
            outline: none;
        }
         .footer-legal-links a:focus-visible {
             outline: 1px dashed var(--button-hover-color);
             outline-offset: 1px;
             text-decoration: underline;
         }
        .footer-legal-links a:hover {
            text-decoration: underline;
            color: var(--button-hover-color);
        }
        .footer-legal-links span {
            color: var(--legend-text-color);
        }

        .todo-item.completed {
            padding-top: 8px;
            padding-bottom: 8px;
            border-left-color: transparent !important;
        }

        .todo-item.completed .main-task-header {
            margin-bottom: 0;
            align-items: center;
        }

        .todo-item.completed .progress-container,
        .todo-item.completed .add-subtasks-toggle,
        .todo-item.completed .subtasks-list,
        .todo-item.completed .main-task-header .task-body .task-actions-group .google-calendar-button,
        .todo-item.completed .main-task-header .task-body .task-actions-group .link-button {
            display: none;
        }

        /* .todo-item.completed .main-task-header .task-body span ya se maneja con el selector más específico */


        @media (max-width: 500px) {
            #page-title {
                height: 70px;
                margin-top: 20px;
                margin-bottom: 5px;
            }
            .subtitle {
                font-size: 1rem;
            }
            .app-description-static {
                font-size: 0.85rem;
                margin-bottom: 40px;
            }
            #info-button {
                font-size: 1.2rem;
                width: 32px;
                height: 32px;
                top: 10px;
                left: 10px;
            }
            .todo-item .main-task-header {
                row-gap: 8px; /* Mantenido por si acaso, aunque align-items:flex-start puede hacerlo menos relevante */
            }
             .todo-item .main-task-header .task-body {
                gap: 4px; /* Espacio reducido entre (texto+info) y (acciones) */
                /* flex-wrap: wrap;  Considerar si es necesario, puede romper la línea de acciones */
            }
            .todo-item .main-task-header .task-body .task-actions-group {
                gap: 0;
                 /* flex-basis: 100%; Si se quiere que las acciones siempre estén en nueva línea en móvil */
                 /* margin-left: 0;  Si se quiere que las acciones estén alineadas a la izquierda debajo */
            }
             .todo-item .main-task-header .task-body .task-actions-group .app-button {
                padding-left: 3px;
                padding-right: 3px;
                font-size: 0.9rem;
            }
            .todo-item .main-task-header .task-body .task-actions-group .delete-button {
                margin-left: 3px;
            }


             #todo-input-container #reorder-buttons-group {
                  margin-left: 0;
                  width: 100%;
                  justify-content: flex-start; /* Opcional: center, space-between */
             }
             #data-management-section {
                padding: 15px 10px;
             }
             #data-management-section h4 {
                font-size: 1.1rem;
             }
            .data-management-intro {
                font-size: 0.8rem;
                margin-bottom: 15px;
            }
             .data-options-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .data-action-button {
                min-width: unset;
                width: 100%;
                max-width: unset;
                margin-bottom: 0;
            }

             #welcome-section h2 {
                 font-size: 1.5rem;
             }
             #welcome-section p {
                 font-size: 0.9rem;
                 margin-bottom: 15px;
             }
             #welcome-section p:first-of-type {
                 margin-bottom: 40px;
             }
             #welcome-section ul li {
                 font-size: 0.85rem;
             }
             #start-app-button {
                padding: 10px 20px;
                font-size: 1rem;
            }

            #install-instructions-section {
                padding: 15px 18px;
                font-size: 0.8rem;
            }
            #install-instructions-section h4 {
                font-size: 1.1rem;
            }
            #install-instructions-section ul li {
                font-size: 0.95em;
                padding-left: 22px;
                margin-bottom: 7px;
            }
            #install-instructions-section ul li::before {
                top: 0px;
                font-size: 1em;
            }

            footer {
                font-size: 0.75rem;
                padding-top: 15px;
            }
            .footer-logo {
                width: 40px;
                height: 40px;
                margin-bottom: 8px;
            }
            .footer-text {
                margin-bottom: 6px;
                font-size: 0.9em;
            }
            .footer-version {
                font-size: 0.7em;
            }
            .support-intro-text,
            .paypal-link-footer {
                font-size: 0.7em;
            }
            .support-intro-text {
                margin-bottom: 2px;
            }
            .footer-legal-links {
                font-size: 0.7em;
            }
        }

        /* --- MODALES --- */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            padding-top: 60px;
            padding-bottom: 20px;
            box-sizing: border-box;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .modal-content {
            background-color: var(--item-bg);
            color: var(--text-color);
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 420px;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            box-sizing: border-box;
        }
        #info-modal .modal-content {
            max-width: 580px;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--heading-color);
            text-align: center;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.6rem;
        }

        .modal-input-group input[type="text"],
        .modal-input-group input[type="date"],
        .modal-input-group input[type="time"],
        .modal-input-group input[type="number"],
        .modal-input-group select,
        .modal-input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--modal-input-border-color);
            border-radius: 4px;
            background-color: var(--modal-input-background-color);
            color: var(--input-text-color);
            font-size: 0.9rem;
            box-sizing: border-box;
            outline: none;
            font-family: 'Lexend', sans-serif;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-input-group textarea {
            resize: vertical;
            min-height: 50px;
        }
         .modal-input-group input:focus,
         .modal-input-group select:focus,
         .modal-input-group textarea:focus {
             border-color: var(--button-hover-color);
             box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
         }
         body.dark-mode .modal-input-group input:focus,
         body.dark-mode .modal-input-group select:focus,
         body.dark-mode .modal-input-group textarea:focus {
              box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.2);
         }


        #quick-schedule-calendar-modal .modal-content h2 {
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        #quick-schedule-calendar-modal p#quick-schedule-modal-intro {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        #quick-schedule-calendar-modal .modal-input-group {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        #quick-schedule-calendar-modal .modal-input-group label {
            font-size: 0.8rem;
            font-weight: normal;
        }
        #quick-schedule-calendar-modal .modal-input-group input[type="checkbox"] {
            margin-right: 5px;
            outline: none;
        }
         #quick-schedule-calendar-modal .modal-input-group input[type="checkbox"]:focus-visible {
            outline: 2px solid var(--focus-visible-outline-color);
            outline-offset: 1px;
         }
        #quick-schedule-calendar-modal #quick-gc-weekly-days-group div {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        #quick-schedule-calendar-modal #quick-gc-weekly-days-group div label {
            margin-right: 10px;
            font-size: 0.85rem;
        }
        #quick-schedule-calendar-modal #create-quick-google-calendar-event-button {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: var(--accent-color);
            color: #fff;
            font-weight: bold;
        }
        #quick-schedule-calendar-modal #create-quick-google-calendar-event-button:hover {
            background-color: var(--schedule-link-hover-text-color);
        }


        #reminder-modal .modal-content h2#reminder-modal-title { }
        #reminder-modal p#reminder-task-text {
            text-align: center;
            font-style: italic;
            margin: 0 auto 20px auto;
            word-break: break-word;
            color: var(--text-color);
            font-size: 0.85rem;
            font-weight: normal;
            max-width: 90%;
        }
        #reminder-modal .modal-input-group {
            margin: 15px auto;
            width: fit-content;
            max-width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            flex-direction: row;
            flex-wrap: wrap;
        }
        #reminder-modal .modal-input-group label {
            font-size: 0.85rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        #reminder-modal .modal-input-group input[type="date"],
        #reminder-modal .modal-input-group input[type="time"] {
             width: 130px;
             flex-grow: 1;
             min-width: 100px;
        }

        #schedule-reminder-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 25px auto 5px auto;
            padding: 10px;
            background: none !important;
            border: none !important;
            color: var(--schedule-link-text-color) !important;
            text-decoration: underline !important;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            transition: color 0.2s ease;
            box-shadow: none !important;
            outline: none;
        }
         #schedule-reminder-button:focus-visible {
             color: var(--schedule-link-hover-text-color) !important;
             outline: 2px solid var(--schedule-link-hover-text-color) !important;
             outline-offset: 2px;
         }
        #schedule-reminder-button:hover {
            color: var(--schedule-link-hover-text-color) !important;
            background: none !important;
        }
        #schedule-reminder-button:disabled {
            color: var(--schedule-link-disabled-text-color) !important;
            text-decoration: none !important;
            cursor: not-allowed;
            opacity: 0.7 !important;
        }
         #schedule-reminder-button:disabled:focus-visible {
             outline: none !important;
         }

        .modal-content ol {
            padding-left: 20px;
            margin-bottom: 0;
            text-align: left;
        }
        .modal-content ol li {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .modal-content ol li ul {
            padding-left: 20px;
            margin-top: 8px;
            list-style-type: disc;
        }
        .modal-content ol li ul li {
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .modal-content strong {
            color: var(--heading-color);
        }
        .modal-content i.fas, .modal-content i.far, .modal-content i.fab {
            color: var(--button-hover-color);
            margin: 0 2px;
            font-size: 0.9em;
        }

        div.modal-overlay div.modal-content > button.close-modal {
            position: absolute !important;
            top: 10px !important;
            right: 10px !important;
            left: auto !important;
            bottom: auto !important;
            transform: none !important;
            margin: 0 !important;
            font-size: 1.4rem;
            color: var(--button-color);
            padding: 2px 5px !important;
            line-height: 1;
            background: none !important;
            border: none !important;
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 10 !important;
            box-shadow: none !important;
        }
        div.modal-overlay div.modal-content > button.close-modal:hover {
            color: var(--button-hover-color) !important;
            background: none !important;
        }


        @media (max-width: 500px) {

            .modal-overlay {
                padding-top: 20px;
            }
            .modal-content {
                padding: 20px 25px;
                max-height: 90vh;
                max-width: 95%;
                width: 95%;
            }
            .modal-content h2 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            #quick-schedule-calendar-modal .modal-content h2,
            #reminder-modal .modal-content h2,
            #timer-duration-modal .modal-content h2 {
                 font-size: 1.1rem;
            }
            #reminder-modal p#reminder-task-text,
            #timer-duration-modal p#timer-duration-task-text {
                font-size: 0.85rem;
                margin-bottom: 15px;
            }
            #quick-schedule-calendar-modal .modal-input-group,
            #reminder-modal .modal-input-group,
            #timer-duration-modal .modal-input-group {
                margin-bottom: 10px;
                gap: 8px;
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
             .modal-input-group label {
                 width: 100%;
                 text-align: left;
             }
            .modal-input-group input[type="date"],
            .modal-input-group input[type="time"],
            #timer-duration-modal input[type="number"] {
                padding: 6px;
                font-size: 0.85rem;
                width: 100%;
            }
            #schedule-reminder-button,
            #timer-duration-modal #set-custom-timer-button {
                padding: 8px;
                font-size: 0.9rem;
                max-width: 100%;
            }
            #timer-quick-options-container {
                gap: 8px;
            }
            #timer-quick-options-container .timer-duration-option {
                font-size: 0.85rem;
                padding: 6px 10px;
                min-width: 70px;
            }


            .modal-content ol li {
                font-size: 0.9em;
                margin-bottom: 10px;
            }
            .modal-content ol li ul li {
                font-size: 0.9em;
                margin-bottom: 6px;
            }
            div.modal-overlay div.modal-content > button.close-modal {
                font-size: 1.2rem !important;
                top: 6px !important;
                right: 8px !important;
                padding: 2px 4px !important;
            }
        }

        /* Estilos para el Temporizador de Tareas */
        .task-timer-button {
            padding-left: 4px !important;
            padding-right: 4px !important;
            font-size: 1rem !important;
            margin-left: 0px;
        }

        .task-timer-countdown {
            font-size: 0.8em;
            font-weight: bold;
            color: var(--button-hover-color);
            display: inline-block;
            min-width: 45px;
            text-align: right;
            flex-shrink: 0;
            line-height: 1;
            padding: 3px 0;
        }

        .todo-item .subtasks-list li .task-timer-button {
            padding: 4px !important;
            font-size: 0.9rem !important;
            margin-left: 2px;
            margin-right: 2px;
        }
        .todo-item .subtasks-list li .task-timer-countdown {
            font-size: 0.9em;
            min-width: 40px;
            color: var(--button-hover-color);
            line-height: 1;
            padding: 2px 0;
        }

        .todo-item.completed .task-timer-button,
        .todo-item.completed .task-timer-countdown {
            display: none !important;
        }

        #timer-duration-modal .modal-content {
            max-width: 380px;
        }

        #timer-quick-options-container .timer-duration-option {
            padding: 8px 15px;
            font-size: 0.9rem;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            min-width: 80px;
        }
        #timer-quick-options-container .timer-duration-option:hover {
            background-color: var(--fixed-button-bg);
            border-color: var(--button-hover-color);
            color: var(--button-hover-color);
        }

        #timer-custom-duration-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
        }
        #timer-custom-duration-group label {
            font-size: 0.85rem;
        }
        #timer-custom-duration-group input[type="number"] {
            text-align: center;
        }

        #set-custom-timer-button {
             display: block;
             width: 100%;
             margin-top: 15px;
             background-color: var(--accent-color);
             color: #fff;
             padding: 10px;
        }
        #set-custom-timer-button:hover {
            background-color: var(--schedule-link-hover-text-color) !important;
            color: #fff !important;
        }
        #set-custom-timer-button:focus-visible {
             outline-color: var(--schedule-link-hover-text-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <button id="info-button" class="app-button" aria-label="Información de la aplicación" title="Cómo usar la aplicación">
            i
        </button>
        <h1 id="page-title" aria-label="ToDayList Logo">ToDayList</h1>
        <h2 class="subtitle">Tu Gestor de Tareas Diarias</h2>
        <p class="app-description-static">
            Organiza tu día y aumenta tu productividad de forma sencilla y eficaz.
        </p>

        <section id="welcome-section" class="hidden">
            <img src="https://www.todaylist.es/ToDayList.png" alt="ToDayList Icono" class="welcome-icon">
            <h2>¡Bienvenido a ToDayList!</h2>
            <p>
                ¿Te cuesta empezar? ToDayList convierte tus tareas en pequeñas victorias. Menos caos, más control… y el placer de avanzar sin esfuerzo. Adiós a la procrastinación, hola a la productividad.
            </p>
            <ul>
                <li><strong>Gestión Intuitiva de Tareas:</strong> Crea, edita y organiza tus tareas fácilmente. Verás cuántos días lleva pendiente una tarea.</li>
                <li><strong>Subtareas Detalladas:</strong> Desglosa tareas complejas en pasos manejables.</li>
                <li><strong>Prioridades Visuales:</strong> Asigna colores para enfocarte en lo importante.</li>
                <li><strong>Agendar Recordatorio de Tarea:</strong> El botón <i class="far fa-calendar-plus"></i> en cada tarea te permite enviar un recordatorio a tu Google Calendar.</li>
                <li><strong>Temporizador de Tareas:</strong> El botón <i class="fas fa-clock"></i> te permite asignar tiempo para ejecutar una tarea o subtarea. Elige entre opciones rápidas o una duración personalizada.</li>
                <li><strong>¡No Olvides lo Importante!:</strong> Usa la sección dedicada para crear eventos (únicos o recurrentes) directamente en tu Google Calendar.</li>
                <li><strong>Enlaces Relevantes:</strong> Asocia URLs directamente a tus tareas.</li>
                <li><strong>Modo Oscuro/Claro:</strong> Adapta la interfaz a tus preferencias visuales (oscuro por defecto).</li>
                <li><strong>Progreso y Motivación:</strong> Visualiza el avance y gana medallas por completar tareas.</li>
                <li><strong>Exportación e Importación de Datos:</strong> Realiza copias de seguridad o transfiere tus datos (local o Google Drive).</li>
                <li><strong>Anotaciones Rápidas:</strong> Un espacio para tomar notas sin crear una tarea formal.</li>
            </ul>
            <p>
                ¡Comienza a organizar tu día ahora!
            </p>
            <button id="start-app-button" class="app-button">Empezar a Organizar</button>
        </section>

        <section id="install-instructions-section" class="hidden">
            <h4>¡Acceso Rápido a ToDayList!</h4>
            <p>Guarda ToDayList en tu dispositivo para acceder como una app:</p>
            <ul>
                <li><strong>Chrome (Escritorio):</strong> Clic en el icono <i class="fas fa-download" title="Instalar"></i> en la barra de direcciones, o Menú (<i class="fas fa-ellipsis-v"></i>) &rarr; "Instalar ToDayList".</li>
                <li><strong>Android (Chrome):</strong> Menú (<i class="fas fa-ellipsis-v"></i>) &rarr; "Instalar aplicación" o "Añadir a pantalla de inicio".</li>
                <li><strong>iPhone/iPad (Safari):</strong> Icono Compartir (<i class="fas fa-share-square" title="Compartir"></i>) &rarr; "Añadir a pantalla de inicio".</li>
                <li><strong>Mac (Safari):</strong> Desde el menú "Archivo" &rarr; "Añadir al Dock".</li>
            </ul>
        </section>

        <div id="app-main-interface" class="hidden">
            <div id="medal-counter-container">
                <span class="daily-medals" title="Medallas ganadas hoy">
                    <i class="fas fa-medal"></i> <span id="medal-count">0</span>
                </span>
                <span class="total-score-counter" title="Total de tareas completadas históricamente">
                    <span id="total-score-label">Total Score:</span>
                    <span id="total-score-value">000</span>
                    <button id="reset-total-score-button" aria-label="Resetear Total Score" title="Resetear Total Score">
                        <i class="fas fa-undo-alt"></i>
                    </button>
                </span>
            </div>

            <ul id="todo-list"></ul>
            <div id="todo-input-container">
                <label for="new-todo-input" class="sr-only">Agregar nueva tarea</label>
                <input type="text" id="new-todo-input" placeholder="Agregar nueva tarea...">
                <button id="add-todo-button" class="app-button add-button" aria-label="Agregar Tarea"><i class="fas fa-plus"></i></button>
                <div id="reorder-buttons-group">
                    <button id="reorder-by-priority-button" class="app-button sort-button" aria-label="Reordenar por Prioridad y Antigüedad" title="Reordenar por Prioridad y Antigüedad"><i class="fas fa-sort-amount-down-alt"></i></button>
                    <button id="reorder-by-creation-button" class="app-button sort-button" aria-label="Reordenar por Antigüedad" title="Reordenar por Antigüedad (más antiguas primero)"><i class="fas fa-history"></i></button>
                </div>
            </div>
            <div id="priority-legend">
                Prioridad:
                <span class="priority-legend-item"><span class="priority-color-label" data-color="red"></span>Urgente</span>
                &gt;
                <span class="priority-legend-item"><span class="priority-color-label" data-color="orange"></span>Alta</span>
                &gt;
                <span class="priority-legend-item"><span class="priority-color-label" data-color="yellow"></span>No Olvidar</span>
                &gt;
                <span class="priority-legend-item"><span class="priority-color-label" data-color="green"></span>Puede Esperar</span>
            </div>

            <div id="quick-notes-container">
                <label for="quick-notes-area" class="sr-only">Anotaciones rápidas</label>
                <textarea id="quick-notes-area" placeholder="Anotaciones rápidas..."></textarea>
                <button id="clear-notes-button" class="app-button" aria-label="Borrar anotaciones">
                    <i class="fas fa-eraser"></i> Borrar
                </button>
            </div>

            <div id="quick-calendar-event-section">
                <h4>¡No Olvides Eso Tan Importante!</h4>
                <p>Crea eventos (recurrentes o de un solo día) en tu Google Calendar.</p>
                <button id="open-quick-schedule-modal-button" class="app-button" style="margin: 0 auto;">
                    <i class="fas fa-calendar-alt"></i> Crear Evento en Calendar
                </button>
            </div>


            <div id="data-management-section">
                <h4>Gestión de Datos</h4>
                <p class="data-management-intro">
                    Guarda tus tareas para usarlas en otros dispositivos o como copia de seguridad.
                    Puedes exportar/importar un archivo local o usar tu Google Drive.
                </p>
                <div id="export-options-container" class="data-options-row">
                    <button id="export-data-button" class="app-button data-action-button" aria-label="Exportar datos locales">
                        <i class="fas fa-file-export"></i> Exportar Local
                    </button>
                    <button id="export-drive-button" class="app-button data-action-button drive-button-style" aria-label="Exportar a Google Drive" disabled>
                        <i class="fab fa-google-drive"></i> Exportar a Drive
                    </button>
                </div>
                <div id="import-options-container" class="data-options-row">
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    <button id="import-data-button" class="app-button data-action-button" aria-label="Importar datos locales">
                        <i class="fas fa-file-import"></i> Importar Local
                    </button>
                    <button id="import-drive-button" class="app-button data-action-button drive-button-style" aria-label="Importar desde Google Drive" disabled>
                        <i class="fab fa-google-drive"></i> Importar de Drive
                    </button>
                </div>
            </div>

        </div>

    </div>

    <!-- Modal para Agendar Recordatorio (de una tarea existente) -->
    <div id="reminder-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="reminder-modal-title">
        <div class="modal-content">
            <button class="app-button close-modal" id="close-reminder-modal" aria-label="Cerrar ventana de recordatorio">×</button>
            <h2 id="reminder-modal-title">Agendar Recordatorio</h2>
            <p id="reminder-task-text"></p>
            <div class="modal-input-group">
                <label for="reminder-date">Fecha:</label>
                <input type="date" id="reminder-date" required>
            </div>
            <div class="modal-input-group">
                <label for="reminder-time">Hora:</label>
                <input type="time" id="reminder-time" value="09:00" required>
            </div>
            <button id="schedule-reminder-button" class="app-button">Mandar a Google Calendar</button>
        </div>
    </div>

    <!-- Modal para Programar Evento Rápido (único o recurrente) en Google Calendar -->
    <div id="quick-schedule-calendar-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="quick-schedule-calendar-modal-title">
        <div class="modal-content">
            <button class="app-button close-modal" id="close-quick-schedule-modal" aria-label="Cerrar">×</button>
            <h2 id="quick-schedule-calendar-modal-title">Programar Evento en Google Calendar</h2>
            <p id="quick-schedule-modal-intro">Define los detalles de tu nuevo evento.</p>

            <div class="modal-input-group">
                <label for="quick-gc-event-title">Título del Evento:</label>
                <input type="text" id="quick-gc-event-title" placeholder="Ej: Tomar pastillas, Reunión semanal..." required>
            </div>
            <div class="modal-input-group">
                <label for="quick-gc-start-date">Fecha de inicio:</label>
                <input type="date" id="quick-gc-start-date" required>
            </div>
            <div class="modal-input-group">
                <label for="quick-gc-time">Hora:</label>
                <input type="time" id="quick-gc-time" value="09:00" required>
            </div>
            <div class="modal-input-group">
                <label for="quick-gc-type">Repetir:</label>
                <select id="quick-gc-type">
                    <option value="NONE">No repetir (evento único)</option>
                    <option value="DAILY">Diariamente</option>
                    <option value="WEEKLY">Semanalmente</option>
                    <option value="MONTHLY">Mensualmente (mismo día del mes)</option>
                    <option value="YEARLY">Anualmente (misma fecha)</option>
                </select>
            </div>
            <div class="modal-input-group hidden" id="quick-gc-weekly-days-group">
                <label>Días (si es semanal):</label>
                <div id="quick-gc-weekly-checkboxes">
                    <input type="checkbox" id="quick-gc-day-su" value="SU" data-day-index="0"><label for="quick-gc-day-su">Do</label>
                    <input type="checkbox" id="quick-gc-day-mo" value="MO" data-day-index="1"><label for="quick-gc-day-mo">Lu</label>
                    <input type="checkbox" id="quick-gc-day-tu" value="TU" data-day-index="2"><label for="quick-gc-day-tu">Ma</label>
                    <input type="checkbox" id="quick-gc-day-we" value="WE" data-day-index="3"><label for="quick-gc-day-we">Mi</label>
                    <input type="checkbox" id="quick-gc-day-th" value="TH" data-day-index="4"><label for="quick-gc-day-th">Ju</label>
                    <input type="checkbox" id="quick-gc-day-fr" value="FR" data-day-index="5"><label for="quick-gc-day-fr">Vi</label>
                    <input type="checkbox" id="quick-gc-day-sa" value="SA" data-day-index="6"><label for="quick-gc-day-sa">Sá</label>
                </div>
            </div>
            <div class="modal-input-group">
                <label for="quick-gc-description">Descripción (opcional):</label>
                <textarea id="quick-gc-description" rows="2"></textarea>
            </div>

            <button id="create-quick-google-calendar-event-button" class="app-button">Crear Evento en Google Calendar</button>
        </div>
    </div>


    <div id="info-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
        <div class="modal-content">
            <button id="close-modal-button" class="app-button close-modal" aria-label="Cerrar ventana de información">×</button>
            <h2 id="info-modal-title">Cómo usar ToDayList</h2>
            <ol>
                <li><strong>Añadir Tareas:</strong> Escribe tu tarea en el campo inferior y pulsa el botón <i class="fas fa-plus"></i> o la tecla "Enter". Verás debajo del texto de la tarea cuántos días lleva pendiente.</li>
                <li><strong>Marcar como Completada:</strong> Haz clic en el círculo a la izquierda de la tarea. ¡Ganas una medalla <i class="fas fa-medal"></i> por cada tarea completada en el día! El contador "Total Score" aumenta con cada tarea completada históricamente.</li>
                <li><strong>Prioridad:</strong> Haz clic en el cuadrado de color junto al círculo para cambiar la prioridad de la tarea (Rojo: Urgente &gt; Naranja: Alta &gt; Amarillo: No Olvidar &gt; Verde: Puede Esperar &gt; Gris: Sin prioridad).</li>
                <li><strong>Agendar Recordatorio de Tarea:</strong> Haz clic en el icono de calendario <i class="far fa-calendar-plus"></i> en una tarea para enviar un recordatorio de esa tarea específica a tu Google Calendar.</li>
                <li><strong>Temporizador de Tarea/Subtarea:</strong> Haz clic en el icono de reloj <i class="fas fa-clock"></i> para iniciar un temporizador. Se abrirá una ventana para elegir una duración rápida (15, 30, 45, 60 min) o introducir un valor personalizado. Al finalizar, sonará una alarma y recibirás una notificación.</li>
                <li><strong>¡No Olvides lo Importante!:</strong> Usa la sección dedicada para crear eventos (únicos o recurrentes) directamente en tu Google Calendar.</li>
                <li><strong>Enlaces:</strong> Haz clic en el icono de enlace <i class="fas fa-link"></i> para añadir o abrir un enlace web asociado a la tarea.</li>
                <li><strong>Sub-Tareas:</strong>
                    <ul>
                        <li>Pulsa el botón <i class="fas fa-plus"></i> (pequeño, a la derecha de la tarea principal, debajo de la barra de progreso) para añadir sub-tareas.</li>
                        <li>Una vez añadida una sub-tarea, el campo de texto se ocultará. Pulsa el botón <i class="fas fa-plus"></i> de nuevo si deseas añadir más.</li>
                        <li>Las sub-tareas tienen su propio círculo para marcarlas como completadas, botones para moverlas <i class="fas fa-arrow-up"></i><i class="fas fa-arrow-down"></i>, un botón de temporizador <i class="fas fa-clock"></i>, o eliminarlas <i class="fas fa-trash-alt"></i>.</li>
                    </ul>
                </li>
                <li><strong>Barra de Progreso:</strong> Indica el porcentaje de sub-tareas completadas. Se llena al 100% cuando la tarea principal se marca como completada.</li>
                <li><strong>Reordenar Tareas:</strong>
                    <ul>
                        <li>Pulsa <i class="fas fa-sort-amount-down-alt"></i> para organizar por prioridad (de más a menos urgente) y luego por antigüedad (más antiguas primero).</li>
                        <li>Pulsa <i class="fas fa-history"></i> para organizar solo por antigüedad (más antiguas primero).</li>
                    </ul>
                </li>
                <li><strong>Modo Oscuro/Claro:</strong> Utiliza el botón <i class="fas fa-moon"></i> / <i class="fas fa-sun"></i> situado abajo a la derecha para cambiar el tema visual de la aplicación (oscuro por defecto).</li>
                <li><strong>Eliminar Tareas:</strong> Haz clic en el icono de papelera <i class="fas fa-trash-alt"></i> para eliminar tareas principales o sub-tareas.</li>
                <li><strong>Anotaciones Rápidas:</strong> Utiliza el área para notas temporales.</li>
                <li><strong>Exportar/Importar Datos:</strong> Usa los botones "Exportar Local" e "Importar Local" para guardar/restaurar datos desde un archivo en tu dispositivo. Usa "Exportar a Drive" e "Importar de Drive" para usar tu Google Drive. <strong>¡Atención!</strong> Importar reemplazará los datos actuales.</li>
            </ol>
        </div>
    </div>

    <!-- Modal para Selección de Duración del Temporizador -->
    <div id="timer-duration-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="timer-duration-modal-title">
        <div class="modal-content">
            <button class="app-button close-modal" id="close-timer-duration-modal" aria-label="Cerrar selección de duración">×</button>
            <h2 id="timer-duration-modal-title">Asignar Tiempo</h2>
            <p id="timer-duration-task-text" style="text-align: center; font-style: italic; margin-bottom: 20px;"></p>

            <div id="timer-quick-options-container" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button class="app-button timer-duration-option" data-minutes="15">15 min</button>
                <button class="app-button timer-duration-option" data-minutes="30">30 min</button>
                <button class="app-button timer-duration-option" data-minutes="45">45 min</button>
                <button class="app-button timer-duration-option" data-minutes="60">60 min</button>
            </div>

            <div class="modal-input-group" id="timer-custom-duration-group">
                <label for="timer-custom-minutes">Personalizado (minutos):</label>
                <input type="number" id="timer-custom-minutes" min="1" max="180" placeholder="Ej: 25">
            </div>
            <button id="set-custom-timer-button" class="app-button">
                Iniciar Temporizador Personalizado
            </button>
             <p style="text-align: center; font-size: 0.8em; color: var(--legend-text-color); margin-top:10px;">
                O selecciona una opción rápida arriba.
            </p>
        </div>
    </div>


    <footer>
        <img src="https://www.todaylist.es/ToDayList.png" alt="Logo ToDayList" class="footer-logo">
        <p class="footer-text">WebApp creada por Henry Gil</p>
        <p class="footer-version">Versión 2.1.1</p>

        <div id="support-section-footer">
            <p class="support-intro-text">¿Te gusta ToDayList? Si te ha sido útil...</p>
            <a href="https://paypal.me/todaylistHenry" target="_blank" rel="noopener noreferrer" class="paypal-link-footer">
                <i class="fab fa-paypal"></i> Apoya este proyecto
            </a>
        </div>
        <div class="footer-legal-links">
            <a href="privacy-policy.html" target="_blank" rel="noopener noreferrer">Política de Privacidad</a>
            <span>|</span>
            <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer">Condiciones del Servicio</a>
        </div>
    </footer>

    <button id="dark-mode-toggle" class="app-button" aria-label="Alternar modo oscuro/claro"><i class="fas fa-moon"></i></button>

    <audio id="alarm-sound" src="ding.mp3" preload="auto"></audio>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <script async defer src="https://apis.google.com/js/api.js" onload="if(window.googleApiCallbacks && typeof window.googleApiCallbacks.gapiLoaded === 'function') { window.isGoogleGapiScriptReady = true; window.googleApiCallbacks.gapiLoaded(); } else { console.error('googleApiCallbacks.gapiLoaded no definido'); }"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="if(window.googleApiCallbacks && typeof window.googleApiCallbacks.gisLoaded === 'function') { window.isGoogleGisScriptReady = true; window.googleApiCallbacks.gisLoaded(); } else { console.error('googleApiCallbacks.gisLoaded no definido'); }"></script>

    <script type="module">
        // --- IndexedDB Setup ---
        const DB_NAME = 'ToDayListDB';
        const DB_VERSION = 1; // Si cambias la estructura de la BD, incrementa esto
        const TASKS_STORE_NAME = 'tasks';
        const SETTINGS_STORE_NAME = 'settings';
        const DAILY_MEDALS_STORE_NAME = 'dailyMedals';
        const ACTIVE_TIMERS_STORE_NAME = 'activeTimers';
        const MIGRATION_FLAG_KEY = 'migrationV1toIndexedDBDone'; // Clave para la bandera de migración
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const dbInstance = event.target.result;
                    if (!dbInstance.objectStoreNames.contains(TASKS_STORE_NAME)) {
                        const taskStore = dbInstance.createObjectStore(TASKS_STORE_NAME, { keyPath: 'id' });
                        taskStore.createIndex('completed', 'completed', { unique: false });
                        taskStore.createIndex('priorityColor', 'priorityColor', { unique: false });
                        taskStore.createIndex('createdAt', 'createdAt', { unique: false });
                        taskStore.createIndex('order', 'order', { unique: false });
                    }
                    if (!dbInstance.objectStoreNames.contains(SETTINGS_STORE_NAME)) {
                        dbInstance.createObjectStore(SETTINGS_STORE_NAME, { keyPath: 'key' });
                    }
                    if (!dbInstance.objectStoreNames.contains(DAILY_MEDALS_STORE_NAME)) {
                        dbInstance.createObjectStore(DAILY_MEDALS_STORE_NAME, { keyPath: 'date' });
                    }
                    if (!dbInstance.objectStoreNames.contains(ACTIVE_TIMERS_STORE_NAME)) {
                        dbInstance.createObjectStore(ACTIVE_TIMERS_STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        function dbOperation(storeName, mode, operation) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error("DB not initialized for operation");
                    return reject("DB not initialized");
                }
                const transaction = db.transaction(storeName, mode);
                const store = transaction.objectStore(storeName);
                operation(store, resolve, reject);
                transaction.oncomplete = () => {
                    // Resolve se llama dentro de la operación si es exitosa
                };
                transaction.onerror = (event) => {
                    console.error(`Transaction error on ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function dbPut(storeName, data) {
            return dbOperation(storeName, 'readwrite', (store, resolve, reject) => {
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function dbGet(storeName, key) {
            return dbOperation(storeName, 'readonly', (store, resolve, reject) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function dbGetAll(storeName) {
            return dbOperation(storeName, 'readonly', (store, resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function dbDelete(storeName, key) {
            return dbOperation(storeName, 'readwrite', (store, resolve, reject) => {
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function dbClear(storeName) {
            return dbOperation(storeName, 'readwrite', (store, resolve, reject) => {
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        // --- End IndexedDB Setup ---

        // --- Migration Logic ---
        async function performMigrationFromLocalStorage() {
            console.log("Iniciando migración desde localStorage a IndexedDB...");
            try {
                // 1. Migrar Tareas
                const storedTodos = localStorage.getItem('todoListAppTasks');
                if (storedTodos) {
                    const oldTodos = JSON.parse(storedTodos);
                    if (Array.isArray(oldTodos)) {
                        let taskPromises = [];
                        const migratedTodos = oldTodos.map((t, index) => {
                            const newTask = {
                                id: t.id || generateLocalId(),
                                text: t.text || '?',
                                completed: !!t.completed,
                                completedDate: t.completedDate || null,
                                createdAt: t.createdAt || new Date().toISOString(),
                                subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(s => ({ id: s.id || generateLocalId(), text: s.text || '?', completed: !!s.completed })) : [],
                                showSubtaskUI: !!t.showSubtaskUI,
                                priorityColor: PRIORITY_COLORS.includes(t.priorityColor) ? t.priorityColor : 'none',
                                date: (typeof t.date === 'string' && t.date.match(/^\d{4}-\d{2}-\d{2}$/)) ? t.date : null,
                                linkUrl: typeof t.linkUrl === 'string' ? t.linkUrl : null,
                                order: typeof t.order === 'number' ? t.order : (t.createdAt ? new Date(t.createdAt).getTime() : index)
                            };
                            taskPromises.push(dbPut(TASKS_STORE_NAME, newTask));
                            return newTask;
                        });
                        await Promise.all(taskPromises);
                        console.log(`${migratedTodos.length} tareas migradas.`);
                        // localStorage.removeItem('todoListAppTasks'); // Descomentar para limpiar localStorage
                    }
                }

                // 2. Migrar Tema
                const storedTheme = localStorage.getItem('todoListTheme');
                if (storedTheme) {
                    await dbPut(SETTINGS_STORE_NAME, { key: 'theme', value: storedTheme });
                    console.log(`Tema '${storedTheme}' migrado.`);
                    // localStorage.removeItem('todoListTheme');
                }

                // 3. Migrar Medallas Diarias
                const storedMedalData = localStorage.getItem('todoListDailyMedalData');
                if (storedMedalData) {
                    try {
                        const medalData = JSON.parse(storedMedalData);
                        if (medalData && typeof medalData.date === 'string' && typeof medalData.count === 'number') {
                            await dbPut(DAILY_MEDALS_STORE_NAME, medalData);
                            console.log(`Datos de medallas para '${medalData.date}' migrados.`);
                        }
                    } catch (e) { console.error("Error migrando datos de medallas:", e); }
                    // localStorage.removeItem('todoListDailyMedalData');
                }

                // 4. Migrar Total de Medallas
                const storedTotalMedals = localStorage.getItem('todoListTotalMedals');
                if (storedTotalMedals) {
                    const total = parseInt(storedTotalMedals, 10);
                    if (!isNaN(total)) {
                        await dbPut(SETTINGS_STORE_NAME, { key: 'totalMedals', value: total });
                        console.log(`Total de medallas '${total}' migrado.`);
                    }
                    // localStorage.removeItem('todoListTotalMedals');
                }

                // 5. Migrar Notas Rápidas
                const storedQuickNotes = localStorage.getItem('todoListQuickNotes');
                if (storedQuickNotes) {
                    await dbPut(SETTINGS_STORE_NAME, { key: 'quickNotes', value: storedQuickNotes });
                    console.log("Notas rápidas migradas.");
                    // localStorage.removeItem('todoListQuickNotes');
                }

                // 6. Migrar Temporizadores Activos
                const storedActiveTimers = localStorage.getItem('todoListActiveTimers');
                if (storedActiveTimers) {
                    try {
                        const activeTimers = JSON.parse(storedActiveTimers);
                        if (typeof activeTimers === 'object' && activeTimers !== null) {
                            let timerPromises = [];
                            for (const id in activeTimers) {
                                if (Object.hasOwnProperty.call(activeTimers, id)) {
                                    const timerData = { ...activeTimers[id], id: id }; // Asegurar que 'id' está en el objeto
                                    timerPromises.push(dbPut(ACTIVE_TIMERS_STORE_NAME, timerData));
                                }
                            }
                            await Promise.all(timerPromises);
                            console.log(`${Object.keys(activeTimers).length} temporizadores activos migrados.`);
                        }
                    } catch (e) { console.error("Error migrando temporizadores activos:", e); }
                    // localStorage.removeItem('todoListActiveTimers');
                }

                // 7. Marcar la migración como completada
                await dbPut(SETTINGS_STORE_NAME, { key: MIGRATION_FLAG_KEY, value: true });
                console.log("Migración completada y bandera establecida.");

            } catch (error) {
                console.error("Error durante la migración de localStorage a IndexedDB:", error);
            }
        }
        // --- End Migration Logic ---


        let todoInput;
        let addTodoButton;
        let todoListContainer;
        let reorderByPriorityButton; // Renombrado
        let reorderByCreationButton; // Nuevo
        let darkModeToggle;
        let body;
        let medalCountDisplay;
        let totalScoreValueDisplay;
        let resetTotalScoreButton;
        let infoButton, infoModal, closeModalButton;

        let reminderModal;
        let closeReminderModalButton;
        let reminderTaskTextElement;
        let reminderDateInput;
        let reminderTimeInput;
        let scheduleReminderButton;
        let currentTaskIdForReminder = null;

        let quickScheduleCalendarModal;
        let openQuickScheduleModalButton;
        let closeQuickScheduleModalButton;
        let quickGcEventTitleInput;
        let quickGcStartDateInput;
        let quickGcTimeInput;
        let quickGcTypeSelect;
        let quickGcWeeklyDaysGroup;
        let quickGcWeeklyCheckboxesContainer;
        let quickGcDescriptionTextarea;
        let createQuickGoogleCalendarEventButton;


        let quickNotesArea;
        let clearNotesButton;

        let exportDataButton;
        let importDataButton;
        let importFileInput;

        let exportDriveButton;
        let importDriveButton;

        const CLIENT_ID = '25607067695-mgv7jfvio4vr1goi5ci6o952mgpii8nf.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAhr2kqUcRf5qZi0yMHsFDsyp_x8Ekfj7k'; // Reemplaza con tu API Key real

        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        let welcomeSection;
        let startAppButton;
        let appMainInterface;
        let installInstructionsSection;

        let todos = [];
        let totalMedalsEarned = 0;

        const PRIORITY_COLORS = ['none', 'red', 'orange', 'yellow', 'green'];
        const PRIORITY_ORDER = { 'red': 1, 'orange': 2, 'yellow': 3, 'green': 4, 'none': 5 };

        let globalTimerInterval = null;
        let alarmAudio;

        let timerDurationModal;
        let closeTimerDurationModalButton;
        let timerDurationTaskTextElement;
        let timerQuickOptionsContainer;
        let timerCustomMinutesInput;
        let setCustomTimerButton;
        let currentTimerCallback = null;


        window.googleApiCallbacks = {
            gisLoaded: function() {
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) { if (window.isGoogleGisScriptReady && !gisInited) setTimeout(window.googleApiCallbacks.gisLoaded, 100); return; }
                if (gisInited) return;
                try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', }); gisInited = true; maybeEnableDriveButtons(); } catch (e) { console.error("Error GIS init:", e); }
            },
            gapiLoaded: function() {
                if (typeof gapi === 'undefined' || !gapi.load) { if (window.isGoogleGapiScriptReady && !gapiInited) setTimeout(window.googleApiCallbacks.gapiLoaded, 100); return; }
                if (gapiInited) return;
                try { gapi.load('client:picker', () => { gapiInited = true; maybeEnableDriveButtons(); }); } catch (e) { console.error("Error GAPI init:", e); }
            }
        };

        function maybeEnableDriveButtons() {
            if (gapiInited && gisInited) { if (exportDriveButton) exportDriveButton.disabled = false; if (importDriveButton) importDriveButton.disabled = false; }
            else { if (exportDriveButton) exportDriveButton.disabled = true; if (importDriveButton) importDriveButton.disabled = true; }
        }

        function handleAuthClick(callbackFn, ...args) {
            if (!gisInited || !tokenClient) { alert("Servicios de Google no listos."); return; }
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { if (resp.error !== 'popup_closed_by_user' && resp.error !== 'access_denied') alert("Error auth Google: " + (resp.error_description || resp.error)); return; }
                if (gapi && gapi.client) gapi.client.setToken(resp); else { alert("Error: Cliente API Google no listo."); return; }
                if (callbackFn) await callbackFn(...args).catch(e => console.error("Error callback post-auth:", e));
            };
            if (gapi && gapi.client && gapi.client.getToken && gapi.client.getToken() !== null) tokenClient.requestAccessToken({prompt: ''}); else tokenClient.requestAccessToken({prompt: 'consent'});
        }

        async function ensureDriveClientLoaded() {
            if (gapi && gapi.client && gapi.client.drive) return Promise.resolve();
            return new Promise((resolve, reject) => {
                if (!gapi || !gapi.client || !gapi.client.load) return reject(new Error("gapi.client.load no disponible."));
                try { gapi.client.load('drive', 'v3', resolve); } catch (e) { reject(e); }
            });
        }

        async function exportToGoogleDrive() {
            if (!gisInited || !gapiInited || !gapi.client.getToken || !gapi.client.getToken()) { handleAuthClick(exportToGoogleDrive); return; }
            try {
                await ensureDriveClientLoaded();
                const themeSetting = await dbGet(SETTINGS_STORE_NAME, 'theme');
                const dailyMedalDataArray = await dbGetAll(DAILY_MEDALS_STORE_NAME);
                const totalMedalsSetting = await dbGet(SETTINGS_STORE_NAME, 'totalMedals');
                const quickNotesSetting = await dbGet(SETTINGS_STORE_NAME, 'quickNotes');
                const tasksFromDB = await dbGetAll(TASKS_STORE_NAME);
                const activeTimersFromDB = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);

                const dataToExport = { 
                    theme: themeSetting ? themeSetting.value : 'dark', 
                    dailyMedalData: dailyMedalDataArray || [], 
                    totalMedals: totalMedalsSetting ? totalMedalsSetting.value : 0, 
                    quickNotesContent: quickNotesSetting ? quickNotesSetting.value : '', 
                    tasks: tasksFromDB || [],
                    activeTimers: activeTimersFromDB || []
                };

                const jsonString = JSON.stringify(dataToExport, null, 2); const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,''); const fileName = `todaylist_backup_${dateStr}.json`;
                const boundary = '-------314159265358979323846'; const delimiter = `\r\n--${boundary}\r\n`; const close_delim = `\r\n--${boundary}--`;
                const metadata = { 'name': fileName, 'mimeType': 'application/json; charset=UTF-8' };
                const multipartRequestBody = `${delimiter}Content-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}${delimiter}Content-Type: application/json; charset=UTF-8\r\n\r\n${jsonString}${close_delim}`;
                const request = gapi.client.request({'path': '/upload/drive/v3/files', 'method': 'POST', 'params': {'uploadType': 'multipart'}, 'headers': {'Content-Type': `multipart/related; boundary="${boundary}"`}, 'body': multipartRequestBody });
                const response = await request;
                if (response && response.result && response.result.id) alert(`¡Datos exportados a Drive como ${fileName}!`); else { console.error('Error exportando a Drive:', response); alert('Error al exportar a Drive.');}
            } catch (error) { console.error('Error exportando a Drive:', error); alert('Error al exportar a Drive: ' + (error.message || "Desconocido.")); }
        }

        function loadPicker(callbackFn) {
            if (typeof google !== 'undefined' && google.picker) { if (callbackFn) callbackFn(); } else { alert("Error: API de selección de Google no lista."); }
        }

        function importFromGoogleDrive() {
            if (!gisInited || !gapiInited || !gapi.client.getToken || !gapi.client.getToken()) { handleAuthClick(importFromGoogleDrive); return; }
            loadPicker(() => {
                try {
                    const oauthToken = gapi.client.getToken().access_token; if (!oauthToken) { handleAuthClick(importFromGoogleDrive); return; }
                    const view = new google.picker.View(google.picker.ViewId.DOCS); view.setMimeTypes("application/json");
                    const picker = new google.picker.PickerBuilder().setOAuthToken(oauthToken).addView(view).setDeveloperKey(API_KEY).setCallback(pickerCallback).build();
                    picker.setVisible(true);
                } catch (e) { console.error("Error construyendo Picker:", e); alert("Error al abrir selector de Drive: " + e.message); }
            });
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED && data.docs && data.docs.length > 0) {
                const fileId = data.docs[0].id; const fileName = data.docs[0].name;
                try {
                    await ensureDriveClientLoaded();
                    const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                    if (typeof response.body !== 'string') { alert("Error: Formato de archivo de Drive incorrecto."); return; }
                    const importedData = JSON.parse(response.body);
                    if (!confirm(`¡Atención! Importar "${fileName}" de Drive reemplazará datos. ¿Continuar?`)) return;
                    await applyImportedData(importedData, `Google Drive (${fileName})`);
                } catch (error) { console.error('Error importando de Drive:', error); alert('Error al importar de Drive: ' + (error.message || "Desconocido."));}
            } else if (data.action === google.picker.Action.CANCEL) console.log("Selección cancelada."); else if (data.action === google.picker.Action.ERROR ) { console.error("Error Picker:", data); alert("Error con selector de Drive."); }
        }

        function getTodayDateString(format = 'yyyy-mm-dd') {
            const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0');
            return format === 'dd-mm-yyyy' ? `${dd}-${mm}-${yyyy}` : `${yyyy}-${mm}-${dd}`;
        }

        function showReminderModal(taskId) {
            const task = findTaskById(taskId); if (!task || task.completed) return; currentTaskIdForReminder = taskId;
            if(reminderTaskTextElement) reminderTaskTextElement.textContent = `Tarea: "${task.text}"`; if(reminderDateInput) reminderDateInput.value = getTodayDateString(); if(reminderTimeInput) reminderTimeInput.value = "09:00";
            if(reminderModal) { reminderModal.classList.add('visible'); reminderModal.setAttribute('role', 'dialog'); reminderModal.setAttribute('aria-modal', 'true'); }
            if(reminderDateInput) requestAnimationFrame(() => reminderDateInput.focus());
        }
        function hideReminderModal() {
            if(reminderModal) { reminderModal.classList.remove('visible'); reminderModal.removeAttribute('role'); reminderModal.removeAttribute('aria-modal'); }
            const lastFocusedBtn = document.querySelector(`.todo-item[data-task-id="${currentTaskIdForReminder}"] .google-calendar-button`); currentTaskIdForReminder = null;
            if(reminderTaskTextElement) reminderTaskTextElement.textContent = ''; if (lastFocusedBtn) lastFocusedBtn.focus();
        }
        function handleScheduleReminderClick(event) {
            if (event) event.stopPropagation(); if (!currentTaskIdForReminder) return;
            const dateStr = reminderDateInput.value, timeStr = reminderTimeInput.value; if (!dateStr || !timeStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr) || !/^\d{2}:\d{2}$/.test(timeStr)) { alert("Fecha/hora inválida."); return; }
            const task = findTaskById(currentTaskIdForReminder); if (!task) { alert("Tarea no encontrada."); hideReminderModal(); return; }
            const localStart = new Date(`${dateStr}T${timeStr}`); if (isNaN(localStart.getTime())) { alert("Fecha/hora inválida."); hideReminderModal(); return; }
            const localEnd = new Date(localStart.getTime() + 3600000); const pad = (n) => String(n).padStart(2,'0'); const fmtDt = (d) => `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
            const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Recordatorio: '+task.text)}&dates=${fmtDt(localStart)}/${fmtDt(localEnd)}&details=${encodeURIComponent('Recordatorio para: "'+task.text+'"')}&sprop=name:ToDayList&sprop=website:${encodeURIComponent(window.location.href)}`;
            window.open(url, '_blank'); const itemEl = todoListContainer.querySelector(`li[data-task-id="${task.id}"] .google-calendar-button i`); if(itemEl) { itemEl.style.color = 'var(--accent-color)'; itemEl.parentElement.title = 'Recordatorio enviado.'; }
            hideReminderModal();
        }
        function showQuickScheduleCalendarModal() {
            if(quickGcEventTitleInput) quickGcEventTitleInput.value = ""; if(quickGcStartDateInput) quickGcStartDateInput.value = getTodayDateString(); if(quickGcTimeInput) quickGcTimeInput.value = "09:00"; if(quickGcTypeSelect) quickGcTypeSelect.value = "NONE"; if(quickGcDescriptionTextarea) quickGcDescriptionTextarea.value = ""; if(quickGcWeeklyDaysGroup) quickGcWeeklyDaysGroup.classList.add('hidden'); if(quickGcWeeklyCheckboxesContainer) quickGcWeeklyCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false);
            if(quickScheduleCalendarModal) { quickScheduleCalendarModal.classList.add('visible'); quickScheduleCalendarModal.setAttribute('role', 'dialog'); quickScheduleCalendarModal.setAttribute('aria-modal', 'true'); }
            if(quickGcEventTitleInput) requestAnimationFrame(() => quickGcEventTitleInput.focus());
        }
        function hideQuickScheduleCalendarModal() {
            if(quickScheduleCalendarModal) { quickScheduleCalendarModal.classList.remove('visible'); quickScheduleCalendarModal.removeAttribute('role'); quickScheduleCalendarModal.removeAttribute('aria-modal'); }
            if(openQuickScheduleModalButton) openQuickScheduleModalButton.focus();
        }
        function handleCreateQuickCalendarEvent() {
            const title = quickGcEventTitleInput.value.trim(); if (!title) { alert("Título requerido."); quickGcEventTitleInput.focus(); return; }
            const dateStr = quickGcStartDateInput.value, timeStr = quickGcTimeInput.value, recur = quickGcTypeSelect.value, desc = quickGcDescriptionTextarea.value.trim(); if (!dateStr || !timeStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr) || !/^\d{2}:\d{2}$/.test(timeStr)) { alert("Fecha/hora inválida."); return;}
            const localStart = new Date(`${dateStr}T${timeStr}`); if (isNaN(localStart.getTime())) { alert("Fecha/hora inválida."); return; }
            const localEnd = new Date(localStart.getTime() + 3600000); const pad = (n) => String(n).padStart(2,'0'); const fmtDt = (d) => `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
            let rrule = ""; if (recur !== "NONE") { rrule = `RRULE:FREQ=${recur}`; if (recur === "WEEKLY") { const days = Array.from(quickGcWeeklyCheckboxesContainer.querySelectorAll('input:checked')).map(cb => cb.value); if (days.length > 0) rrule += `;BYDAY=${days.join(',')}`; else { alert("Selecciona días para recurrencia semanal."); return; }}}
            let url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${fmtDt(localStart)}/${fmtDt(localEnd)}`;
            if(desc) url += `&details=${encodeURIComponent(desc)}`; if(rrule) url += `&recur=${encodeURIComponent(rrule)}`; url += `&sprop=name:${encodeURIComponent(document.title)}&sprop=website:${encodeURIComponent(window.location.href)}`;
            window.open(url, '_blank'); hideQuickScheduleCalendarModal();
        }

        function requestNotificationPermission() { if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') Notification.requestPermission().then(p => console.log(`Permiso Notif: ${p}`)); }
        function playAlarmSound() { if (alarmAudio) alarmAudio.play().catch(e => console.warn("Alarma:", e));}
        function showBrowserNotification(title, bodyText) { if ('Notification' in window && Notification.permission === 'granted') new Notification(title, { body: bodyText, icon: '/favicon-96x96.png', tag: `tdl-${Date.now()}` }); }
        function vibrateDevice() { if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]); }

        function updateTimerUI(id, isSubtask, parentTaskIdIfSubtask, timeLeft, finished = false) {
            let itemEl; if (isSubtask && parentTaskIdIfSubtask) { const pEl = todoListContainer.querySelector(`li[data-task-id="${parentTaskIdIfSubtask}"]`); if(pEl) itemEl = pEl.querySelector(`.subtasks-list li[data-subtask-id="${id}"]`); } else itemEl = todoListContainer.querySelector(`li[data-task-id="${id}"]`);
            if (!itemEl || itemEl.classList.contains('completed')) return; let countEl = itemEl.querySelector('.task-timer-countdown'), timerBtn = itemEl.querySelector('.task-timer-button'); if (!timerBtn) return;
            if ((timeLeft !== null || finished) && !countEl) { countEl = document.createElement('span'); countEl.classList.add('task-timer-countdown'); if (isSubtask) { const firstBtn = itemEl.querySelector('.app-button'); if(firstBtn) itemEl.insertBefore(countEl, firstBtn); else itemEl.appendChild(countEl);} else { const actGrp = itemEl.querySelector('.main-task-header .task-body .task-actions-group'); if(actGrp) actGrp.parentNode.insertBefore(countEl, actGrp); else itemEl.querySelector('.main-task-header .task-body').appendChild(countEl);}}
            if (finished) { if (countEl) { countEl.textContent = ' Finalizado!'; countEl.style.color = 'var(--progress-bar-completed-color)'; } timerBtn.innerHTML = '<i class="fas fa-clock"></i>'; timerBtn.title = 'Iniciar'; setTimeout(() => { if (countEl && countEl.parentNode && countEl.textContent.includes('Finalizado!')) countEl.parentNode.removeChild(countEl); }, 7000);
            } else if (timeLeft !== null && timeLeft > 0) { const m = Math.floor((timeLeft/60000)%60), s = Math.floor((timeLeft/1000)%60); if(countEl){ countEl.textContent = ` ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; countEl.style.color = 'var(--button-hover-color)';} timerBtn.innerHTML = '<i class="fas fa-stopwatch"></i>'; timerBtn.title = 'Cancelar';
            } else { if (countEl && countEl.parentNode) countEl.parentNode.removeChild(countEl); timerBtn.innerHTML = '<i class="fas fa-clock"></i>'; timerBtn.title = 'Iniciar'; }
            if(timerBtn) timerBtn.disabled = false;
        }

        async function checkActiveTimers() {
            let timersArray = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);
            let timers = {};
            timersArray.forEach(t => timers[t.id] = t);

            let running = false; const now = Date.now();
            let operations = [];

            for (const id in timers) { 
                const t = timers[id], left = t.endTime - now; 
                const el = t.isSubtask && t.parentTaskIdIfSubtask ? document.querySelector(`.todo-item[data-task-id="${t.parentTaskIdIfSubtask}"] .subtasks-list li[data-subtask-id="${id}"]`) : document.querySelector(`.todo-item[data-task-id="${id}"]`);
                
                if (!el || el.classList.contains('completed')) { 
                    operations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, id));
                    updateTimerUI(id, t.isSubtask, t.parentTaskIdIfSubtask, null); 
                    continue; 
                }
                if (left <= 0) { 
                    playAlarmSound(); 
                    showBrowserNotification(`¡Tiempo finalizado!`, `Tarea "${t.text}" terminada.`); 
                    vibrateDevice(); 
                    operations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, id));
                    updateTimerUI(id, t.isSubtask, t.parentTaskIdIfSubtask, 0, true); 
                } else { 
                    running = true; 
                    updateTimerUI(id, t.isSubtask, t.parentTaskIdIfSubtask, left); 
                }
            }
            await Promise.all(operations);
            if (!running && globalTimerInterval) { clearInterval(globalTimerInterval); globalTimerInterval = null; }
        }

        function startGlobalTimerInterval() { if (!globalTimerInterval) { globalTimerInterval = setInterval(checkActiveTimers, 1000); checkActiveTimers(); }}

        function showTimerDurationModal(taskText, callback) {
            currentTimerCallback = callback;
            if (timerDurationTaskTextElement) timerDurationTaskTextElement.textContent = `Tarea: "${taskText}"`;
            if (timerCustomMinutesInput) timerCustomMinutesInput.value = '';
            if (timerDurationModal) {
                timerDurationModal.classList.add('visible');
                timerDurationModal.setAttribute('role', 'dialog');
                timerDurationModal.setAttribute('aria-modal', 'true');
                const firstOptBtn = timerDurationModal.querySelector('.timer-duration-option');
                if (firstOptBtn) requestAnimationFrame(() => firstOptBtn.focus());
                else if (timerCustomMinutesInput) requestAnimationFrame(() => timerCustomMinutesInput.focus());
            }
        }

        function hideTimerDurationModal() {
            if (timerDurationModal) {
                timerDurationModal.classList.remove('visible');
                timerDurationModal.removeAttribute('role');
                timerDurationModal.removeAttribute('aria-modal');
            }
            currentTimerCallback = null;
        }

        async function handleTimerButtonClick(event, id, taskText, isSubtask = false, parentTaskIdIfSubtask = null) {
            if(event) event.currentTarget.setAttribute('data-last-opened-timer', 'true'); 

            let activeTimer = await dbGet(ACTIVE_TIMERS_STORE_NAME, id);
            const taskEl = isSubtask && parentTaskIdIfSubtask ? document.querySelector(`.todo-item[data-task-id="${parentTaskIdIfSubtask}"] .subtasks-list li[data-subtask-id="${id}"]`) : document.querySelector(`.todo-item[data-task-id="${id}"]`);
            if (taskEl && taskEl.classList.contains('completed')) { alert("No se puede iniciar timer para tarea completada."); return; }

            if (activeTimer) {
                if (confirm(`¿Cancelar temporizador para "${activeTimer.text}"?`)) {
                    await dbDelete(ACTIVE_TIMERS_STORE_NAME, id);
                    updateTimerUI(id, isSubtask, parentTaskIdIfSubtask, null);
                    const allTimers = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);
                    if (allTimers.length === 0 && globalTimerInterval) { clearInterval(globalTimerInterval); globalTimerInterval = null; }
                }
            } else {
                showTimerDurationModal(taskText, async (durationMinutes) => {
                    const newTimer = { id: id, endTime: Date.now() + durationMinutes * 60000, duration: durationMinutes, text: taskText, isSubtask: isSubtask, parentTaskIdIfSubtask: parentTaskIdIfSubtask };
                    await dbPut(ACTIVE_TIMERS_STORE_NAME, newTimer);
                    startGlobalTimerInterval();
                });
            }
        }

        async function initializeActiveTimersFromStorage() {
            let timersArray = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);
            let needsInterval = false; const now = Date.now();
            let operations = [];

            for (const t of timersArray) {
                const el = t.isSubtask && t.parentTaskIdIfSubtask ? document.querySelector(`.todo-item[data-task-id="${t.parentTaskIdIfSubtask}"] .subtasks-list li[data-subtask-id="${t.id}"]`) : document.querySelector(`.todo-item[data-task-id="${t.id}"]`);
                if (!el || el.classList.contains('completed')) { 
                    operations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, t.id));
                    updateTimerUI(t.id, t.isSubtask, t.parentTaskIdIfSubtask, null); 
                    continue; 
                }
                if (t.endTime > now) needsInterval = true; 
                else { 
                    operations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, t.id));
                    updateTimerUI(t.id, t.isSubtask, t.parentTaskIdIfSubtask, null); 
                }
            }
            await Promise.all(operations);

            if (needsInterval) startGlobalTimerInterval(); 
            else if (globalTimerInterval) { clearInterval(globalTimerInterval); globalTimerInterval = null; }
            
            if (todoListContainer) { 
                const currentTimers = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);
                const currentTimersMap = currentTimers.reduce((acc, t) => { acc[t.id] = t; return acc; }, {});

                todoListContainer.querySelectorAll('.todo-item:not(.completed)').forEach(taskItem => {
                    const mainId = taskItem.dataset.taskId; 
                    if (currentTimersMap[mainId]) updateTimerUI(mainId, false, null, currentTimersMap[mainId].endTime - now); 
                    else updateTimerUI(mainId, false, null, null);
                    
                    taskItem.querySelectorAll('.subtasks-list li').forEach(subItem => { 
                        const subId = subItem.dataset.subtaskId; 
                        if (currentTimersMap[subId]) updateTimerUI(subId, true, mainId, currentTimersMap[subId].endTime - now); 
                        else updateTimerUI(subId, true, mainId, null); 
                    });
                });
            }
        }


        function generateLocalId() { return '_' + Math.random().toString(36).substring(2, 15); }
        function findTaskById(id) { return todos.find(t => t.id === id); }
        function findTaskIndexById(id) { return todos.findIndex(t => t.id === id); }
        function displayMedalCount(c) { if (medalCountDisplay) medalCountDisplay.textContent = c; }
        function displayTotalScore(c) { if (totalScoreValueDisplay) totalScoreValueDisplay.textContent = String(c).padStart(3, '0'); }

        function calculateDaysAgo(isoDateString) {
            if (!isoDateString) return '';
            const taskDate = new Date(isoDateString);
            const today = new Date();
            const taskDayStart = new Date(taskDate.getFullYear(), taskDate.getMonth(), taskDate.getDate());
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const diffTime = todayStart.getTime() - taskDayStart.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return ''; 
            if (diffDays === 0) return 'Hoy';
            else if (diffDays === 1) return 'Ayer';
            else return `Hace ${diffDays} días`;
        }

        async function loadInitialDataFromDB() {
            const migrationFlag = await dbGet(SETTINGS_STORE_NAME, MIGRATION_FLAG_KEY);
            if (!migrationFlag || !migrationFlag.value) {
                await performMigrationFromLocalStorage();
            }

            const tasksFromDB = await dbGetAll(TASKS_STORE_NAME);
            if (tasksFromDB) {
                todos = tasksFromDB.map(t => ({
                    id: t.id || generateLocalId(),
                    text: t.text || '?',
                    completed: !!t.completed,
                    completedDate: t.completedDate || null,
                    createdAt: t.createdAt || new Date().toISOString(),
                    subtasks: Array.isArray(t.subtasks) ? t.subtasks.map(s => ({ id: s.id || generateLocalId(), text: s.text || '?', completed: !!s.completed })) : [],
                    showSubtaskUI: !!t.showSubtaskUI,
                    priorityColor: PRIORITY_COLORS.includes(t.priorityColor) ? t.priorityColor : 'none',
                    date: (typeof t.date === 'string' && t.date.match(/^\d{4}-\d{2}-\d{2}$/)) ? t.date : null,
                    linkUrl: typeof t.linkUrl === 'string' ? t.linkUrl : null,
                    order: typeof t.order === 'number' ? t.order : (t.createdAt ? new Date(t.createdAt).getTime() : 0)
                })).sort((a,b) => (a.order || 0) - (b.order || 0));
            } else {
                todos = [];
            }

            const themeSetting = await dbGet(SETTINGS_STORE_NAME, 'theme');
            if (themeSetting && themeSetting.value === 'light') {
                await disableDarkMode(); 
            } else {
                await enableDarkMode(); 
            }
            
            const totalMedalsSetting = await dbGet(SETTINGS_STORE_NAME, 'totalMedals');
            totalMedalsEarned = totalMedalsSetting ? (totalMedalsSetting.value || 0) : 0;
            displayTotalScore(totalMedalsEarned);

            const quickNotesSetting = await dbGet(SETTINGS_STORE_NAME, 'quickNotes');
            if (quickNotesArea) quickNotesArea.value = quickNotesSetting ? (quickNotesSetting.value || '') : '';

            displayMedalCount((await loadAndRefreshMedalData()).count);
        }
        
        async function loadAndRefreshMedalData() {
            const today = getTodayDateString();
            let data = await dbGet(DAILY_MEDALS_STORE_NAME, today);
            if(!data || data.date !== today){
                data = {date: today, count: todos.filter(t => t.completed && t.completedDate === today).length};
                await dbPut(DAILY_MEDALS_STORE_NAME, data);
            } 
            return data;
        }
        async function updateMedalCount(change) {
            let data = await loadAndRefreshMedalData(); 
            data.count = Math.max(0, data.count + change); 
            await dbPut(DAILY_MEDALS_STORE_NAME, data);
            displayMedalCount(data.count);
        }

        function syncAndRender() { renderTodosUI(); initializeActiveTimersFromStorage(); }
        
        function calculateSubtaskProgress(subtasks) {
            if (!subtasks || subtasks.length === 0) return 0; return (subtasks.filter(s => s.completed).length / subtasks.length) * 100;
        }

        function createMainTaskHeader(mainTask) {
            const header = document.createElement('div'); header.classList.add('main-task-header');
            const prefixGrp = document.createElement('div'); prefixGrp.classList.add('task-prefix-group');
            const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.classList.add('custom-checkbox'); checkbox.checked = mainTask.completed; checkbox.id = `main-chk-${mainTask.id}`;
            const chkLbl = document.createElement('label'); chkLbl.htmlFor = checkbox.id; chkLbl.classList.add('sr-only'); chkLbl.textContent = `Marcar ${mainTask.text}`;
            checkbox.onchange = (e) => toggleMainCompletion(mainTask.id, e.target.checked);
            const priorityLbl = document.createElement('div'); priorityLbl.classList.add('priority-color-label'); priorityLbl.dataset.color = mainTask.priorityColor; priorityLbl.title = `Prioridad: ${mainTask.priorityColor}`;
            priorityLbl.onclick = () => { if (!mainTask.completed) cyclePriorityColor(mainTask.id); };
            prefixGrp.append(chkLbl, checkbox, priorityLbl);

            const bodyDiv = document.createElement('div'); bodyDiv.classList.add('task-body');
            const taskTextAndInfoContainer = document.createElement('div');
            taskTextAndInfoContainer.classList.add('task-text-and-info');
            const span = document.createElement('span'); 
            span.textContent = mainTask.text;
            span.title = mainTask.text;
            taskTextAndInfoContainer.appendChild(span);

            if (!mainTask.completed && mainTask.createdAt) {
                const daysAgoText = calculateDaysAgo(mainTask.createdAt);
                if (daysAgoText) {
                    const daysAgoSpan = document.createElement('span');
                    daysAgoSpan.classList.add('task-days-ago');
                    daysAgoSpan.textContent = daysAgoText;
                    taskTextAndInfoContainer.appendChild(daysAgoSpan);
                }
            }

            const actionsGrp = document.createElement('div'); actionsGrp.classList.add('task-actions-group');
            const linkBtn = document.createElement('button'); linkBtn.classList.add('app-button', 'link-button', mainTask.linkUrl ? 'link-on' : 'link-off'); linkBtn.innerHTML = '<i class="fas fa-link"></i>'; linkBtn.setAttribute('aria-label','Enlace'); linkBtn.title = mainTask.linkUrl ? `Abrir: ${mainTask.linkUrl}` : 'Añadir enlace';
            linkBtn.onclick = async () => { 
                const task = findTaskById(mainTask.id); 
                if (!task || (task.completed && !task.linkUrl)) return; 
                if (task.linkUrl) window.open(new URL(task.linkUrl).href, '_blank'); 
                else if (!task.completed) { 
                    let newUrl = prompt("URL:", task.linkUrl || ""); 
                    if (newUrl === null) return; 
                    newUrl = newUrl.trim(); 
                    let finalUrl = null; 
                    if (newUrl) { 
                        finalUrl = (newUrl.startsWith('http') ? '' : 'https://') + newUrl; 
                        try {new URL(finalUrl);} catch { finalUrl = task.linkUrl; alert("URL inválida.");}
                    } 
                    if (task.linkUrl !== finalUrl) { 
                        task.linkUrl = finalUrl; 
                        await dbPut(TASKS_STORE_NAME, task); 
                        syncAndRender(); 
                    }
                }
            };
            const calBtn = document.createElement('button'); calBtn.classList.add('app-button', 'google-calendar-button'); calBtn.innerHTML = '<i class="far fa-calendar-plus"></i>'; calBtn.setAttribute('aria-label','Agendar'); calBtn.title = 'Agendar en Calendar'; if(mainTask.completed) calBtn.disabled = true;
            calBtn.onclick = () => { if (!mainTask.completed) showReminderModal(mainTask.id); };
            const timerBtn = document.createElement('button'); timerBtn.classList.add('app-button', 'task-timer-button'); timerBtn.innerHTML = '<i class="fas fa-clock"></i>'; timerBtn.setAttribute('aria-label','Temporizador'); timerBtn.title = 'Iniciar temporizador';
            timerBtn.onclick = (e) => { e.stopPropagation(); handleTimerButtonClick(e, mainTask.id, mainTask.text, false); };
            const delBtn = document.createElement('button'); delBtn.classList.add('app-button', 'delete-button'); delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; delBtn.setAttribute('aria-label','Eliminar');
            delBtn.onclick = () => { if (confirm(`¿Borrar "${mainTask.text}"?`)) deleteTodo(mainTask.id); };
            actionsGrp.append(linkBtn, calBtn, timerBtn, delBtn);

            bodyDiv.append(taskTextAndInfoContainer, actionsGrp); 
            header.append(prefixGrp, bodyDiv);
            return header;
        }
        function createProgressBar(mainTask) {
            const pCont = document.createElement('div'); pCont.classList.add('progress-container');
            const pBar = document.createElement('div'); pBar.classList.add('progress-bar');
            let prog = 0; if(mainTask.completed) prog = 100; else if (mainTask.subtasks&&mainTask.subtasks.length>0){ const subProg = calculateSubtaskProgress(mainTask.subtasks); prog = subProg===100?90:subProg;} pBar.style.width = `${prog}%`;
            pCont.appendChild(pBar); return pCont;
        }
        function createAddSubtasksToggle(id) {
            const btn = document.createElement('button'); btn.classList.add('app-button','add-button','add-subtasks-toggle'); btn.innerHTML='<i class="fas fa-plus"></i>'; btn.setAttribute('aria-label','Sub-tarea');
            btn.onclick= async ()=>{
                const t=findTaskById(id);
                if(t){
                    if(t.completed)return; 
                    t.showSubtaskUI=!t.showSubtaskUI; 
                    if(t.showSubtaskUI&&(!t.subtasks||t.subtasks.length===0)) t.subtasks=[]; 
                    await dbPut(TASKS_STORE_NAME, t);
                    syncAndRender(); 
                    if(t.showSubtaskUI){
                        const liEl=todoListContainer.querySelector(`li[data-task-id="${id}"] .subtask-input-container input[type="text"]`); 
                        if(liEl)setTimeout(()=>liEl.focus(),0);
                    }
                }
            }; 
            return btn;
        }
        function createSubtasksList(mainTask) {
            const ul=document.createElement('ul');ul.classList.add('subtasks-list');if(mainTask.subtasks&&mainTask.subtasks.length>0){mainTask.subtasks.forEach((s,i)=>{const li=document.createElement('li');li.dataset.subtaskId=s.id;const chk=document.createElement('input');chk.type='checkbox';chk.classList.add('custom-checkbox');chk.checked=s.completed;chk.id=`sub-chk-${s.id}`;if(mainTask.completed)chk.disabled=true;const lbl=document.createElement('label');lbl.htmlFor=chk.id;lbl.classList.add('sr-only');lbl.textContent=`Marcar ${s.text}`;chk.onchange=()=>{if(!mainTask.completed)toggleSubtaskCompletion(mainTask.id,s.id);};const span=document.createElement('span');span.textContent=s.text;span.title=s.text;const tBtn=document.createElement('button');tBtn.classList.add('app-button','task-timer-button');tBtn.innerHTML='<i class="fas fa-clock"></i>';tBtn.title='Temporizador';tBtn.onclick=(e)=>{e.stopPropagation();handleTimerButtonClick(e, s.id,s.text,true,mainTask.id);};const up=document.createElement('button');up.classList.add('app-button','subtask-move-button');up.innerHTML='<i class="fas fa-arrow-up"></i>';up.title='Arriba';if(mainTask.completed||i===0)up.disabled=true;up.onclick=()=>{if(!mainTask.completed)moveSubtaskUp(mainTask.id,s.id);};const down=document.createElement('button');down.classList.add('app-button','subtask-move-button');down.innerHTML='<i class="fas fa-arrow-down"></i>';down.title='Abajo';if(mainTask.completed||i===mainTask.subtasks.length-1)down.disabled=true;down.onclick=()=>{if(!mainTask.completed)moveSubtaskDown(mainTask.id,s.id);};const del=document.createElement('button');del.classList.add('app-button','delete-button');del.innerHTML='<i class="fas fa-trash-alt"></i>';del.title='Eliminar';if(mainTask.completed)del.disabled=true;del.onclick=()=>{if(!mainTask.completed)deleteSubtask(mainTask.id,s.id);};li.append(lbl,chk,span,tBtn,up,down,del);ul.appendChild(li);});}return ul;
        }
        function createSubtaskInputContainer(id) {
            const cont=document.createElement('div');cont.classList.add('subtask-input-container');const inputId=`sub-in-${id}`;const lbl=document.createElement('label');lbl.htmlFor=inputId;lbl.classList.add('sr-only');lbl.textContent='Nueva sub-tarea';const input=document.createElement('input');input.type='text';input.id=inputId;input.placeholder='Nueva sub-tarea...';const addBtn=document.createElement('button');addBtn.classList.add('app-button','add-button');addBtn.innerHTML='<i class="fas fa-plus"></i>';addBtn.setAttribute('aria-label','Añadir');const handleAdd=()=>addSubtask(id,input);addBtn.onclick=handleAdd;input.onkeypress=e=>{if(e.key==='Enter'){e.preventDefault();handleAdd();}};cont.append(lbl,input,addBtn);return cont;
        }
        function renderTodosUI() {
            if(!todoListContainer)return;todoListContainer.innerHTML='';todos.forEach(t=>{const li=document.createElement('li');li.classList.add('todo-item');li.dataset.taskId=t.id;li.dataset.priorityColor=t.priorityColor||'none';if(t.completed)li.classList.add('completed');if(t.showSubtaskUI)li.classList.add('show-subtask-ui');li.appendChild(createMainTaskHeader(t));li.appendChild(createProgressBar(t));li.appendChild(createAddSubtasksToggle(t.id));if(t.subtasks&&t.subtasks.length>0)li.appendChild(createSubtasksList(t));if(t.showSubtaskUI&&!t.completed)li.appendChild(createSubtaskInputContainer(t.id));todoListContainer.appendChild(li);});if(todoInput)todoInput.value='';
        }

        async function cyclePriorityColor(id) {
            const t=findTaskById(id);
            if(t&&!t.completed){
                const i=PRIORITY_COLORS.indexOf(t.priorityColor||'none');
                t.priorityColor=PRIORITY_COLORS[(i+1)%PRIORITY_COLORS.length];
                await dbPut(TASKS_STORE_NAME, t);
                const li=todoListContainer.querySelector(`li[data-task-id="${t.id}"]`);
                if(li){
                    li.dataset.priorityColor=t.priorityColor;
                    const pl=li.querySelector('.priority-color-label');
                    if(pl){pl.dataset.color=t.priorityColor;pl.title=`Prioridad: ${t.priorityColor.charAt(0).toUpperCase()+t.priorityColor.slice(1)}`;}
                }
            }
        }
        async function showAppInterface() {
            if(welcomeSection)welcomeSection.classList.add('hidden');
            if(installInstructionsSection)installInstructionsSection.classList.add('hidden');
            if(appMainInterface)appMainInterface.classList.remove('hidden');
            if(todoInput)todoInput.focus();
            requestNotificationPermission();
            if(!window.timersInitializedOnShow){
                renderTodosUI(); 
                await initializeActiveTimersFromStorage();
                window.timersInitializedOnShow=true;
            }
        }
        async function addTodo() {
            const txt=todoInput.value.trim();if(txt==='')return alert('Tarea vacía.');
            const order=todos.length > 0 ? Math.max(...todos.map(t => t.order || 0)) + 1 : 0;
            const nt={id:generateLocalId(),text:txt,completed:false,completedDate:null,createdAt:new Date().toISOString(),subtasks:[],showSubtaskUI:false,priorityColor:'none',date:null,linkUrl:null,order:order};
            await dbPut(TASKS_STORE_NAME, nt);
            todos.push(nt); 
            todos.sort((a,b) => (a.order || 0) - (b.order || 0)); 
            syncAndRender();
            if(todoInput)todoInput.value='';
            if(todos.length===1&&welcomeSection&&!welcomeSection.classList.contains('hidden'))showAppInterface();
        }
        async function addSubtask(id,input) {
            const txt=input.value.trim();if(txt==='')return alert('Sub-tarea vacía.');
            const mt=findTaskById(id);
            if(mt&&!mt.completed){
                if(!mt.subtasks)mt.subtasks=[];
                mt.subtasks.push({id:generateLocalId(),text:txt,completed:false});
                mt.showSubtaskUI=false;
                await dbPut(TASKS_STORE_NAME, mt);
                syncAndRender();
            }
        }
        async function deleteTodo(id) {
            const idx=findTaskIndexById(id);
            if(idx>-1){
                const tDel=todos[idx];
                if(tDel.completed&&tDel.completedDate===getTodayDateString()) await updateMedalCount(-1);
                
                let activeTimers = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);
                let timerOperations = [];
                if (activeTimers.find(timer => timer.id === tDel.id)) {
                    timerOperations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, tDel.id));
                }
                if(tDel.subtasks) {
                    for (const s of tDel.subtasks) { // Usar for...of para await dentro del loop si es necesario
                        if (activeTimers.find(timer => timer.id === s.id)) {
                           timerOperations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, s.id));
                        }
                    }
                }
                await Promise.all(timerOperations);

                await dbDelete(TASKS_STORE_NAME, id);
                todos.splice(idx,1);
                syncAndRender();
                if(todos.length===0&&welcomeSection&&appMainInterface&&installInstructionsSection){
                    welcomeSection.classList.remove('hidden');
                    installInstructionsSection.classList.remove('hidden');
                    appMainInterface.classList.add('hidden');
                }
            }
        }
        async function deleteSubtask(mainId,subId) {
            const mt=findTaskById(mainId);
            if(mt&&mt.subtasks&&!mt.completed){
                const idx=mt.subtasks.findIndex(s=>s.id===subId);
                if(idx>-1){
                    const activeTimer = await dbGet(ACTIVE_TIMERS_STORE_NAME, subId);
                    if (activeTimer) await dbDelete(ACTIVE_TIMERS_STORE_NAME, subId);
                    
                    mt.subtasks.splice(idx,1);
                    await dbPut(TASKS_STORE_NAME, mt);
                    syncAndRender();
                }
            }
        }
        async function toggleSubtaskCompletion(mainId,subId) {
            const mt=findTaskById(mainId);
            if(mt&&mt.subtasks&&!mt.completed){
                const s=mt.subtasks.find(st=>st.id===subId);
                if(s){
                    s.completed=!s.completed;
                    if(s.completed){
                        const activeTimer = await dbGet(ACTIVE_TIMERS_STORE_NAME, s.id);
                        if (activeTimer) await dbDelete(ACTIVE_TIMERS_STORE_NAME, s.id);
                    }
                    await dbPut(TASKS_STORE_NAME, mt);
                    syncAndRender();
                }
            }
        }
        async function toggleMainCompletion(id,isChecked) {
            const t=findTaskById(id);
            if(t){
                if(!isChecked&&t.subtasks&&t.subtasks.some(s=>!s.completed)){
                    const chk=todoListContainer.querySelector(`li[data-task-id="${t.id}"] .main-task-header .custom-checkbox`);
                    if(chk)chk.checked=true;
                    alert("Desmarca subtareas incompletas.");
                    return;
                }
                t.completed=isChecked;
                const today=getTodayDateString();
                if(isChecked){
                    if(!t.completedDate||t.completedDate!==today) await updateMedalCount(1);
                    if(!t.completedDate){
                        totalMedalsEarned++;
                        await dbPut(SETTINGS_STORE_NAME, {key: 'totalMedals', value: totalMedalsEarned});
                        displayTotalScore(totalMedalsEarned);
                    }
                    t.completedDate=today;
                    t.showSubtaskUI=false;
                    if(t.subtasks)t.subtasks.forEach(s=>s.completed=true);
                    if(typeof confetti==='function')confetti({particleCount:150,spread:90,origin:{y:0.55}});
                    
                    let timerOperations = [];
                    const activeTimerMain = await dbGet(ACTIVE_TIMERS_STORE_NAME, t.id);
                    if (activeTimerMain) timerOperations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, t.id));
                    if(t.subtasks) {
                        for (const s of t.subtasks) {
                            const activeTimerSub = await dbGet(ACTIVE_TIMERS_STORE_NAME, s.id);
                            if (activeTimerSub) timerOperations.push(dbDelete(ACTIVE_TIMERS_STORE_NAME, s.id));
                        }
                    }
                    await Promise.all(timerOperations);

                }else{
                    if(t.completedDate===today) await updateMedalCount(-1);
                    t.completedDate=null;
                }
                await dbPut(TASKS_STORE_NAME, t);
                syncAndRender();
            }
        }

        async function moveSubtask(mainId,subId,dir) {
            const mt=findTaskById(mainId);
            if(mt&&mt.subtasks&&!mt.completed){
                const i=mt.subtasks.findIndex(s=>s.id===subId);
                if(i===-1)return;
                const ni=i+dir;
                if(ni>=0&&ni<mt.subtasks.length){
                    [mt.subtasks[i],mt.subtasks[ni]]=[mt.subtasks[ni],mt.subtasks[i]];
                    await dbPut(TASKS_STORE_NAME, mt);
                    syncAndRender();
                }
            }
        }
        function moveSubtaskUp(mainId,subId){moveSubtask(mainId,subId,-1);}
        function moveSubtaskDown(mainId,subId){moveSubtask(mainId,subId,1);}
        
        async function performSortByPriority() {
            todos.sort((a,b)=>{
                if(a.completed!==b.completed)return a.completed?1:-1; // No completadas primero
                
                const priorityA = PRIORITY_ORDER[a.priorityColor]||PRIORITY_ORDER['none'];
                const priorityB = PRIORITY_ORDER[b.priorityColor]||PRIORITY_ORDER['none'];
                if(priorityA!==priorityB)return priorityA-priorityB; // Por prioridad
                
                const createdAtA = a.createdAt ? new Date(a.createdAt).getTime() : Infinity;
                const createdAtB = b.createdAt ? new Date(b.createdAt).getTime() : Infinity;
                return createdAtA - createdAtB; // Luego, por fecha de creación (más antiguas primero)
            });
            
            let updatePromises = [];
            todos.forEach((t,i)=>{
                t.order=i; // Re-assign order based on new sort
                updatePromises.push(dbPut(TASKS_STORE_NAME, t));
            });
            await Promise.all(updatePromises);
            syncAndRender();
        }

        async function performSortByCreation() {
            todos.sort((a,b)=>{
                if(a.completed!==b.completed)return a.completed?1:-1; // No completadas primero
                
                const createdAtA = a.createdAt ? new Date(a.createdAt).getTime() : Infinity;
                const createdAtB = b.createdAt ? new Date(b.createdAt).getTime() : Infinity;
                return createdAtA - createdAtB; // Luego, por fecha de creación (más antiguas primero)
            });
            
            let updatePromises = [];
            todos.forEach((t,i)=>{
                t.order=i; // Re-assign order based on new sort
                updatePromises.push(dbPut(TASKS_STORE_NAME, t));
            });
            await Promise.all(updatePromises);
            syncAndRender();
        }

        async function enableDarkMode() {
            body.classList.add('dark-mode');
            await dbPut(SETTINGS_STORE_NAME, {key: 'theme', value: 'dark'});
            if(darkModeToggle){darkModeToggle.querySelector('i').className='fas fa-sun';darkModeToggle.setAttribute('aria-label','Modo claro');darkModeToggle.title='Modo claro';}
        }
        async function disableDarkMode() {
            body.classList.remove('dark-mode');
            await dbPut(SETTINGS_STORE_NAME, {key: 'theme', value: 'light'});
            if(darkModeToggle){darkModeToggle.querySelector('i').className='fas fa-moon';darkModeToggle.setAttribute('aria-label','Modo oscuro');darkModeToggle.title='Modo oscuro';}}
        
        async function toggleDarkMode() { 
            if (body.classList.contains('dark-mode')) {
                await disableDarkMode();
            } else {
                await enableDarkMode();
            }
        }

        async function exportAllDataLocal() {
            const themeSetting = await dbGet(SETTINGS_STORE_NAME, 'theme');
            const dailyMedalDataArray = await dbGetAll(DAILY_MEDALS_STORE_NAME); 
            const totalMedalsSetting = await dbGet(SETTINGS_STORE_NAME, 'totalMedals');
            const quickNotesSetting = await dbGet(SETTINGS_STORE_NAME, 'quickNotes');
            const tasksFromDB = await dbGetAll(TASKS_STORE_NAME);
            const activeTimersFromDB = await dbGetAll(ACTIVE_TIMERS_STORE_NAME);


            const data={
                theme: themeSetting ? themeSetting.value : 'dark', 
                dailyMedalData: dailyMedalDataArray || [], 
                totalMedals: totalMedalsSetting ? totalMedalsSetting.value : 0, 
                quickNotesContent: quickNotesSetting ? quickNotesSetting.value : '', 
                tasks: tasksFromDB || [],
                activeTimers: activeTimersFromDB || []
            };
            const json=JSON.stringify(data,null,2);const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`todolist-backup-${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);alert('Datos exportados: '+a.download);
        }
        
        async function applyImportedData(data,src="local"){
            try{
                if(typeof data!=='object'||!data||!Array.isArray(data.tasks))throw new Error('Formato inválido.');
                
                await dbClear(TASKS_STORE_NAME);
                await dbClear(SETTINGS_STORE_NAME);
                await dbClear(DAILY_MEDALS_STORE_NAME);
                await dbClear(ACTIVE_TIMERS_STORE_NAME);

                await dbPut(SETTINGS_STORE_NAME, {key: 'theme', value: data.theme==='light'?'light':'dark'});
                if(data.theme==='light') await disableDarkMode(); else await enableDarkMode();
                
                totalMedalsEarned=(typeof data.totalMedals==='number'&&!isNaN(data.totalMedals))?data.totalMedals:0;
                await dbPut(SETTINGS_STORE_NAME, {key: 'totalMedals', value: totalMedalsEarned});
                displayTotalScore(totalMedalsEarned);
                
                const quickNotesVal = typeof data.quickNotesContent==='string'?data.quickNotesContent:'';
                if (quickNotesArea) quickNotesArea.value = quickNotesVal;
                await dbPut(SETTINGS_STORE_NAME, {key: 'quickNotes', value: quickNotesVal});

                if (Array.isArray(data.dailyMedalData)) {
                    for (const medalEntry of data.dailyMedalData) {
                        if (medalEntry && typeof medalEntry.date === 'string' && typeof medalEntry.count === 'number') {
                           await dbPut(DAILY_MEDALS_STORE_NAME, medalEntry);
                        }
                    }
                }

                todos = data.tasks.map(t=>({id:t.id||generateLocalId(),text:t.text||'?',completed:!!t.completed,completedDate:t.completedDate||null,createdAt:t.createdAt||new Date().toISOString(),subtasks:Array.isArray(t.subtasks)?t.subtasks.map(s=>({id:s.id||generateLocalId(),text:s.text||'?',completed:!!s.completed})):[],showSubtaskUI:!!t.showSubtaskUI,priorityColor:PRIORITY_COLORS.includes(t.priorityColor)?t.priorityColor:'none',date:(typeof t.date==='string'&&t.date.match(/^\d{4}-\d{2}-\d{2}$/))?t.date:null,linkUrl:typeof t.linkUrl==='string'?t.linkUrl:null,order:typeof t.order==='number'?t.order: (t.createdAt ? new Date(t.createdAt).getTime() : 0)}));
                const idMap=new Set();
                let taskPromises = [];
                todos.forEach(t=>{
                    if(idMap.has(t.id))t.id=generateLocalId();
                    idMap.add(t.id);
                    if(t.subtasks){
                        const sIdMap=new Set();
                        t.subtasks.forEach(s=>{if(sIdMap.has(s.id))s.id=generateLocalId();sIdMap.add(s.id);});
                    }
                    taskPromises.push(dbPut(TASKS_STORE_NAME, t));
                });
                await Promise.all(taskPromises);

                if (Array.isArray(data.activeTimers)) {
                    let timerPromises = [];
                    data.activeTimers.forEach(timer => {
                        timerPromises.push(dbPut(ACTIVE_TIMERS_STORE_NAME, timer));
                    });
                    await Promise.all(timerPromises);
                }
                // Marcar la migración como completada también al importar, para evitar que se ejecute la migración de localStorage
                await dbPut(SETTINGS_STORE_NAME, { key: MIGRATION_FLAG_KEY, value: true });

                if(globalTimerInterval)clearInterval(globalTimerInterval);globalTimerInterval=null;
                alert(`Datos importados desde ${src}. Recargando...`);
                window.location.reload();
            }catch(e){console.error(`Error importando ${src}:`,e);alert(`Error: ${e.message}`);}
        }

        async function importAllDataLocal(event) {
            const file=event.target.files[0];if(!file)return;
            if(!confirm("¡Atención! Importar reemplazará datos. ¿Continuar?")){if(importFileInput)importFileInput.value='';return;}
            const reader=new FileReader();
            reader.onload=async e=>{
                try{
                    await applyImportedData(JSON.parse(e.target.result),"archivo local");
                }catch(err){
                    alert(`Error: ${err.message}`);
                }finally{
                    if(importFileInput)importFileInput.value='';
                }
            };
            reader.onerror=()=>{alert('Error al leer archivo.');if(importFileInput)importFileInput.value='';};
            reader.readAsText(file);
        }
        async function resetTotalScore() {
            if(confirm("¿Resetear 'Total Score' a cero?")){
                totalMedalsEarned=0;
                await dbPut(SETTINGS_STORE_NAME, {key: 'totalMedals', value: 0});
                displayTotalScore(totalMedalsEarned);
                alert("Total Score reseteado.");
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB(); 
            } catch (error) {
                console.error("Fallo crítico al abrir IndexedDB:", error);
                alert("Error: No se pudo inicializar la base de datos. La aplicación podría no funcionar correctamente o perder datos.");
                return; 
            }

            // Asignación de elementos del DOM
            todoInput = document.getElementById('new-todo-input');
            addTodoButton = document.getElementById('add-todo-button');
            todoListContainer = document.getElementById('todo-list');
            reorderByPriorityButton = document.getElementById('reorder-by-priority-button');
            reorderByCreationButton = document.getElementById('reorder-by-creation-button');
            darkModeToggle = document.getElementById('dark-mode-toggle');
            body = document.body;
            medalCountDisplay = document.getElementById('medal-count');
            totalScoreValueDisplay = document.getElementById('total-score-value');
            resetTotalScoreButton = document.getElementById('reset-total-score-button');
            infoButton = document.getElementById('info-button');
            infoModal = document.getElementById('info-modal');
            closeModalButton = document.getElementById('close-modal-button');
            reminderModal = document.getElementById('reminder-modal');
            closeReminderModalButton = document.getElementById('close-reminder-modal');
            reminderTaskTextElement = document.getElementById('reminder-task-text');
            reminderDateInput = document.getElementById('reminder-date');
            reminderTimeInput = document.getElementById('reminder-time');
            scheduleReminderButton = document.getElementById('schedule-reminder-button');
            quickScheduleCalendarModal = document.getElementById('quick-schedule-calendar-modal');
            openQuickScheduleModalButton = document.getElementById('open-quick-schedule-modal-button');
            closeQuickScheduleModalButton = document.getElementById('close-quick-schedule-modal');
            quickGcEventTitleInput = document.getElementById('quick-gc-event-title');
            quickGcStartDateInput = document.getElementById('quick-gc-start-date');
            quickGcTimeInput = document.getElementById('quick-gc-time');
            quickGcTypeSelect = document.getElementById('quick-gc-type');
            quickGcWeeklyDaysGroup = document.getElementById('quick-gc-weekly-days-group');
            quickGcWeeklyCheckboxesContainer = document.getElementById('quick-gc-weekly-checkboxes');
            quickGcDescriptionTextarea = document.getElementById('quick-gc-description');
            createQuickGoogleCalendarEventButton = document.getElementById('create-quick-google-calendar-event-button');
            quickNotesArea = document.getElementById('quick-notes-area');
            clearNotesButton = document.getElementById('clear-notes-button');
            exportDataButton = document.getElementById('export-data-button');
            importDataButton = document.getElementById('import-data-button');
            importFileInput = document.getElementById('import-file-input');
            exportDriveButton = document.getElementById('export-drive-button');
            importDriveButton = document.getElementById('import-drive-button');
            welcomeSection = document.getElementById('welcome-section');
            startAppButton = document.getElementById('start-app-button');
            appMainInterface = document.getElementById('app-main-interface');
            installInstructionsSection = document.getElementById('install-instructions-section');
            alarmAudio = document.getElementById('alarm-sound');
            timerDurationModal = document.getElementById('timer-duration-modal');
            closeTimerDurationModalButton = document.getElementById('close-timer-duration-modal');
            timerDurationTaskTextElement = document.getElementById('timer-duration-task-text');
            timerQuickOptionsContainer = document.getElementById('timer-quick-options-container');
            timerCustomMinutesInput = document.getElementById('timer-custom-minutes');
            setCustomTimerButton = document.getElementById('set-custom-timer-button');

            await loadInitialDataFromDB(); 

            if (todos.length === 0) { 
                if (welcomeSection) welcomeSection.classList.remove('hidden'); 
                if (installInstructionsSection) installInstructionsSection.classList.remove('hidden'); 
                if (appMainInterface) appMainInterface.classList.add('hidden');
            } else { 
                if (appMainInterface) appMainInterface.classList.remove('hidden'); 
                if (appMainInterface && !appMainInterface.classList.contains('hidden')) { 
                    renderTodosUI(); 
                    await initializeActiveTimersFromStorage(); 
                    window.timersInitializedOnShow = true; 
                }
            }
            
            // Event Listeners
            if (addTodoButton) addTodoButton.addEventListener('click', addTodo);
            if (todoInput) todoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTodo(); } });
            if (reorderByPriorityButton) reorderByPriorityButton.addEventListener('click', performSortByPriority);
            if (reorderByCreationButton) reorderByCreationButton.addEventListener('click', performSortByCreation);
            if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);
            if (resetTotalScoreButton) resetTotalScoreButton.addEventListener('click', resetTotalScore);
            if (startAppButton) startAppButton.addEventListener('click', showAppInterface);

            if (infoButton) infoButton.addEventListener('click', () => { infoModal.classList.add('visible'); infoModal.setAttribute('role','dialog'); infoModal.setAttribute('aria-modal','true'); requestAnimationFrame(() => (infoModal.querySelector('button') || closeModalButton).focus()); });
            const closeInfo = () => { if(infoModal) {infoModal.classList.remove('visible'); infoModal.removeAttribute('role'); infoModal.removeAttribute('aria-modal');} if(infoButton) infoButton.focus();};
            if (closeModalButton) closeModalButton.addEventListener('click', closeInfo); 
            if (infoModal) infoModal.addEventListener('click', e => {if(e.target===infoModal)closeInfo();}); 
            document.addEventListener('keydown', e => {if(e.key==='Escape'&&infoModal && infoModal.classList.contains('visible'))closeInfo();});

            if (closeReminderModalButton) closeReminderModalButton.addEventListener('click', hideReminderModal);
            if (scheduleReminderButton) scheduleReminderButton.addEventListener('click', handleScheduleReminderClick);
            if (reminderModal) reminderModal.addEventListener('click', e => { if (e.target === reminderModal) hideReminderModal(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && reminderModal && reminderModal.classList.contains('visible')) hideReminderModal(); });

            if (openQuickScheduleModalButton) openQuickScheduleModalButton.addEventListener('click', showQuickScheduleCalendarModal);
            if (closeQuickScheduleModalButton) closeQuickScheduleModalButton.addEventListener('click', hideQuickScheduleCalendarModal);
            if (createQuickGoogleCalendarEventButton) createQuickGoogleCalendarEventButton.addEventListener('click', handleCreateQuickCalendarEvent);
            if (quickScheduleCalendarModal) quickScheduleCalendarModal.addEventListener('click', e => { if (e.target === quickScheduleCalendarModal) hideQuickScheduleCalendarModal(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && quickScheduleCalendarModal && quickScheduleCalendarModal.classList.contains('visible')) hideQuickScheduleCalendarModal(); });
            if (quickGcTypeSelect) quickGcTypeSelect.addEventListener('change', e => { if (e.target.value === 'WEEKLY') { quickGcWeeklyDaysGroup.classList.remove('hidden'); if (quickGcStartDateInput.value && quickGcWeeklyCheckboxesContainer) { quickGcWeeklyCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false); try { const dayIdx = new Date(quickGcStartDateInput.value + "T00:00:00").getDay(); const dayCb = quickGcWeeklyCheckboxesContainer.querySelector(`input[data-day-index="${dayIdx}"]`); if(dayCb)dayCb.checked = true; } catch {} }} else quickGcWeeklyDaysGroup.classList.add('hidden'); });
            if (quickGcStartDateInput) quickGcStartDateInput.addEventListener('change', () => { if (quickGcTypeSelect.value === 'WEEKLY' && quickGcStartDateInput.value && quickGcWeeklyCheckboxesContainer) { quickGcWeeklyCheckboxesContainer.querySelectorAll('input').forEach(cb => cb.checked = false); try { const dayIdx = new Date(quickGcStartDateInput.value + "T00:00:00").getDay(); const dayCb = quickGcWeeklyCheckboxesContainer.querySelector(`input[data-day-index="${dayIdx}"]`); if(dayCb)dayCb.checked = true; } catch {}}});

            if (closeTimerDurationModalButton) closeTimerDurationModalButton.addEventListener('click', hideTimerDurationModal);
            if (timerDurationModal) { timerDurationModal.addEventListener('click', (e) => { if (e.target === timerDurationModal) hideTimerDurationModal(); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && timerDurationModal.classList.contains('visible')) hideTimerDurationModal(); });}
            if (timerQuickOptionsContainer) { timerQuickOptionsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('timer-duration-option')) { const mins = parseInt(e.target.dataset.minutes, 10); if (currentTimerCallback && !isNaN(mins)) { const btn = e.target; currentTimerCallback(mins); hideTimerDurationModal(); const lastOpenedTimerButton = document.querySelector('[data-last-opened-timer="true"]'); if(lastOpenedTimerButton) { lastOpenedTimerButton.focus(); lastOpenedTimerButton.removeAttribute('data-last-opened-timer');}} }});}
            if (setCustomTimerButton && timerCustomMinutesInput) { setCustomTimerButton.addEventListener('click', () => { const mins = parseInt(timerCustomMinutesInput.value, 10); if (isNaN(mins) || mins < 1 || mins > 180) { alert("Minutos inválidos (1-180)."); timerCustomMinutesInput.focus(); return; } if (currentTimerCallback) { currentTimerCallback(mins); hideTimerDurationModal(); const lastOpenedTimerButton = document.querySelector('[data-last-opened-timer="true"]'); if(lastOpenedTimerButton) { lastOpenedTimerButton.focus(); lastOpenedTimerButton.removeAttribute('data-last-opened-timer');} } }); timerCustomMinutesInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); setCustomTimerButton.click(); }});}

            if (quickNotesArea) quickNotesArea.addEventListener('input', async () => await dbPut(SETTINGS_STORE_NAME, {key: 'quickNotes', value: quickNotesArea.value}));
            if (clearNotesButton) clearNotesButton.addEventListener('click', async () => { 
                if(quickNotesArea) quickNotesArea.value = ''; 
                await dbPut(SETTINGS_STORE_NAME, {key: 'quickNotes', value: ''}); 
                if(quickNotesArea) quickNotesArea.focus(); 
            });

            if (exportDataButton) exportDataButton.addEventListener('click', exportAllDataLocal);
            if (importDataButton) importDataButton.addEventListener('click', () => importFileInput.click());
            if (importFileInput) importFileInput.addEventListener('change', importAllDataLocal);
            if (exportDriveButton) exportDriveButton.addEventListener('click', () => handleAuthClick(exportToGoogleDrive));
            if (importDriveButton) importDriveButton.addEventListener('click', () => handleAuthClick(importFromGoogleDrive));

            if (window.isGoogleGisScriptReady) window.googleApiCallbacks.gisLoaded();
            if (window.isGoogleGapiScriptReady) window.googleApiCallbacks.gapiLoaded();
            maybeEnableDriveButtons();

            const observer = new MutationObserver(async (mutations) => { 
                for (const m of mutations) {
                    if (m.type === 'attributes' && m.attributeName === 'class') { 
                        if (appMainInterface && !appMainInterface.classList.contains('hidden') && !window.timersInitializedOnShow) { 
                            renderTodosUI(); 
                            await initializeActiveTimersFromStorage(); 
                            window.timersInitializedOnShow = true; 
                        } else if (appMainInterface && appMainInterface.classList.contains('hidden')) {
                            window.timersInitializedOnShow = false; 
                        }
                    }
                }
            });
            if (appMainInterface) observer.observe(appMainInterface, { attributes: true });
        });
    </script>

</body>
</html>
