<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- MODIFIED: Removed user-scalable=no, maximum-scale=1.0 for accessibility -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español</title> <!-- MODIFIED: Slightly strengthened title for keywords -->
    <meta name="description" content="ToDayList: Tu gestor de tareas diarias y lista to-do minimalista y eficiente en español. Organiza tus pendientes, establece prioridades, añade subtareas y fechas límite. Con integración Google Drive y Calendar. ¡Mejora tu productividad hoy!"> <!-- MODIFIED: Slightly strengthened description for keywords -->
    <meta name="keywords" content="lista de tareas, to-do list, gestor de tareas diarias, organizador personal, productividad, planificación diaria, tareas pendientes, subtareas, prioridades, web app, enrique gil, ToDayList, google drive, google calendar, español, en español"> <!-- MODIFIED: Added 'español', 'en español' keywords -->
    <meta name="author" content="Enrique Gil">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://www.todaylist.es/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.todaylist.es/">
    <!-- MODIFIED: Harmonized OG title with new title -->
    <meta property="og:title" content="ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español">
    <!-- MODIFIED: Slightly strengthened OG description -->
    <meta property="og:description" content="Organiza tus pendientes con ToDayList: tu gestor de tareas diarias y lista to-do minimalista y eficiente en español con integración de Google Drive y Calendar.">
    <meta property="og:image" content="https://www.todaylist.es/ToDayList.png">
    <meta property="og:site_name" content="ToDayList">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.todaylist.es/">
     <!-- MODIFIED: Harmonized Twitter title with new title -->
    <meta property="twitter:title" content="ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español">
     <!-- MODIFIED: Slightly strengthened Twitter description -->
    <meta property="twitter:description" content="Organiza tus pendientes con ToDayList: tu gestor de tareas diarias y lista to-do minimalista y eficiente en español con integración de Google Drive y Calendar.">
    <meta property="twitter:image" content="https://www.todaylist.es/ToDayList.png">

    <!-- Favicons -->
    <link rel="icon" href="/favicon-96x96.png" type="image/png" sizes="96x96">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" sizes="any">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <!-- REMOVED: Link to PWA manifest -->


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

     <!-- Código Schema.org para SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "ToDayList - Gestor de Tareas Diarias y Lista To-Do en Español", <!-- MODIFIED: Harmonized with title -->
      "description": "ToDayList es tu gestor de tareas diarias y lista to-do minimalista y eficiente en español. Organiza tus pendientes, establece prioridades, añade subtareas y fechas límite. Con integración para agendar en Google Calendar y sincronización de datos con Google Drive. ¡Mejora tu productividad hoy!", <!-- MODIFIED: Harmonized and slightly expanded -->
      "url": "https://www.todaylist.es/",
      "primaryImageOfPage": "https://www.todaylist.es/ToDayList.png",
      "mainEntity": {
        "@type": "SoftwareApplication",
        "name": "ToDayList",
        "applicationCategory": "https://schema.org/ProductivityApplication",
        "operatingSystem": "Web Browser",
        "description": "ToDayList es un gestor de tareas diarias y lista to-do minimalista y eficiente en español que te ayuda a organizar tus pendientes, establecer prioridades, añadir subtareas, agendar en Google Calendar y sincronizar con Google Drive. Ideal para simplificar y organizar tus tareas diarias y aumentar tu productividad.", <!-- MODIFIED: Added 'en español' -->
        "url": "https://www.todaylist.es/",
        "author": {
          "@type": "Person",
          "name": "Enrique Gil"
        },
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD",
          "availability": "https://schema.org/OnlineOnly"
        },
        "image": [
           "https://www.todaylist.es/ToDayList.png",
           "https://www.todaylist.es/favicon-96x96.png",
           "https://www.todaylist.es/favicon.svg"
        ],
        "softwareVersion": "1.1.0",
        "datePublished": "2024-03-15",
        "keywords": "lista de tareas, to-do list, gestor de tareas diarias, organizador personal, productividad, planificación diaria, tareas pendientes, subtareas, prioridades, web app, task management, daily planner, online organizer, google drive sync, google calendar integration, free app, español, en español" <!-- MODIFIED: Added 'español', 'en español' keywords -->
      }
    }
    </script>
    <!-- Fin Código Schema.org -->

    <style>
        /* ADDED: Visually hidden class for accessibility labels */
         .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :root {
            /* CAMBIO SOLICITADO 1: Fondo general gris crema/beige para modo dia */
            --bg-color: #d4ccbc; /* Fondo general */

            --text-color: #333;
            --heading-color: #222;

            /* NUEVO CAMBIO SOLICITADO: Fondos de elementos específicos en modo dia */
            --item-bg: #f2eee6; /* Fondo de tareas, secciones, modales, botones de datos */
            --border-color: #e0e0e0; /* Mantener borde original o ajustar si quieres */
            --input-bg: #f2eee6; /* Fondo de cajas de texto */
            --input-text-color: #333;
            --placeholder-color: #888;
            --button-color: #555;
            --button-hover-color: #e74c3c;
            --delete-button-color: var(--button-color);
            --delete-button-hover-color: var(--button-hover-color);
            --completed-text-color: #999;
            --progress-bg: #e0ffe0;
            --progress-bar-color: #66c266;
            --progress-bar-completed-color: #28a745;
            --empty-list-color: #888;
            --fixed-button-bg: #f2eee6; /* Fondo de botones fijos (modo oscuro, borrar notas hover) */
            --fixed-button-border: #ccc; /* Mantener borde original o ajustar si quieres */
            --fixed-button-shadow: 0 2px 5px rgba(0,0,0,0.2);
            --legend-text-color: #666;
            --sort-button-color: #555;
            --sort-button-hover-color: #3498db;
            --footer-text-color: #aaa;
            --medal-color: #ffd700;
            --medal-text-color: var(--text-color);
            --subtitle-color: #777;
            --app-description-color: #555;
            --priority-red-color: #e74c3c;
            --priority-orange-color: #f39c12;
            --priority-yellow-color: #f1c40f;
            --priority-green-color: #2ecc71;
            --priority-none-color: var(--border-color);
            --welcome-button-bg: #e74c3c;
            --welcome-button-text: #fff;
            --welcome-button-hover-bg: #c0392b;

            --drive-icon-color: #4285F4;
            --accent-color: #3498db;

            /* NUEVO CAMBIO SOLICITADO: Fondo de inputs en modales en modo dia */
            --modal-input-background-color: #f2eee6; /* Fondo de inputs en modales */
            --modal-input-border-color: var(--border-color); /* Mantener borde original o ajustar si quieres */
            --schedule-link-text-color: var(--accent-color);
            --schedule-link-hover-text-color: #2980b9;
            --schedule-link-disabled-text-color: #7f8c8d;
            --checkbox-checkmark-color: var(--item-bg); /* El checkmark usa el color del item-bg */
        }

        body.dark-mode {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --heading-color: #ecf0f1;
            --item-bg: #34495e;
            --border-color: #4a627a;
            --input-bg: #445b71;
            --input-text-color: #ecf0f1;
            --placeholder-color: #bdc3c7;
            --button-color: #bdc3c7;
            --button-hover-color: #f39c12;
            --delete-button-color: var(--button-color);
            --delete-button-hover-color: var(--button-hover-color);
            --completed-text-color: #7f8c8d;
            --progress-bg: #4a627a;
            --progress-bar-color: #8bc34a;
            --progress-bar-completed-color: #28a745;
            --empty-list-color: #bdc3c7;
            --fixed-button-bg: #34495e;
            --fixed-button-border: #4a627a;
            --fixed-button-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --legend-text-color: #a0a0a0;
            --sort-button-color: #bdc3c7;
            --sort-button-hover-color: #3498db;
            --checkbox-checkmark-color: var(--bg-color);
            --footer-text-color: #777;
            --medal-text-color: var(--text-color);
            --subtitle-color: #bdc3c7;
            --app-description-color: #a0a0a0;
            --welcome-button-bg: #f39c12;
            --welcome-button-text: #2c3e50;
            --welcome-button-hover-bg: #e67e22;
            --drive-icon-color: #4A90E2;
            --accent-color: #5dade2;

            --modal-input-background-color: var(--input-bg);
            --modal-input-border-color: var(--border-color);
            --schedule-link-text-color: var(--accent-color);
            --schedule-link-hover-text-color: #3498db;
            --schedule-link-disabled-text-color: #7f8c8d;
        }

        body {
            font-family: 'Lexend', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 120px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 0 10px;
            box-sizing: border-box;
            flex-grow: 1;
            position: relative;
            padding-bottom: 20px;
        }

        /* --- ESTILOS ORIGINALES H1 (AJUSTADOS) --- */
        h1 { /* Estilos generales para h1 si hubiera otros, aunque solo hay uno principal */
            font-family: 'Quicksand', sans-serif;
            color: var(--heading-color); /* Mantener para el texto oculto/fallback */
            text-align: center;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin: 0; /* Reiniciar márgenes */
            padding: 0; /* Reiniciar padding */
            font-size: 2.8rem; /* Mantener para el texto oculto/fallback */
            /* Añadimos estilos para ocultar el texto y preparar para la imagen */
            text-indent: 101%; /* Mueve el texto fuera de la vista */
            overflow: hidden; /* Oculta el texto movido */
            white-space: nowrap; /* Evita que el texto se envuelva antes de moverlo */
            display: block; /* Necesario para controlar width/height */
        }

        /* --- NUEVOS ESTILOS PARA EL LOGO EN EL H1 --- */
        #page-title { /* Estilos específicos para el logo */
            /* Ocultar el texto del h1 de forma robusta */
            text-indent: 101%;
            overflow: hidden;
            white-space: nowrap;
            font-size: 0; /* Asegura que no haya espacio por el tamaño de fuente */
            line-height: 0; /* Asegura que no haya espacio por la altura de línea */
            color: transparent; /* Fallback por si acaso */
            padding: 0; /* Asegura que no haya padding */

            /* Configurar la imagen de fondo */
            background-image: url('/Logo.png'); /* Ruta a tu logo, asumiendo que está en la raíz */
            background-size: contain; /* La imagen se ajusta sin cortarse */
            background-repeat: no-repeat; /* No repetir la imagen */
            background-position: center; /* Centrar la imagen */

            /* Tamaño y posición del contenedor del logo */
            display: block; /* Necesario para width/height */
            width: 100%; /* Ocupa todo el ancho disponible */
            max-width: 300px; /* Tamaño máximo del logo (ajusta si es necesario) */
            height: 90px; /* Altura del logo (ajusta si es necesario) */
            margin: 40px auto 10px auto; /* Margen superior, centrado horizontal, margen inferior */

            /* Elimina estilos no deseados en el contenedor */
            cursor: default;
        }
        /* --- FIN ESTILOS LOGO --- */


        .subtitle {
            text-align: center;
            font-family: 'Lexend', sans-serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--subtitle-color);
            margin-top: 0;
            margin-bottom: 10px;
            letter-spacing: 0.2px;
        }
        .app-description-static {
            text-align: center;
            font-family: 'Lexend', sans-serif;
            font-size: 0.9rem;
            font-weight: 300;
            color: var(--app-description-color);
            margin-top: 0;
            /* Increased space after this paragraph */
            margin-bottom: 40px;
            line-height: 1.5;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }

        #welcome-section {
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        .welcome-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            border-radius: 12px;
        }
        #welcome-section h2 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.8rem;
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 15px;
        }
        #welcome-section p {
            font-size: 0.95rem;
            color: var(--text-color);
            /* Default margin for paragraphs in welcome section */
            margin-bottom: 15px; /* Kept original value for other paragraphs */
            line-height: 1.6;
        }
        /* MODIFIED: Increased space specifically after the first paragraph in welcome section */
        #welcome-section p:first-of-type {
             margin-bottom: 40px; /* Increased from 15px */
        }

        #welcome-section ul {
            list-style: none;
            padding-left: 0;
            margin: 20px auto;
            max-width: 400px;
            text-align: left;
        }
        #welcome-section ul li {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
            line-height: 1.5;
        }
        #welcome-section ul li::before {
            content: "\f00c";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 0;
            top: 3px;
            color: var(--progress-bar-completed-color);
        }
        body.dark-mode #welcome-section ul li::before {
            color: var(--progress-bar-color);
        }
        #start-app-button {
            background-color: var(--welcome-button-bg);
            color: var(--welcome-button-text);
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            margin-top: 20px;
            display: inline-block;
        }
        #start-app-button:hover {
            background-color: var(--welcome-button-hover-bg);
            transform: translateY(-2px);
        }
        #start-app-button:focus, #start-app-button:focus-visible {
             outline: 3px solid var(--button-hover-color);
             outline-offset: 2px;
        }

        #install-instructions-section {
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 18px 22px;
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            font-size: 0.85rem;
            color: var(--text-color);
        }
        #install-instructions-section h4 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.2rem;
            color: var(--subtitle-color);
            margin-top: 0;
            margin-bottom: 8px;
            text-align: center;
        }
        #install-instructions-section p {
            font-size: 0.95em;
            color: var(--text-color);
            margin-bottom: 12px;
            line-height: 1.45;
            text-align: center;
        }
        #install-instructions-section ul {
            list-style: none;
            padding-left: 5px;
            margin: 0 auto;
            max-width: 480px;
        }
        #install-instructions-section ul li {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.92em;
            padding-left: 25px;
            position: relative;
            text-align: left;
        }
        #install-instructions-section ul li::before {
            font-family: "Font Awesome 6 Brands", "Font Awesome 6 Free";
            font-weight: 400; /* FontAwesome Free uses 900 for solid, 400 for regular/brands */
            position: absolute;
            left: 0px;
            top: 1px;
            width: 20px;
            text-align: center;
            color: var(--button-color);
            font-size: 1.1em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #install-instructions-section ul li:nth-child(1)::before { content: "\f268"; font-weight: 400; } /* Chrome Icon (fab) */
        #install-instructions-section ul li:nth-child(2)::before { content: "\f17b"; font-weight: 400; } /* Android Icon (fab) */
        #install-instructions-section ul li:nth-child(3)::before { content: "\f179"; font-weight: 400; } /* Apple Icon (fab) */
        #install-instructions-section ul li:nth-child(4)::before { content: "\f267"; font-weight: 400; } /* Safari Icon (fab) */

        #install-instructions-section ul li strong {
            color: var(--heading-color);
            font-weight: 700;
        }
        #install-instructions-section ul li i.fas.fa-download,
        #install-instructions-section ul li i.fas.fa-ellipsis-v,
        #install-instructions-section ul li i.fas.fa-share-square {
            color: var(--button-hover-color);
            margin: 0 2px;
            font-size: 0.9em;
        }


        .hidden {
            display: none !important;
        }

        #medal-counter-container {
            text-align: center;
            font-size: 1.2rem;
            color: var(--medal-text-color);
            margin-bottom: 20px;
        }
        #medal-counter-container .fa-medal {
            color: var(--medal-color);
            margin-right: 5px;
        }
        #medal-count {
            font-weight: bold;
        }

        #priority-legend {
            text-align: center;
            font-size: 0.75rem;
            color: var(--legend-text-color);
            margin-top: 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px 10px;
        }
         #priority-legend .priority-legend-item {
             display: inline-flex;
             align-items: center;
             gap: 4px;
        }
         #priority-legend .priority-color-label {
             width: 10px;
             height: 10px;
             margin-right: 0;
             flex-shrink: 0;
         }
         #priority-legend .priority-color-label:hover {
             transform: none;
         }

        #todo-list {
            list-style: none;
            padding: 0;
            margin: 0 0 30px 0;
        }

        .todo-item {
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 5px solid var(--border-color);
            padding-left: 10px;
        }
         .todo-item:last-child {
             margin-bottom: 0;
         }

        .todo-item[data-priority-color="red"] { border-left-color: var(--priority-red-color); }
        .todo-item[data-priority-color="orange"] { border-left-color: var(--priority-orange-color); }
        .todo-item[data-priority-color="yellow"] { border-left-color: var(--priority-yellow-color); }
        .todo-item[data-priority-color="green"] { border-left-color: var(--priority-green-color); }
        .todo-item[data-priority-color="none"] { border-left-color: var(--priority-none-color); }


         .app-button {
             background: none;
             border: none;
             border-radius: 4px;
             cursor: pointer;
             transition: color 0.2s ease, background-color 0.2s ease, opacity 0.2s ease;
             flex-shrink: 0;
             padding: 6px 10px;
             font-size: 1rem;
             line-height: 1;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             text-decoration: none;
             color: var(--button-color);
         }
         .app-button:hover {
             color: var(--button-hover-color);
         }
         .app-button:focus, .app-button:focus-visible {
              outline: 2px solid var(--button-hover-color);
              outline-offset: 2px;
         }
         .app-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
         }
         .app-button:disabled:hover {
            color: var(--button-color);
         }

         .add-button {
             color: var(--button-color);
             font-weight: bold;
         }
         .add-button:hover {
             color: var(--button-hover-color);
         }
         .delete-button {
             color: var(--delete-button-color);
         }
         .delete-button:hover {
             color: var(--delete-button-hover-color);
         }
         .sort-button {
             color: var(--sort-button-color);
             font-weight: normal;
             padding: 10px 15px;
             font-size: 1.1rem;
         }
         .sort-button:hover {
             color: var(--sort-button-hover-color);
         }

         #dark-mode-toggle {
             position: fixed;
             bottom: 20px;
             right: 20px;
             font-size: 1.3rem;
             color: var(--button-color);
             z-index: 1000;
             background-color: var(--fixed-button-bg);
             border: 1px solid var(--fixed-button-border);
             border-radius: 50%;
             width: 45px;
             height: 45px;
             display: flex;
             justify-content: center;
             align-items: center;
             box-shadow: var(--fixed-button-shadow);
             transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
         }
         #dark-mode-toggle:hover {
             color: var(--button-hover-color);
         }
         #dark-mode-toggle i {
             line-height: 1;
         }

        #new-todo-input,
        .todo-item .subtask-input-container input[type="text"] {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex-grow: 1;
            min-width: 150px;
            font-size: 0.95rem;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--input-text-color);
            outline: none;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }
        #new-todo-input:focus,
        .todo-item .subtask-input-container input[type="text"]:focus {
            border-color: var(--button-hover-color);
            box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
        }
        #new-todo-input::placeholder,
        .todo-item .subtask-input-container input[type="text"]::placeholder {
             color: var(--placeholder-color);
             opacity: 1;
        }

         .custom-checkbox {
             margin-right: 10px;
             border: 1px solid var(--text-color);
             border-radius: 50%;
             appearance: none;
             -webkit-appearance: none;
             width: 20px;
             height: 20px;
             background-color: var(--item-bg);
             cursor: pointer;
             position: relative;
             flex-shrink: 0;
             box-sizing: border-box;
             transition: background-color 0.2s ease, border-color 0.2s ease;
         }
         .custom-checkbox:checked {
              background-color: var(--text-color);
              border-color: var(--text-color);
         }

         .custom-checkbox:checked::after {
             content: '';
             position: absolute;
             box-sizing: content-box;
             width: 5px;
             height: 9px;
             border: solid var(--checkbox-checkmark-color);
             border-width: 0 2px 2px 0;
             top: 3px;
             left: 6px;
             transform: rotate(45deg);
         }

        .todo-item .main-task-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 0;
            gap: 8px;
        }
        .todo-item .main-task-header .task-prefix-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .todo-item .priority-color-label {
             display: inline-block;
             width: 16px;
             height: 16px;
             border: 1px solid var(--border-color);
             border-radius: 4px;
             cursor: pointer;
             flex-shrink: 0;
             transition: border-color 0.2s ease, transform 0.1s ease, background-color 0.2s ease;
             box-sizing: border-box;
        }
         .todo-item .priority-color-label:hover {
             transform: scale(1.1);
         }
        .priority-color-label[data-color="red"] { background-color: var(--priority-red-color); border-color: var(--priority-red-color); }
        .priority-color-label[data-color="orange"] { background-color: var(--priority-orange-color); border-color: var(--priority-orange-color); }
        .priority-color-label[data-color="yellow"] { background-color: var(--priority-yellow-color); border-color: var(--priority-yellow-color); }
        .priority-color-label[data-color="green"] { background-color: var(--priority-green-color); border-color: var(--priority-green-color); }
        .priority-color-label[data-color="none"] { background-color: transparent; border-color: var(--border-color); }

        .todo-item .main-task-header .task-body {
            display: flex;
            flex-grow: 1;
            align-items: flex-start;
            gap: 8px;
            min-width: 0;
            flex-wrap: wrap;
        }

        .todo-item .main-task-header .task-body span {
            font-weight: 700;
            font-size: 1.1rem;
            flex-grow: 1;
            color: var(--text-color);
            transition: color 0.3s ease, text-decoration 0.3s ease;
            min-width: 0;
            word-break: break-word;
            line-height: 1.45;
            padding-top: 1px;
        }

        .todo-item .main-task-header .task-body .task-actions-group {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .todo-item .main-task-header .task-body .task-actions-group .link-button,
        .todo-item .main-task-header .task-body .task-actions-group .google-calendar-button {
            padding-left: 4px;
            padding-right: 4px;
            font-size: 1rem;
        }

        .todo-item .main-task-header .task-body .task-actions-group .google-calendar-button i {
            color: var(--button-color);
            transition: color 0.2s ease;
        }
        .todo-item .main-task-header .task-body .task-actions-group .google-calendar-button:hover i {
            color: var(--button-hover-color);
        }

        .todo-item .main-task-header .task-body .link-button {
            font-size: 1rem;
            opacity: 0.5;
        }
        .todo-item .main-task-header .task-body .link-button.link-on {
            opacity: 1;
        }

        .todo-item .main-task-header .task-body .task-actions-group .delete-button {
             padding: 4px 8px;
             font-size: 1rem;
             margin-left: 6px;
        }


        .todo-item .add-subtasks-toggle {
             display: block;
             width: fit-content;
             margin: 10px 0 0 auto;
             padding: 4px 8px;
             font-size: 1.1rem;
             font-weight: normal;
             color: var(--legend-text-color);
        }
         .todo-item .add-subtasks-toggle:hover {
             color: var(--button-hover-color);
         }

        .todo-item .subtask-input-container {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding: 0;
            align-items: center;
        }
         .todo-item .subtask-input-container button {
             padding: 8px 12px;
             font-size: 1rem;
         }

        .todo-item .subtasks-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            border-left: 2px solid var(--border-color);
            padding-left: 20px;
            transition: border-left-color 0.3s ease;
        }
        .todo-item .subtasks-list li {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            gap: 5px;
        }
         .todo-item .subtasks-list li:last-child {
             margin-bottom: 0;
         }

        .todo-item .subtasks-list li input[type="checkbox"] {
             width: 18px;
             height: 18px;
             border-color: var(--text-color);
             border-radius: 50%; /* Ensure subtask checkboxes are also round */
             appearance: none;
             -webkit-appearance: none;
             background-color: var(--item-bg);
             cursor: pointer;
             position: relative;
             flex-shrink: 0;
             box-sizing: border-box;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
         .todo-item .subtasks-list li input[type="checkbox"]:checked {
              background-color: var(--text-color);
              border-color: var(--text-color);
         }

        .todo-item .subtasks-list li input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            box-sizing: content-box;
            width: 4px;
            height: 8px;
            border: solid var(--checkbox-checkmark-color);
            border-width: 0 1.8px 1.8px 0;
            top: 2.5px;
            left: 5px;
            transform: rotate(45deg);
        }


        .todo-item .subtasks-list li span {
             flex-grow: 1;
             margin-right: 5px;
             color: var(--button-color);
             text-decoration: none;
             transition: color 0.3s ease, text-decoration 0.3s ease;
             word-break: break-word;
             font-size: 0.85em;
             font-weight: 300;
        }
         .todo-item .subtasks-list li .subtask-move-button {
             color: var(--button-color);
             padding: 4px;
             font-size: 0.9rem;
         }
         .todo-item .subtasks-list li .subtask-move-button:hover {
             color: var(--button-hover-color);
         }
         .todo-item .subtasks-list li .subtask-move-button:disabled {
             opacity: 0.3;
             cursor: not-allowed;
             color: var(--button-color);
         }
         .todo-item .subtasks-list li .subtask-move-button:disabled:hover {
             color: var(--button-color);
         }
         .todo-item .subtasks-list li .delete-button {
             padding: 4px 8px;
             font-size: 1rem;
         }

        .todo-item .progress-container {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            margin-top: 15px;
            margin-bottom: 0;
            overflow: hidden;
            background-color: var(--progress-bg);
            transition: background-color 0.3s ease;
        }
        .todo-item .progress-bar {
            height: 100%;
            background-color: var(--progress-bar-color);
            width: 0%;
            transition: width 0.5s ease-in-out, background-color 0.3s ease;
        }
         .todo-item .progress-text { display: none; }

        #todo-list:empty:before {
            content: "No hay tareas. ¡Agrega una!";
            display: block;
            text-align: center;
            color: var(--empty-list-color);
            margin-top: 20px;
            font-style: italic;
            transition: color 0.3s ease;
        }

        .todo-item.show-subtask-ui .subtask-input-container {
             display: flex;
        }
        .todo-item.show-subtask-ui .add-subtasks-toggle {
             display: none;
        }

        .todo-item.completed .main-task-header .task-body span,
        .todo-item.completed .subtasks-list li span {
            color: var(--completed-text-color);
            text-decoration: line-through;
        }
        .todo-item.completed .progress-bar {
            background-color: var(--progress-bar-completed-color);
        }

        .todo-item.completed .priority-color-label,
        .todo-item.completed .subtasks-list li .app-button {
            opacity: 0.7;
            cursor: default;
        }

        .todo-item.completed .main-task-header .task-body .task-actions-group .google-calendar-button {
            opacity: 0.7;
            cursor: default;
            pointer-events: none;
        }
        .todo-item.completed .main-task-header .task-body .task-actions-group .google-calendar-button:hover i {
            color: var(--completed-text-color) !important;
        }


        .todo-item.completed .main-task-header .task-body .task-actions-group .delete-button {
            opacity: 0.7;
        }
        .todo-item.completed .main-task-header .task-body .task-actions-group .delete-button:hover {
            opacity: 0.7;
            color: var(--delete-button-color);
        }

        .todo-item.completed .main-task-header .task-body .link-button.link-on {
            opacity: 0.8;
            cursor: pointer;
        }
        .todo-item.completed .main-task-header .task-body .link-button.link-on:hover {
            color: var(--button-hover-color);
            opacity: 1;
        }
        .todo-item.completed .main-task-header .task-body .link-button.link-off {
            opacity: 0.4;
            cursor: default;
        }
        .todo-item.completed .main-task-header .task-body .link-button.link-off:hover {
            color: var(--button-color);
            opacity: 0.4;
        }

        .todo-item.completed .priority-color-label:hover,
        .todo-item.completed .subtasks-list li .app-button:hover {
            color: inherit;
            text-decoration: none;
            transform: none;
        }


         .todo-item.completed .main-task-header .task-prefix-group .custom-checkbox {
             border-color: var(--completed-text-color);
             background-color: var(--completed-text-color);
         }
         .todo-item.completed .main-task-header .task-prefix-group .custom-checkbox:checked::after {
              border-color: var(--checkbox-checkmark-color) !important;
         }

         #todo-input-container {
             display: flex;
             gap: 10px;
             padding: 0;
             align-items: center;
             margin-bottom: 20px;
             flex-wrap: wrap;
         }
          #todo-input-container label.sr-only { /* Ensure label doesn't affect layout */
              flex-shrink: 0; /* Prevent shrinking, but it's visually hidden anyway */
          }

          #todo-input-container #add-todo-button {
               margin-left: 0;
               padding: 10px 15px;
               font-size: 1.1rem;
          }
          #todo-input-container #reorder-button {
               margin-left: auto;
          }

        #quick-notes-container {
            margin-top: 25px;
            margin-bottom: 50px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #quick-notes-area {
            width: 100%;
            min-height: 70px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'Lexend', sans-serif;
            font-weight: 300;
            font-size: 0.85rem;
            line-height: 1.4;
            background-color: var(--input-bg);
            color: var(--input-text-color);
            box-sizing: border-box;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        #quick-notes-area::placeholder {
            color: var(--placeholder-color);
            opacity: 1;
        }
        #quick-notes-area:focus {
            border-color: var(--button-hover-color);
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.15);
        }
        body.dark-mode #quick-notes-area:focus {
            box-shadow: 0 0 0 2px rgba(243, 156, 18, 0.2);
        }


        #clear-notes-button {
            align-self: flex-end;
            padding: 5px 10px;
            font-size: 0.8rem;
            color: var(--button-color);
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        #clear-notes-button:hover {
            color: var(--button-hover-color);
            border-color: var(--button-hover-color);
            background-color: var(--fixed-button-bg); /* Usa el nuevo fondo para hover en modo día */
        }
        #clear-notes-button i {
            margin-right: 4px;
        }

        #data-management-section {
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        #data-management-section h4 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.2rem;
            color: var(--subtitle-color);
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
        }
        .data-management-intro {
            font-size: 0.85rem;
            color: var(--legend-text-color);
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        .data-options-row {
            display: flex;
            /* CAMBIO SOLICITADO: Centrar los botones en la fila */
            justify-content: center; /* Cambiado de space-around */
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .data-options-row:last-child {
            margin-bottom: 0;
        }

        .data-action-button {
            /* CAMBIO SOLICITADO: Eliminar flex-grow para que no se expandan */
            /* flex-grow: 1; */ /* Elimina o comenta esta línea */
            min-width: 200px; /* Mantiene un tamaño mínimo */
            /* CAMBIO SOLICITADO: Añadir un ancho máximo para que sean más pequeños */
            max-width: 300px; /* Añade esta línea (ajusta el valor si quieres) */
            padding: 9px 15px !important;
            font-size: 0.9rem !important;
            background-color: var(--item-bg); /* Usará #f2eee6 en modo día */
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            color: var(--button-color);
            font-weight: 400;
            border-radius: 6px;
        }
        .data-action-button:hover {
            border-color: var(--button-hover-color) !important;
            background-color: var(--fixed-button-bg); /* Usará #f2eee6 en modo día */
            color: var(--button-hover-color);
        }
        .data-action-button i {
            margin-right: 8px;
            font-size: 0.95em;
        }

        .drive-button-style i.fab.fa-google-drive {
             color: var(--drive-icon-color);
        }
        .drive-button-style:disabled i.fab.fa-google-drive {
            color: inherit;
            opacity: 0.7;
        }
        .drive-button-style:disabled {
            background-color: var(--input-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--placeholder-color) !important;
            opacity: 0.7;
        }


        #info-button {
            position: absolute;
            top: 15px;
            left: 15px;
            font-family: 'Quicksand', sans-serif;
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--button-color);
            background-color: var(--item-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 900;
            line-height: 1;
            padding: 0;
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }
        #info-button:hover {
            color: var(--button-hover-color);
            background-color: var(--fixed-button-bg);
            border-color: var(--button-hover-color);
        }

        footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: var(--footer-text-color);
            margin-top: 30px;
            padding: 20px 10px 15px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
        }
        .footer-logo {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            border-radius: 12px;
        }
        .footer-text {
            margin: 0 0 8px 0;
            color: var(--footer-text-color);
            font-size: 0.85em;
        }

        #support-section-footer {
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .support-intro-text {
            font-size: 0.7rem;
            color: var(--legend-text-color);
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .paypal-link-footer {
            display: inline-flex;
            align-items: center;
            font-size: 0.7rem;
            color: var(--legend-text-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .paypal-link-footer:hover {
            color: var(--button-hover-color);
            text-decoration: underline;
        }

        .paypal-link-footer i.fab.fa-paypal {
            margin-right: 4px;
            font-size: 0.9em;
        }
        .footer-legal-links {
            margin-top: 15px;
            font-size: 0.75em;
        }
        .footer-legal-links a {
            margin: 0 5px;
            color: var(--legend-text-color);
            text-decoration: none;
        }
        .footer-legal-links a:hover {
            text-decoration: underline;
            color: var(--button-hover-color);
        }
        .footer-legal-links span {
            color: var(--legend-text-color);
        }


        @media (max-width: 500px) {
            /* --- AJUSTES LOGO EN H1 PARA MÓVILES --- */
            #page-title { /* Estilos específicos para el logo en móviles */
                height: 70px; /* Altura un poco menor en móviles (ajusta si es necesario) */
                margin-top: 20px; /* Ajusta el margen superior en móviles */
                margin-bottom: 5px; /* Ajusta el margen inferior en móviles */
            }
            /* --- FIN AJUSTES LOGO --- */

            .subtitle {
                font-size: 1rem;
            }
            .app-description-static {
                font-size: 0.85rem;
                /* Keep increased margin for mobile too */
                margin-bottom: 40px;
            }
            #info-button {
                font-size: 1.2rem;
                width: 32px;
                height: 32px;
                top: 10px;
                left: 10px;
            }
            .todo-item .main-task-header {
                row-gap: 8px;
            }

             #todo-input-container #reorder-button {
                  margin-left: 0;
             }
             #data-management-section {
                padding: 15px 10px;
             }
             #data-management-section h4 {
                font-size: 1.1rem;
             }
            .data-management-intro {
                font-size: 0.8rem;
                margin-bottom: 15px;
            }
             .data-options-row {
                flex-direction: column;
                align-items: stretch; /* Esto hace que vuelvan a ocupar todo el ancho en móviles */
                gap: 10px;
            }
            .data-action-button {
                min-width: unset;
                width: 100%; /* Esto los hace ocupar el 100% del ancho en móviles */
                /* CAMBIO SOLICITADO: Asegurar que no estén limitados por el max-width de escritorio en móvil */
                max-width: unset; /* Añade esta línea */
                margin-bottom: 0;
            }



             #welcome-section h2 {
                 font-size: 1.5rem;
             }
             #welcome-section p {
                 font-size: 0.9rem;
                 /* Default margin for paragraphs in welcome section */
                 margin-bottom: 15px; /* Kept original value for other paragraphs */
             }
             /* MODIFIED: Keep increased space specifically after the first paragraph for mobile */
             #welcome-section p:first-of-type {
                 margin-bottom: 40px; /* Increased from 15px */
             }
             #welcome-section ul li {
                 font-size: 0.85rem;
             }
             #start-app-button {
                padding: 10px 20px;
                font-size: 1rem;
            }

            #install-instructions-section {
                padding: 15px 18px;
                font-size: 0.8rem;
            }
            #install-instructions-section h4 {
                font-size: 1.1rem;
            }
            #install-instructions-section ul li {
                font-size: 0.95em;
                padding-left: 22px;
                margin-bottom: 7px;
            }
            #install-instructions-section ul li::before {
                top: 0px;
                font-size: 1em;
            }

            footer {
                font-size: 0.75rem;
                padding-top: 15px;
            }
            .footer-logo {
                width: 40px;
                height: 40px;
                margin-bottom: 8px;
            }
            .footer-text {
                margin-bottom: 6px;
                font-size: 0.9em;
            }
            .support-intro-text,
            .paypal-link-footer {
                font-size: 0.7em;
            }
            .support-intro-text {
                margin-bottom: 2px;
            }
            .footer-legal-links {
                font-size: 0.7em;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            padding-top: 60px;
            box-sizing: border-box;
             /* ADDED ARIA attributes for accessibility */
            role="dialog"
            aria-modal="true"
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .modal-content {
            background-color: var(--item-bg);
            color: var(--text-color);
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 380px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            box-sizing: border-box;
        }
        #info-modal .modal-content {
            max-width: 580px;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--heading-color);
            text-align: center;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.8rem;
        }

        #reminder-modal .modal-content h2 {
            color: var(--accent-color);
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
        }
         /* ADDED ID for ARIA-labelledby */
        #reminder-modal .modal-content h2#reminder-modal-title { }


        #reminder-modal p#reminder-task-text {
            text-align: center;
            font-style: italic;
            margin: 0 auto 20px auto;
            word-break: break-word;
            color: var(--text-color);
            font-size: 0.85rem;
            font-weight: normal;
            max-width: 90%;
        }

        .modal-input-group {
            margin: 15px auto;
            width: fit-content;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 0;
            font-weight: bold;
            color: var(--text-color);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .modal-input-group input[type="date"],
        .modal-input-group input[type="time"] {
            width: 130px;
            padding: 8px;
            border: 1px solid var(--modal-input-border-color);
            border-radius: 4px;
            background-color: var(--modal-input-background-color);
            color: var(--input-text-color);
            font-size: 0.85rem;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            font-family: 'Lexend', sans-serif;
        }

        .modal-input-group input[type="date"]:focus,
        .modal-input-group input[type="time"]:focus {
            border-color: var(--button-hover-color);
            box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
        }
        body.dark-mode .modal-input-group input[type="date"]:focus,
        body.dark-mode .modal-input-group input[type="time"]:focus {
             box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.2);
        }

        #schedule-reminder-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 25px auto 5px auto;
            padding: 10px;
            background: none !important;
            border: none !important;
            color: var(--schedule-link-text-color) !important;
            text-decoration: underline !important;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            transition: color 0.2s ease;
            box-shadow: none !important;
        }
        #schedule-reminder-button:hover {
            color: var(--schedule-link-hover-text-color) !important;
            background: none !important;
        }
        #schedule-reminder-button:disabled {
            color: var(--schedule-link-disabled-text-color) !important;
            text-decoration: none !important;
            cursor: not-allowed;
            opacity: 0.7 !important;
        }

        .modal-content ol {
            padding-left: 20px;
            margin-bottom: 0;
            text-align: left;
        }
        .modal-content ol li {
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .modal-content ol li ul {
            padding-left: 20px;
            margin-top: 8px;
            list-style-type: disc;
        }
        .modal-content ol li ul li {
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .modal-content strong {
            color: var(--heading-color);
        }
        .modal-content i.fas, .modal-content i.far, .modal-content i.fab {
            color: var(--button-hover-color);
            margin: 0 2px;
            font-size: 0.9em;
        }

        div.modal-overlay div.modal-content > button.close-modal {
            position: absolute !important;
            top: 10px !important;
            right: 10px !important;
            left: auto !important;
            bottom: auto !important;
            transform: none !important;
            margin: 0 !important;
            font-size: 1.4rem;
            color: var(--button-color);
            padding: 2px 5px !important;
            line-height: 1;
            background: none !important;
            border: none !important;
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 10 !important;
            box-shadow: none !important;
        }
        div.modal-overlay div.modal-content > button.close-modal:hover {
            color: var(--button-hover-color) !important;
            background: none !important;
        }


        @media (max-width: 500px) {

            .modal-overlay {
                padding-top: 20px;
            }
            .modal-content {
                padding: 20px 25px;
                max-height: 90vh;
                max-width: 95%;
                width: 95%;
            }
            .modal-content h2 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            #reminder-modal .modal-content h2 {
                 font-size: 1.1rem;
            }
            #reminder-modal p#reminder-task-text {
                font-size: 0.85rem;
                margin-bottom: 15px;
            }
            .modal-input-group {
                margin-bottom: 10px;
                gap: 8px;
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
             .modal-input-group label {
                 width: 100%;
                 text-align: left;
             }
            .modal-input-group input[type="date"],
            .modal-input-group input[type="time"] {
                padding: 6px;
                font-size: 0.85rem;
                width: 100%;
            }
            #schedule-reminder-button {
                padding: 8px;
                font-size: 0.9rem;
                max-width: 100%;
            }

            .modal-content ol li {
                font-size: 0.9em;
                margin-bottom: 10px;
            }
            .modal-content ol li ul li {
                font-size: 0.9em;
                margin-bottom: 6px;
            }
            div.modal-overlay div.modal-content > button.close-modal {
                font-size: 1.2rem !important;
                top: 6px !important;
                right: 8px !important;
                padding: 2px 4px !important;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <button id="info-button" class="app-button" aria-label="Información de la aplicación" title="Cómo usar la aplicación">
            i
        </button>
        <!-- Título cambiado para mostrar el logo -->
        <h1 id="page-title" aria-label="ToDayList Logo">ToDayList</h1>
        <h2 class="subtitle">Tu Gestor de Tareas Diarias</h2> <!-- Kept for keyword relevance -->
        <p class="app-description-static">
            Organiza tu día y aumenta tu productividad de forma sencilla y eficaz.
        </p>

        <section id="welcome-section" class="hidden">
            <img src="https://www.todaylist.es/ToDayList.png" alt="ToDayList Icono" class="welcome-icon">
            <h2>¡Bienvenido a ToDayList!</h2>
            <!-- MODIFIED: Updated the first paragraph with the new text -->
            <p>
                ¿Te cuesta empezar? ToDayList convierte tus tareas en pequeñas victorias. Menos caos, más control… y el placer de avanzar sin esfuerzo. Adiós a la procrastinación, hola a la productividad.
            </p>
            <ul>
                <li><strong>Gestión Intuitiva de Tareas:</strong> Crea, edita y organiza tus tareas fácilmente.</li>
                <li><strong>Subtareas Detalladas:</strong> Desglosa tareas complejas en pasos manejables.</li>
                <li><strong>Prioridades Visuales:</strong> Asigna colores para enfocarte en lo importante.</li>
                <li><strong>Agendar en Google Calendar:</strong> Genera un enlace para añadir recordatorios de tus tareas directamente a tu Google Calendar.</li>
                <li><strong>Enlaces Relevantes:</strong> Asocia URLs directamente a tus tareas.</li>
                <li><strong>Modo Oscuro/Claro:</strong> Adapta la interfaz a tus preferencias visuales (oscuro por defecto).</li>
                <li><strong>Progreso y Motivación:</strong> Visualiza el avance y gana medallas por completar tareas.</li>
                <li><strong>Exportación e Importación de Datos:</strong> Realiza copias de seguridad o transfiere tus datos (local o Google Drive).</li>
                <li><strong>Anotaciones Rápidas:</strong> Un espacio para tomar notas sin crear una tarea formal.</li>
            </ul>
            <p>
                ¡Comienza a organizar tu día ahora!
            </p>
            <button id="start-app-button" class="app-button">Empezar a Organizar</button>
        </section>

        <section id="install-instructions-section" class="hidden">
            <h4>¡Acceso Rápido a ToDayList!</h4>
            <p>Guarda ToDayList en tu dispositivo para acceder como una app:</p>
            <ul>
                <li><strong>Chrome (Escritorio):</strong> Clic en el icono <i class="fas fa-download" title="Instalar"></i> en la barra de direcciones, o Menú (<i class="fas fa-ellipsis-v"></i>) &rarr; "Instalar ToDayList".</li>
                <li><strong>Android (Chrome):</strong> Menú (<i class="fas fa-ellipsis-v"></i>) &rarr; "Instalar aplicación" o "Añadir a pantalla de inicio".</li>
                <li><strong>iPhone/iPad (Safari):</strong> Icono Compartir (<i class="fas fa-share-square" title="Compartir"></i>) &rarr; "Añadir a pantalla de inicio".</li>
                <li><strong>Mac (Safari):</strong> Desde el menú "Archivo" &rarr; "Añadir al Dock".</li>
            </ul>
        </section>

        <div id="app-main-interface" class="hidden">
            <div id="medal-counter-container">
                <i class="fas fa-medal"></i> <span id="medal-count">0</span>
            </div>

            <ul id="todo-list"></ul>
            <div id="todo-input-container">
                <!-- ADDED: Visually hidden label for accessibility -->
                <label for="new-todo-input" class="sr-only">Agregar nueva tarea</label>
                <input type="text" id="new-todo-input" placeholder="Agregar nueva tarea...">
                <button id="add-todo-button" class="app-button add-button" aria-label="Agregar Tarea"><i class="fas fa-plus"></i></button>
                <button id="reorder-button" class="app-button sort-button" aria-label="Reordenar Tareas"><i class="fas fa-sort-amount-down-alt"></i></button>
            </div>
            <div id="priority-legend">
                Prioridad:
                <span class="priority-legend-item"><span class="priority-color-label" data-color="red"></span>Urgente</span>
                &gt;
                <span class="priority-legend-item"><span class="priority-color-label" data-color="orange"></span>Alta</span>
                &gt;
                <span class="priority-legend-item"><span class="priority-color-label" data-color="yellow"></span>No Olvidar</span>
                &gt;
                <span class="priority-legend-item"><span class="priority-color-label" data-color="green"></span>Puede Esperar</span>
            </div>

            <div id="quick-notes-container">
                 <!-- ADDED: Visually hidden label for accessibility -->
                <label for="quick-notes-area" class="sr-only">Anotaciones rápidas</label>
                <textarea id="quick-notes-area" placeholder="Anotaciones rápidas..."></textarea>
                <button id="clear-notes-button" class="app-button" aria-label="Borrar anotaciones">
                    <i class="fas fa-eraser"></i> Borrar
                </button>
            </div>

            <div id="data-management-section">
                <h4>Gestión de Datos</h4>
                <p class="data-management-intro">
                    Guarda tus tareas para usarlas en otros dispositivos o como copia de seguridad.
                    Puedes exportar/importar un archivo local o usar tu Google Drive.
                </p>
                <div id="export-options-container" class="data-options-row">
                    <button id="export-data-button" class="app-button data-action-button" aria-label="Exportar datos locales">
                        <i class="fas fa-file-export"></i> Exportar Local
                    </button>
                    <button id="export-drive-button" class="app-button data-action-button drive-button-style" aria-label="Exportar a Google Drive" disabled>
                        <i class="fab fa-google-drive"></i> Exportar a Drive
                    </button>
                </div>
                <div id="import-options-container" class="data-options-row">
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    <button id="import-data-button" class="app-button data-action-button" aria-label="Importar datos locales">
                        <i class="fas fa-file-import"></i> Importar Local
                    </button>
                    <button id="import-drive-button" class="app-button data-action-button drive-button-style" aria-label="Importar desde Google Drive" disabled>
                        <i class="fab fa-google-drive"></i> Importar de Drive
                    </button>
                </div>
            </div>

        </div> <!-- Fin de #app-main-interface -->

    </div> <!-- Fin de .container -->

    <!-- Modal para agendar recordatorio -->
    <!-- ADDED ARIA attributes -->
    <div id="reminder-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="reminder-modal-title">
        <div class="modal-content">
            <button class="app-button close-modal" id="close-reminder-modal" aria-label="Cerrar ventana de recordatorio">×</button>
             <!-- ADDED ID for ARIA-labelledby -->
            <h2 id="reminder-modal-title">Agendar Recordatorio</h2>
            <p id="reminder-task-text"></p>
            <div class="modal-input-group">
                <label for="reminder-date">Fecha:</label>
                <input type="date" id="reminder-date" required>
            </div>
            <div class="modal-input-group">
                <label for="reminder-time">Hora:</label>
                <input type="time" id="reminder-time" value="09:00" required>
            </div>
            <button id="schedule-reminder-button" class="app-button">Mandar a Google Calendar</button>
        </div>
    </div>

    <!-- Modal para información/instrucciones -->
    <!-- ADDED ARIA attributes -->
    <div id="info-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
        <div class="modal-content">
            <button id="close-modal-button" class="app-button close-modal" aria-label="Cerrar ventana de información">×</button>
             <!-- ADDED ID for ARIA-labelledby -->
            <h2 id="info-modal-title">Cómo usar ToDayList</h2>
            <ol>
                <li><strong>Añadir Tareas:</strong> Escribe tu tarea en el campo inferior y pulsa el botón <i class="fas fa-plus"></i> o la tecla "Enter".</li>
                <li><strong>Marcar como Completada:</strong> Haz clic en el círculo a la izquierda de la tarea. ¡Ganas una medalla <i class="fas fa-medal"></i> por cada tarea completada en el día!</li>
                <li><strong>Prioridad:</strong> Haz clic en el cuadrado de color junto al círculo para cambiar la prioridad de la tarea (Rojo: Urgente &gt; Naranja: Alta &gt; Amarillo: No Olvidar &gt; Verde: Puede Esperar &gt; Gris: Sin prioridad).</li>
                <li><strong>Agendar en Google Calendar:</strong> Haz clic en el icono de calendario <i class="far fa-calendar-plus"></i> para que se abra Google Calendar con los detalles de la tarea. Introduce la fecha/hora deseada y guarda el evento en tu calendario.</li>
                <li><strong>Enlaces:</strong> Haz clic en el icono de enlace <i class="fas fa-link"></i> para añadir o abrir un enlace web asociado a la tarea.</li>
                <li><strong>Sub-Tareas:</strong>
                    <ul>
                        <li>Pulsa el botón <i class="fas fa-plus"></i> (pequeño, a la derecha de la tarea principal, debajo de la barra de progreso) para añadir sub-tareas.</li>
                        <li>Una vez añadida una sub-tarea, el campo de texto se ocultará. Pulsa el botón <i class="fas fa-plus"></i> de nuevo si deseas añadir más.</li>
                        <li>Las sub-tareas tienen su propio círculo para marcarlas como completadas, botones para moverlas <i class="fas fa-arrow-up"></i><i class="fas fa-arrow-down"></i>, o eliminarlas <i class="fas fa-trash-alt"></i>.</li>
                    </ul>
                </li>
                <li><strong>Barra de Progreso:</strong> Indica el porcentaje de sub-tareas completadas. Se llena al 100% cuando la tarea principal se marca como completada.</li>
                <li><strong>Reordenar Tareas:</strong> Pulsa el botón de reordenar <i class="fas fa-sort-amount-down-alt"></i> para organizar automáticamente todas las tareas por prioridad (de más a menos urgente) y luego por fecha (las más antiguas primero, si tienen).</li>
                <li><strong>Modo Oscuro/Claro:</strong> Utiliza el botón <i class="fas fa-moon"></i> / <i class="fas fa-sun"></i> situado abajo a la derecha para cambiar el tema visual de la aplicación (oscuro por defecto).</li>
                <li><strong>Eliminar Tareas:</strong> Haz clic en el icono de papelera <i class="fas fa-trash-alt"></i> para eliminar tareas principales o sub-tareas.</li>
                <li><strong>Anotaciones Rápidas:</strong> Utiliza el área para notas temporales.</li>
                <li><strong>Exportar/Importar Datos:</strong> Usa los botones "Exportar Local" e "Importar Local" para guardar/restaurar datos desde un archivo en tu dispositivo. Usa "Exportar a Drive" e "Importar de Drive" para usar tu Google Drive. <strong>¡Atención!</strong> Importar reemplazará los datos actuales.</li>
            </ol>
        </div>
    </div>


    <footer>
        <img src="https://www.todaylist.es/ToDayList.png" alt="Logo ToDayList" class="footer-logo">
        <p class="footer-text">WebApp creada por Henry Gil</p>

        <div id="support-section-footer">
            <p class="support-intro-text">¿Te gusta ToDayList? Si te ha sido útil...</p>
            <a href="https://paypal.me/todaylistHenry" target="_blank" rel="noopener noreferrer" class="paypal-link-footer">
                <i class="fab fa-paypal"></i> Apoya este proyecto
            </a>
        </div>
        <div class="footer-legal-links">
            <a href="privacy-policy.html" target="_blank" rel="noopener noreferrer">Política de Privacidad</a>
            <span>|</span>
            <a href="terms-of-service.html" target="_blank" rel="noopener noreferrer">Condiciones del Servicio</a>
        </div>
    </footer>

    <button id="dark-mode-toggle" class="app-button" aria-label="Alternar modo oscuro/claro"><i class="fas fa-moon"></i></button>


    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <script async defer src="https://apis.google.com/js/api.js" onload="if(window.googleApiCallbacks && typeof window.googleApiCallbacks.gapiLoaded === 'function') { window.isGoogleGapiScriptReady = true; window.googleApiCallbacks.gapiLoaded(); } else { console.error('googleApiCallbacks.gapiLoaded no definido'); }"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="if(window.googleApiCallbacks && typeof window.googleApiCallbacks.gisLoaded === 'function') { window.isGoogleGisScriptReady = true; window.googleApiCallbacks.gisLoaded(); } else { console.error('googleApiCallbacks.gisLoaded no definido'); }"></script>

    <script type="module">
        let todoInput;
        let addTodoButton;
        let todoListContainer;
        let reorderButton;
        let darkModeToggle;
        let body;
        let medalCountDisplay;
        let infoButton, infoModal, closeModalButton;

        let quickNotesArea;
        let clearNotesButton;
        const QUICK_NOTES_STORAGE_KEY = 'todoListQuickNotes';

        let exportDataButton;
        let importDataButton;
        let importFileInput;

        let exportDriveButton;
        let importDriveButton;

        const CLIENT_ID = '25607067695-mgv7jfvio4vr1goi5ci6o952mgpii8nf.apps.googleusercontent.com';
        // CORRECTED: Updated API_KEY with the correct value provided by the user
        const API_KEY = 'AIzaSyAhr2kqUcRf5qZi0yMHsFDsyp_x8Ekfj7k';

        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        let welcomeSection;
        let startAppButton;
        let appMainInterface;
        let installInstructionsSection;

        let todos = [];

        const TODOS_STORAGE_KEY = 'todoListAppTasks';
        const MEDALS_STORAGE_KEY = 'todoListDailyMedalData';
        const THEME_STORAGE_KEY = 'todoListTheme';

        const PRIORITY_COLORS = ['none', 'red', 'orange', 'yellow', 'green'];
        const PRIORITY_ORDER = { 'red': 1, 'orange': 2, 'yellow': 3, 'green': 4, 'none': 5 };

        let reminderModal;
        let closeReminderModalButton;
        let reminderTaskTextElement;
        let reminderDateInput;
        let reminderTimeInput;
        let scheduleReminderButton;
        let currentTaskIdForReminder = null;

        window.googleApiCallbacks = {
            gisLoaded: function() {
                console.log("SCRIPT.JS MODULE: googleApiCallbacks.gisLoaded called");
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                    console.error("Objeto 'google.accounts.oauth2' no encontrado. GIS no cargó correctamente (for Drive).");
                    if (window.isGoogleGisScriptReady && !gisInited) {
                        console.log("Retrying GIS init in 100ms as google object might not be fully ready.");
                        setTimeout(window.googleApiCallbacks.gisLoaded, 100);
                    }
                    return;
                }
                if (gisInited) {
                    console.log("SCRIPT.JS MODULE: GIS already initialized.");
                    return;
                }
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: '',
                    });
                    gisInited = true;
                    console.log("Google Identity Services (GIS) loaded and initialized (for Drive).");
                    maybeEnableDriveButtons();
                } catch (e) {
                    console.error("Error inicializando Google Identity Services (GIS for Drive):", e);
                }
            },
            gapiLoaded: function() {
                console.log("SCRIPT.JS MODULE: googleApiCallbacks.gapiLoaded called");
                if (typeof gapi === 'undefined' || !gapi.load) {
                    console.error("Objeto 'gapi' no encontrado. Google API Client no cargó correctamente (for Drive).");
                     if (window.isGoogleGapiScriptReady && !gapiInited) {
                        console.log("Retrying GAPI init in 100ms as gapi object might not be fully ready.");
                        setTimeout(window.googleApiCallbacks.gapiLoaded, 100);
                    }
                    return;
                }
                if (gapiInited) {
                    console.log("SCRIPT.JS MODULE: GAPI already initialized.");
                    return;
                }
                try {
                    gapi.load('client:picker', () => {
                        gapiInited = true;
                        console.log("Google API Client (gapi) and Picker loaded (for Drive).");
                        maybeEnableDriveButtons();
                    });
                } catch (e) {
                    console.error("Error cargando gapi client:picker (for Drive):", e);
                }
            }
        };

        function maybeEnableDriveButtons() {
            if (gapiInited && gisInited) {
                if (exportDriveButton) exportDriveButton.disabled = false;
                if (importDriveButton) importDriveButton.disabled = false;
                console.log("Google Drive buttons enabled.");
            } else {
                console.log("Google APIs (for Drive) not fully loaded yet. gapiInited:", gapiInited, "gisInited:", gisInited);
                if (exportDriveButton) exportDriveButton.disabled = true;
                if (importDriveButton) importDriveButton.disabled = true;
            }
        }

        function handleAuthClick(callbackFn, ...args) {
            if (!gisInited || !tokenClient) {
                alert("Los servicios de autenticación de Google (para Drive) no están listos. Intenta recargar la página.");
                console.error("tokenClient o GIS no están inicializados en handleAuthClick (for Drive).");
                return;
            }
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("Error de autenticación de Google (for Drive):", resp);
                    if (resp.error !== 'popup_closed_by_user' && resp.error !== 'access_denied') {
                        alert("Error de autenticación con Google (para Drive): " + (resp.error_description || resp.error || "Desconocido"));
                    }
                    return;
                }
                console.log("Autenticación con Google (para Drive) exitosa o token refrescado.");

                if (gapi && gapi.client) {
                    gapi.client.setToken(resp);
                } else {
                    console.error("gapi.client no está disponible para setToken (for Drive).");
                    alert("Error: El cliente API de Google (para Drive) no está listo.");
                    return;
                }

                if (callbackFn) {
                    try {
                        await callbackFn(...args);
                    } catch (callbackError) {
                        console.error("Error en la función callback después de la autenticación (for Drive):", callbackError);
                        alert("Ocurrió un error al procesar tu solicitud después de la autenticación (para Drive).");
                    }
                }
            };

            if (gapi && gapi.client && gapi.client.getToken && gapi.client.getToken() !== null) {
                tokenClient.requestAccessToken({prompt: ''});
            } else {
                tokenClient.requestAccessToken({prompt: 'consent'});
            }
        }

        async function ensureDriveClientLoaded() {
            if (gapi && gapi.client && gapi.client.drive) {
                return Promise.resolve();
            }
            console.log("Cliente de Google Drive API no cargado, cargando ahora...");
            return new Promise((resolve, reject) => {
                if (!gapi || !gapi.client || !gapi.client.load) {
                    return reject(new Error("gapi.client.load no está disponible (for Drive)."));
                }
                try {
                    gapi.client.load('drive', 'v3', () => {
                        console.log("Google Drive API client cargado exitosamente.");
                        resolve();
                    });
                } catch (e) {
                    reject(e);
                }
            });
        }

        async function exportToGoogleDrive() {
            if (!gisInited || !gapiInited || !gapi.client.getToken || !gapi.client.getToken()) {
                 alert("Por favor, conéctate con Google Drive primero.");
                 handleAuthClick(exportToGoogleDrive);
                 return;
            }
            try {
                await ensureDriveClientLoaded();
                const dataToExport = {
                    theme: localStorage.getItem(THEME_STORAGE_KEY) || 'dark',
                    dailyMedalData: JSON.parse(localStorage.getItem(MEDALS_STORAGE_KEY) || '{}'),
                    quickNotesContent: localStorage.getItem(QUICK_NOTES_STORAGE_KEY) || '',
                    tasks: todos
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
                const fileName = `todaylist_backup_${dateStr}.json`;

                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    'name': fileName,
                    'mimeType': 'application/json; charset=UTF-8',
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                    jsonString +
                    close_delim;

                const request = gapi.client.request({
                    'path': '/upload/drive/v3/files',
                    'method': 'POST',
                    'params': {'uploadType': 'multipart'},
                    'headers': {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    'body': multipartRequestBody
                });

                const response = await request;

                if (response && response.result && response.result.id) {
                    alert('¡Datos exportados a Google Drive con éxito como ' + fileName + '!');
                } else {
                    console.error('Error al exportar a Drive: Respuesta inesperada.', response);
                    alert('Error al exportar a Drive: Respuesta inesperada. Revisa la consola.');
                }

            } catch (error) {
                console.error('Error exportando a Google Drive:', error);
                alert('Error al exportar datos a Google Drive: ' + (error.message || (error.result && error.result.error && error.result.error.message) || "Error desconocido."));
            }
        }

        function loadPicker(callbackFn) {
            if (typeof google !== 'undefined' && google.picker) {
                 if (callbackFn) callbackFn();
            } else {
                console.error("Google Picker API no está cargada (for Drive).");
                alert("Error: La API de selección de archivos de Google (para Drive) no está lista.");
            }
        }

        function importFromGoogleDrive() {
            if (!gisInited || !gapiInited || !gapi.client.getToken || !gapi.client.getToken()) {
                alert("Por favor, conéctate con Google Drive primero.");
                handleAuthClick(importFromGoogleDrive);
                return;
            }
            loadPicker(() => {
                try {
                    const oauthToken = gapi.client.getToken().access_token;
                    if (!oauthToken) {
                        alert("No se pudo obtener el token de acceso (para Drive).");
                        handleAuthClick(importFromGoogleDrive);
                        return;
                    }
                    const view = new google.picker.View(google.picker.ViewId.DOCS);
                    view.setMimeTypes("application/json");
                    const picker = new google.picker.PickerBuilder()
                        .setAppId(null) // Assuming no specific app ID registration beyond client ID
                        .setOAuthToken(oauthToken)
                        .addView(view)
                        .setDeveloperKey(API_KEY)
                        .setCallback(pickerCallback)
                        .build();
                    picker.setVisible(true);
                } catch (e) {
                    console.error("Error al construir/mostrar Google Picker (for Drive):", e);
                    alert("Error al abrir el selector de archivos de Google Drive: " + e.message);
                }
            });
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED && data.docs && data.docs.length > 0) {
                const fileId = data.docs[0].id;
                const fileName = data.docs[0].name;
                try {
                    await ensureDriveClientLoaded();
                    const response = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });
                    if (typeof response.body !== 'string') {
                        alert("Error: El formato del archivo descargado de Drive es incorrecto.");
                        return;
                    }
                    const importedData = JSON.parse(response.body);
                    if (!confirm(`¡Atención! Importar "${fileName}" desde Google Drive reemplazará todos los datos actuales. ¿Deseas continuar?`)) {
                        return;
                    }
                    applyImportedData(importedData, `Google Drive (${fileName})`);
                } catch (error) {
                    console.error('Error importando desde Google Drive:', error);
                    alert('Error al importar datos desde Google Drive: ' + (error.message || (error.result && error.result.error && error.result.error.message) || "Error desconocido."));
                }
            }
             else if (data.action === google.picker.Action.CANCEL) {
                console.log("Selección de archivo de Google Drive cancelada por el usuario.");
            } else if (data.action === google.picker.Action.ERROR ) {
                 console.error("Error en Google Picker:", data);
                 alert("Ocurrió un error con el selector de archivos de Google Drive.");
            } else if ((!data.docs || data.docs.length === 0) && data.action !== google.picker.Action.CANCEL) {
                console.log("Ningún archivo seleccionado en Google Picker o acción desconocida.");
            }
        }

        function getTodayDateString(format = 'yyyy-mm-dd') {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            if (format === 'dd-mm-yyyy') {
                return `${dd}-${mm}-${yyyy}`;
            }
            return `${yyyy}-${mm}-${dd}`;
        }

        function showReminderModal(taskId) {
            const task = findTaskById(taskId);
            if (!task || task.completed) {
                return;
            }

            currentTaskIdForReminder = taskId;
            reminderTaskTextElement.textContent = `Tarea: "${task.text}"`;
            const todayForInput = getTodayDateString('yyyy-mm-dd');
            reminderDateInput.value = todayForInput;
            reminderTimeInput.value = "09:00";
            reminderModal.classList.add('visible');
             // ADDED: Set focus when modal opens
            requestAnimationFrame(() => reminderDateInput.focus());
        }

        function hideReminderModal() {
            reminderModal.classList.remove('visible');
            currentTaskIdForReminder = null;
            reminderTaskTextElement.textContent = '';
             // ADDED: Return focus to the button that opened the modal (basic implementation)
             const lastFocusedButton = document.querySelector(`button[data-task-id="${currentTaskIdForReminder}"] .google-calendar-button`); // This selector might need adjustment
             if (lastFocusedButton) {
                 lastFocusedButton.focus();
             }
        }

        function handleScheduleReminderClick(event) {
            if (event) event.stopPropagation();

            if (!currentTaskIdForReminder) return;

            const dateStrInput = reminderDateInput.value;
            const timeStr = reminderTimeInput.value;

            if (!dateStrInput || !timeStr) {
                alert("Por favor, selecciona una fecha y hora.");
                return;
            }

            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStrInput)) {
                alert("Formato de fecha inválido. Usa el selector de calendario.");
                return;
            }
            if (!/^\d{2}:\d{2}$/.test(timeStr)) {
                alert("Formato de hora inválido. Usa el selector de hora.");
                return;
            }

            const task = findTaskById(currentTaskIdForReminder);
            if (!task) {
                alert("Error: Tarea no encontrada.");
                hideReminderModal();
                return;
            }

            const summary = task.text;
            const dateParts = dateStrInput.split('-');
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10);
            const day = parseInt(dateParts[2], 10);
            const [hours, minutes] = timeStr.split(':').map(Number);

             if (month < 1 || month > 12 || day < 1 || day > 31 || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                 alert("Fecha u hora inválida. Verifica los valores.");
                 return;
             }

            const startDate = new Date(year, month - 1, day, hours, minutes);
            if (isNaN(startDate.getTime()) || startDate.getDate() !== day || startDate.getMonth() !== month - 1 || startDate.getFullYear() !== year) {
                alert("La fecha ingresada no es válida (ej. 31 de Febrero).");
                return;
            }

            const endDate = new Date(startDate.getTime() + 60 * 60000);

            const formatDateForGoogle = (dateObj) => {
                if (isNaN(dateObj.getTime())) {
                     console.error("Fecha inválida proporcionada a formatDateForGoogle");
                     return '';
                }
                // Google Calendar API expects RFC3339, but render=template often uses a simplified format or requires UTC/Z
                // Let's format in local time first for simplicity with the template URL
                 const year = dateObj.getFullYear();
                 const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                 const day = String(dateObj.getDate()).padStart(2, '0');
                 const hours = String(dateObj.getHours()).padStart(2, '0');
                 const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                 const seconds = String(dateObj.getSeconds()).padStart(dateObj.getSeconds() === 0 ? 2 : 0, '0'); // Pad seconds only if 0

                // For the template URL, YYMMDDTHHMMSS or YYYYMMDDTHHMMSSZ (for UTC) are common formats.
                // Let's use YYYYMMDDTHHMMSS for local time as it's simpler with template.
                return `${year}${month}${day}T${hours}${minutes}${seconds}`;
            };

            const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('Recordatorio ToDayList: ' + summary)}&dates=${formatDateForGoogle(startDate)}/${formatDateForGoogle(endDate)}&details=${encodeURIComponent('Recordatorio para la tarea: "' + summary + '" de tu ToDayList.')}&sprop=name:ToDayList&sprop=website:${encodeURIComponent(window.location.href)}`;
            window.open(googleCalendarUrl, '_blank');

            const listItemElement = todoListContainer.querySelector(`li[data-task-id="${task.id}"]`);
            if (listItemElement) {
                const calButton = listItemElement.querySelector('.google-calendar-button i');
                if (calButton) {
                    calButton.style.color = 'var(--accent-color)'; // Keep accent color after scheduling attempt
                    const displayDate = `${String(day).padStart(2,'0')}-${String(month).padStart(2,'0')}-${year}`;
                    calButton.parentElement.title = `Se intentó agendar un recordatorio: ${displayDate} ${timeStr}. Confirma en Google Calendar.`;
                }
            }
            hideReminderModal();
        }


        function generateLocalId() {
            return '_' + Math.random().toString(36).substring(2, 15);
        }

        function findTaskById(taskId) {
            return todos.find(todo => todo.id === taskId);
        }

        function findTaskIndexById(taskId) {
            return todos.findIndex(todo => todo.id === taskId);
        }

        function displayMedalCount(count) {
            if (medalCountDisplay) {
                medalCountDisplay.textContent = count;
            }
        }

        function loadTodosFromLocalStorage() {
            const storedTodos = localStorage.getItem(TODOS_STORAGE_KEY);
            if (storedTodos) {
                todos = JSON.parse(storedTodos);
                todos = todos.map(task => ({
                    id: task.id || generateLocalId(),
                    text: task.text || 'Tarea sin nombre',
                    completed: typeof task.completed === 'boolean' ? task.completed : false,
                    completedDate: task.completedDate || null,
                    subtasks: Array.isArray(task.subtasks) ? task.subtasks.map(sub => ({
                        id: sub.id || generateLocalId(), text: sub.text || 'Sub-tarea sin nombre',
                        completed: typeof sub.completed === 'boolean' ? sub.completed : false
                    })) : [],
                    showSubtaskUI: typeof task.showSubtaskUI === 'boolean' ? task.showSubtaskUI : false,
                    priorityColor: PRIORITY_COLORS.includes(task.priorityColor) ? task.priorityColor : 'none',
                    date: (typeof task.date === 'string' && task.date.match(/^\d{4}-\d{2}-\d{2}$/)) ? task.date : null,
                    linkUrl: typeof task.linkUrl === 'string' ? task.linkUrl : null,
                    order: typeof task.order === 'number' ? task.order : Date.now()
                }));
            } else {
                todos = [];
            }
        }

        function saveTodosToLocalStorage() {
            localStorage.setItem(TODOS_STORAGE_KEY, JSON.stringify(todos));
        }


        function loadAndRefreshMedalData() {
            let medalDataString = localStorage.getItem(MEDALS_STORAGE_KEY);
            let medalData;
            try {
                medalData = medalDataString ? JSON.parse(medalDataString) : null;
            } catch (e) {
                console.error("Error parsing medal data from localStorage", e);
                medalData = null;
            }

            const todayForMedal = getTodayDateString('yyyy-mm-dd');

            if (!medalData || medalData.date !== todayForMedal) {
                let countForToday = 0;
                if (todos && todos.length > 0) {
                    todos.forEach(task => {
                        if (task.completed && task.completedDate === todayForMedal) countForToday++;
                    });
                }
                medalData = { date: todayForMedal, count: countForToday };
                localStorage.setItem(MEDALS_STORAGE_KEY, JSON.stringify(medalData));
            }
            return medalData;
        }

        function updateMedalCount(change) {
            let medalData = loadAndRefreshMedalData();
            medalData.count += change;
            if (medalData.count < 0) medalData.count = 0;
            localStorage.setItem(MEDALS_STORAGE_KEY, JSON.stringify(medalData));
            displayMedalCount(medalData.count);
        }

        function syncAndRender() {
            renderTodosUI();
        }

        function calculateSubtaskProgress(subtasks) {
            if (!subtasks || subtasks.length === 0) return 0;
            const completed = subtasks.filter(sub => sub.completed).length;
            return (completed / subtasks.length) * 100;
        }

        function createMainTaskHeader(mainTask) {
            const mainTaskHeader = document.createElement('div');
            mainTaskHeader.classList.add('main-task-header');

            const taskPrefixGroup = document.createElement('div');
            taskPrefixGroup.classList.add('task-prefix-group');

            const mainCheckbox = document.createElement('input');
            mainCheckbox.type = 'checkbox';
            mainCheckbox.classList.add('custom-checkbox');
            mainCheckbox.checked = mainTask.completed;
             // ADDED: Associate checkbox with a label for accessibility (visually hidden span)
            const mainCheckboxId = `main-task-checkbox-${mainTask.id}`;
            mainCheckbox.id = mainCheckboxId;
            const mainCheckboxLabel = document.createElement('label');
            mainCheckboxLabel.setAttribute('for', mainCheckboxId);
            mainCheckboxLabel.classList.add('sr-only');
            mainCheckboxLabel.textContent = `Marcar tarea "${mainTask.text}" como completada`; // Dynamic label text
             taskPrefixGroup.appendChild(mainCheckboxLabel); // Add label first


            mainCheckbox.addEventListener('change', (event) => {
                toggleMainCompletion(mainTask.id, event.target.checked);
            });

            const priorityLabel = document.createElement('div');
            priorityLabel.classList.add('priority-color-label');
            priorityLabel.dataset.color = mainTask.priorityColor;
            priorityLabel.title = `Prioridad: ${mainTask.priorityColor.charAt(0).toUpperCase() + mainTask.priorityColor.slice(1)}`;
            priorityLabel.addEventListener('click', () => {
                 if (!mainTask.completed) cyclePriorityColor(mainTask.id);
            });

            taskPrefixGroup.append(mainCheckbox, priorityLabel); // Append checkbox and priority label

            const taskBody = document.createElement('div');
            taskBody.classList.add('task-body');

            const mainTaskSpan = document.createElement('span');
            mainTaskSpan.textContent = mainTask.text;
            mainTaskSpan.title = mainTask.text;

            const taskActionsGroup = document.createElement('div');
            taskActionsGroup.classList.add('task-actions-group');

            const linkButton = document.createElement('button');
            linkButton.classList.add('app-button', 'link-button');
            linkButton.innerHTML = '<i class="fas fa-link"></i>';
            linkButton.setAttribute('aria-label', 'Gestionar enlace');
            if (mainTask.linkUrl) {
                linkButton.classList.add('link-on');
                linkButton.title = `Abrir enlace: ${mainTask.linkUrl}`;
            } else {
                linkButton.classList.add('link-off');
                linkButton.title = 'Añadir enlace';
            }
            linkButton.addEventListener('click', () => {
                const task = findTaskById(mainTask.id);
                if (!task) return;
                 // If completed and no link, do nothing
                if (task.completed && !task.linkUrl) return;
                // If there's a link, open it (even if completed)
                if (task.linkUrl) {
                    // Basic URL validation for safety and better opening
                    try {
                        const url = new URL(task.linkUrl);
                        window.open(url.href, '_blank');
                    } catch (e) {
                         alert("Enlace inválido guardado: " + task.linkUrl);
                         console.error("Invalid URL saved:", task.linkUrl, e);
                    }
                } else if (!task.completed) { // If not completed and no link, prompt to add
                    const currentUrl = task.linkUrl || "";
                    let newUrl = prompt("Introduce la URL (ej: https://ejemplo.com):", currentUrl);

                    if (newUrl === null) return; // User cancelled prompt

                    newUrl = newUrl.trim();
                    let finalUrl = null;

                    if (newUrl !== "") {
                        if (!newUrl.toLowerCase().startsWith('http://') && !newUrl.toLowerCase().startsWith('https://')) {
                            finalUrl = 'https://' + newUrl; // Prepend https if missing
                        } else {
                            finalUrl = newUrl; // Use provided url if it starts with http/https
                        }
                        // Basic validation for the constructed URL
                        try {
                            new URL(finalUrl); // Check if it's a valid URL format
                        } catch (e) {
                             alert("La URL introducida no es válida.");
                             console.error("Invalid URL format entered:", finalUrl, e);
                             finalUrl = currentUrl; // Revert to previous or null if current was null
                        }
                    } else {
                        finalUrl = null; // Treat empty input as removing the link
                    }

                    if (task.linkUrl !== finalUrl) { // Only save/render if it changed
                         task.linkUrl = finalUrl;
                         saveTodosToLocalStorage();
                         syncAndRender();
                    }
                }
            });


            const googleCalendarButton = document.createElement('button');
            googleCalendarButton.classList.add('app-button', 'google-calendar-button');
            googleCalendarButton.innerHTML = '<i class="far fa-calendar-plus"></i>';
            googleCalendarButton.setAttribute('aria-label', 'Agendar recordatorio en Google Calendar');
            googleCalendarButton.title = 'Agendar recordatorio en Google Calendar';
            if (mainTask.completed) {
                googleCalendarButton.disabled = true;
                 googleCalendarButton.querySelector('i').style.color = '';
                 googleCalendarButton.title = 'Tarea completada, no se pueden agendar recordatorios.';
            } else {
                 googleCalendarButton.disabled = false;
                 googleCalendarButton.querySelector('i').style.color = '';
            }

            googleCalendarButton.addEventListener('click', () => {
                if (!mainTask.completed) {
                    showReminderModal(mainTask.id);
                }
            });

            const deleteMainButton = document.createElement('button');
            deleteMainButton.classList.add('app-button', 'delete-button');
            deleteMainButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteMainButton.setAttribute('aria-label', 'Eliminar tarea');
            deleteMainButton.addEventListener('click', () => {
                const task = findTaskById(mainTask.id);
                if (!task) return;

                // CAMBIO SOLICITADO 2: Preguntar SIEMPRE antes de eliminar una tarea principal
                // Eliminamos la condición previa y preguntamos directamente
                if (confirm(`¿Borramos esta tarea "${task.text}"?`)) {
                    // Si el usuario confirma (hace clic en OK), procedemos a eliminar
                    deleteTodo(task.id);
                }
                // Si el usuario cancela (hace clic en Cancelar), la función simplemente termina y no se hace nada.
            });
            taskActionsGroup.append(linkButton, googleCalendarButton, deleteMainButton);
            taskBody.append(mainTaskSpan, taskActionsGroup);
            mainTaskHeader.append(taskPrefixGroup, taskBody);

            return mainTaskHeader;
        }


        function createProgressBar(mainTask) {
             const progressContainer = document.createElement('div');
             progressContainer.classList.add('progress-container');
             const progressBar = document.createElement('div');
             progressBar.classList.add('progress-bar');
             let displayedProgress = 0;
             if (mainTask.completed) {
                 displayedProgress = 100;
             } else if (mainTask.subtasks && mainTask.subtasks.length > 0) {
                 const subtaskProgress = calculateSubtaskProgress(mainTask.subtasks);
                 displayedProgress = subtaskProgress === 100 ? 90 : subtaskProgress; // Cap at 90% if subtasks complete but main isn't
             }
             progressBar.style.width = `${displayedProgress}%`;
             progressContainer.appendChild(progressBar);
             return progressContainer;
        }

        function createAddSubtasksToggle(mainTaskId) {
             const addSubtasksToggle = document.createElement('button');
             addSubtasksToggle.classList.add('app-button', 'add-button', 'add-subtasks-toggle');
             addSubtasksToggle.innerHTML = '<i class="fas fa-plus"></i>';
             addSubtasksToggle.setAttribute('aria-label', 'Agregar sub-tarea');
             addSubtasksToggle.addEventListener('click', () => {
                 const task = findTaskById(mainTaskId);
                 if (task) {
                     if (task.completed) return;
                     task.showSubtaskUI = !task.showSubtaskUI;
                     if (task.showSubtaskUI && (!task.subtasks || task.subtasks.length === 0)) {
                         task.subtasks = [];
                     }
                     saveTodosToLocalStorage();
                     syncAndRender();
                     if (task.showSubtaskUI) {
                         const listItemElement = todoListContainer.querySelector(`li[data-task-id="${mainTaskId}"]`);
                         if (listItemElement) {
                           setTimeout(() => {
                               const inputElement = listItemElement.querySelector('.subtask-input-container input[type="text"]');
                               if (inputElement) inputElement.focus();
                           }, 0);
                         }
                     }
                 }
             });
             return addSubtasksToggle;
        }

        function createSubtasksList(mainTask) {
            const subtasksList = document.createElement('ul');
            subtasksList.classList.add('subtasks-list');
            if (mainTask.subtasks && mainTask.subtasks.length > 0) {
                mainTask.subtasks.forEach((subtask, subIndex) => {
                    const subtaskItem = document.createElement('li');
                    subtaskItem.dataset.subtaskId = subtask.id;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('custom-checkbox');
                    checkbox.checked = subtask.completed;
                    if (mainTask.completed) checkbox.disabled = true;

                    // ADDED: Associate subtask checkbox with a label for accessibility
                    const subtaskCheckboxId = `subtask-checkbox-${subtask.id}`;
                    checkbox.id = subtaskCheckboxId;
                    const subtaskCheckboxLabel = document.createElement('label');
                    subtaskCheckboxLabel.setAttribute('for', subtaskCheckboxId);
                    subtaskCheckboxLabel.classList.add('sr-only');
                    subtaskCheckboxLabel.textContent = `Marcar sub-tarea "${subtask.text}" como completada`; // Dynamic label text
                    subtaskItem.appendChild(subtaskCheckboxLabel); // Add label first

                    checkbox.addEventListener('change', () => {
                         if (!mainTask.completed) toggleSubtaskCompletion(mainTask.id, subtask.id);
                    });
                    const subtaskSpan = document.createElement('span');
                    subtaskSpan.textContent = subtask.text;
                    subtaskSpan.title = subtask.text;
                    const moveUpButton = document.createElement('button');
                    moveUpButton.classList.add('app-button', 'subtask-move-button');
                    moveUpButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    moveUpButton.setAttribute('aria-label', 'Mover sub-tarea arriba');
                    if (mainTask.completed || subIndex === 0) moveUpButton.disabled = true;
                    moveUpButton.addEventListener('click', () => {
                         if (!mainTask.completed) moveSubtaskUp(mainTask.id, subtask.id);
                    });
                    const moveDownButton = document.createElement('button');
                    moveDownButton.classList.add('app-button', 'subtask-move-button');
                    moveDownButton.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    moveDownButton.setAttribute('aria-label', 'Mover sub-tarea abajo');
                    if (mainTask.completed || subIndex === mainTask.subtasks.length - 1) moveDownButton.disabled = true;
                    moveDownButton.addEventListener('click', () => {
                         if (!mainTask.completed) moveSubtaskDown(mainTask.id, subtask.id);
                    });
                    const deleteSubtaskButton = document.createElement('button');
                    deleteSubtaskButton.classList.add('app-button', 'delete-button');
                    deleteSubtaskButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteSubtaskButton.setAttribute('aria-label', 'Eliminar sub-tarea');
                     if (mainTask.completed) deleteSubtaskButton.disabled = true;
                    deleteSubtaskButton.addEventListener('click', () => {
                         if (!mainTask.completed) deleteSubtask(mainTask.id, subtask.id);
                    });
                    subtaskItem.append(checkbox, subtaskSpan, moveUpButton, moveDownButton, deleteSubtaskButton);
                    subtasksList.appendChild(subtaskItem);
                });
            }
            return subtasksList;
        }

        function createSubtaskInputContainer(mainTaskId) {
             const subtaskInputContainer = document.createElement('div');
             subtaskInputContainer.classList.add('subtask-input-container');

             // ADDED: Visually hidden label for accessibility
             const subtaskInputId = `subtask-input-${mainTaskId}`; // Unique ID for the input
             const subtaskLabel = document.createElement('label');
             subtaskLabel.setAttribute('for', subtaskInputId);
             subtaskLabel.classList.add('sr-only');
             subtaskLabel.textContent = 'Agregar nueva sub-tarea'; // Static label text

             const subtaskInput = document.createElement('input');
             subtaskInput.type = 'text';
             subtaskInput.id = subtaskInputId; // Assign ID to input
             subtaskInput.placeholder = 'Agregar nueva sub-tarea...';

             const addSubtaskButton = document.createElement('button');
             addSubtaskButton.classList.add('app-button', 'add-button');
             addSubtaskButton.innerHTML = '<i class="fas fa-plus"></i>';
             addSubtaskButton.setAttribute('aria-label', 'Agregar sub-tarea'); // Ensure button has label


             const handleAddSubtask = () => addSubtask(mainTaskId, subtaskInput);
             addSubtaskButton.addEventListener('click', handleAddSubtask);
             subtaskInput.addEventListener('keypress', (e) => { if (e.key==='Enter'){ e.preventDefault(); handleAddSubtask();}});

             subtaskInputContainer.append(subtaskLabel, subtaskInput, addSubtaskButton); // Append label first
             return subtaskInputContainer;
        }

        function renderTodosUI() {
            if (!todoListContainer) return;
            todoListContainer.innerHTML = '';
            todos.forEach((mainTask) => {
                const listItem = document.createElement('li');
                listItem.classList.add('todo-item');
                listItem.dataset.taskId = mainTask.id;
                listItem.dataset.priorityColor = mainTask.priorityColor || 'none';
                if (mainTask.completed) listItem.classList.add('completed');
                // Keep showSubtaskUI class on item even if completed, though UI is hidden
                if (mainTask.showSubtaskUI) listItem.classList.add('show-subtask-ui');


                listItem.appendChild(createMainTaskHeader(mainTask));
                listItem.appendChild(createProgressBar(mainTask));
                // Always create toggle button, but hide with CSS if completed
                listItem.appendChild(createAddSubtasksToggle(mainTask.id));

                if (mainTask.subtasks && mainTask.subtasks.length > 0) {
                    listItem.appendChild(createSubtasksList(mainTask));
                }
                // Only create input container if showSubtaskUI is true AND not completed
                if (mainTask.showSubtaskUI && !mainTask.completed) {
                     listItem.appendChild(createSubtaskInputContainer(mainTask.id));
                }
                todoListContainer.appendChild(listItem);
            });
            if (todoInput) todoInput.value = '';
        }

        function cyclePriorityColor(taskId) {
             const task = findTaskById(taskId);
             if (task && !task.completed) {
                 const currentIndex = PRIORITY_COLORS.indexOf(task.priorityColor || 'none');
                 task.priorityColor = PRIORITY_COLORS[(currentIndex + 1) % PRIORITY_COLORS.length];
                 saveTodosToLocalStorage();
                 const listItemElement = todoListContainer.querySelector(`li[data-task-id="${task.id}"]`);
                 if (listItemElement) {
                     listItemElement.dataset.priorityColor = task.priorityColor;
                     const priorityLabelElement = listItemElement.querySelector('.priority-color-label');
                     if (priorityLabelElement) {
                         priorityLabelElement.dataset.color = task.priorityColor;
                         priorityLabelElement.title = `Prioridad: ${task.priorityColor.charAt(0).toUpperCase() + task.priorityColor.slice(1)}`;
                     }
                 }
             }
        }

        function showAppInterface() {
            if (welcomeSection) welcomeSection.classList.add('hidden');
            if (installInstructionsSection) installInstructionsSection.classList.add('hidden');
            if (appMainInterface) appMainInterface.classList.remove('hidden');
            if (todoInput) todoInput.focus();
        }

        function addTodo() {
            const newTodoText = todoInput.value.trim();
            if (newTodoText === '') return alert('Ingresa el nombre de la tarea.');
            const maxOrder = todos.length > 0 ? Math.max(...todos.map(t => t.order || 0)) : -1;
            const newTodo = {
                id: generateLocalId(),
                text: newTodoText,
                completed: false,
                completedDate: null,
                subtasks: [],
                showSubtaskUI: false,
                priorityColor: 'none',
                date: null,
                linkUrl: null,
                order: maxOrder + 1
            };
            todos.push(newTodo);
            saveTodosToLocalStorage();
            syncAndRender();
            if (todoInput) todoInput.value = '';

            // Check if it's the very first task being added globally (including past data)
             const hasAnyTasksEver = localStorage.getItem(TODOS_STORAGE_KEY);
             // Check if todos array length is 1 *after* pushing the new todo
             if (todos.length === 1 && welcomeSection && !welcomeSection.classList.contains('hidden')) {
                 // If adding the very first task, transition to the app interface
                 showAppInterface();
             }
             // If the interface is already visible because there were tasks loaded initially, do nothing here.


        }

        function addSubtask(mainTaskId, subtaskInput) {
             const newSubtaskText = subtaskInput.value.trim();
             if (newSubtaskText === '') return alert('Ingresa el nombre de la sub-tarea.');
             const mainTask = findTaskById(mainTaskId);
             if (mainTask && !mainTask.completed) {
                 if (!mainTask.subtasks) mainTask.subtasks = [];
                 mainTask.subtasks.push({ id: generateLocalId(), text: newSubtaskText, completed: false });
                 // Do NOT mark main task as complete here
                 // mainTask.completed = false;
                 // mainTask.completedDate = null;
                 mainTask.showSubtaskUI = false; // Close input after adding one subtask
                 saveTodosToLocalStorage();
                 syncAndRender();
             }
        }

        function deleteTodo(taskId) {
            const taskIndex = findTaskIndexById(taskId);
            if (taskIndex > -1) {
                const taskToDelete = todos[taskIndex];
                const todayForMedal = getTodayDateString('yyyy-mm-dd');
                 // Only decrease medal count if the task was completed *today*
                if (taskToDelete.completed && taskToDelete.completedDate === todayForMedal) {
                    updateMedalCount(-1);
                }
                todos.splice(taskIndex, 1);
                saveTodosToLocalStorage();
                syncAndRender();
                // Check if the list is empty AFTER deletion
                if (todos.length === 0 && welcomeSection && appMainInterface && installInstructionsSection) {
                    welcomeSection.classList.remove('hidden');
                    installInstructionsSection.classList.remove('hidden');
                    appMainInterface.classList.add('hidden');
                }
            }
        }

        function deleteSubtask(mainTaskId, subtaskId) {
             const mainTask = findTaskById(mainTaskId);
             if (mainTask && mainTask.subtasks && !mainTask.completed) {
                 const subtaskIndex = mainTask.subtasks.findIndex(sub => sub.id === subtaskId);
                 if (subtaskIndex > -1) {
                     mainTask.subtasks.splice(subtaskIndex, 1);
                     saveTodosToLocalStorage();
                     syncAndRender();
                 }
             }
        }

        function toggleSubtaskCompletion(mainTaskId, subtaskId) {
             const mainTask = findTaskById(mainTaskId);
             if (mainTask && mainTask.subtasks && !mainTask.completed) { // Only allow toggling if main task is not completed
                const subtask = mainTask.subtasks.find(sub => sub.id === subtaskId);
                if (subtask) {
                     subtask.completed = !subtask.completed;
                     saveTodosToLocalStorage();
                     syncAndRender();
                 }
             }
        }

        function toggleMainCompletion(taskId, isChecked) {
            const task = findTaskById(taskId);
            if (task) {
                const todayForMedal = getTodayDateString('yyyy-mm-dd');
                const wasCompletedTodayBefore = task.completed && task.completedDate === todayForMedal;

                 // Prevent unchecking if the task has incomplete subtasks
                 if (!isChecked && task.subtasks && task.subtasks.some(sub => !sub.completed)) {
                     // Visually revert checkbox state if needed (syncAndRender will handle the data)
                     const listItemElement = todoListContainer.querySelector(`li[data-task-id="${task.id}"]`);
                      if(listItemElement) {
                          const checkboxElement = listItemElement.querySelector('.main-task-header .custom-checkbox');
                          if(checkboxElement) checkboxElement.checked = true; // Keep it checked visually for a moment
                      }
                     alert("No puedes desmarcar una tarea principal si tiene sub-tareas incompletas.");
                     // Re-render immediately to ensure UI matches data
                     syncAndRender();
                     return; // Stop here, do not change task.completed state
                 }

                // CORRECCIÓN URGENTE: Calcular si tenía subtareas incompletas *antes* de completarlas automáticamente
                const hadIncompleteSubtasksBeforeCompletion = task.subtasks && task.subtasks.some(sub => !sub.completed);
                const hasNoSubtasks = !task.subtasks || task.subtasks.length === 0; // Esta comprobación está bien como está

                task.completed = isChecked;

                if (isChecked) { // Task is being marked as completed
                    task.completedDate = todayForMedal;
                    task.showSubtaskUI = false; // Hide subtask input when main task is completed
                    // Auto-complete all subtasks if main task is checked
                    if (task.subtasks) {
                       task.subtasks.forEach(sub => sub.completed = true); // <-- Esto ocurre *después* de la comprobación
                    }

                    if (!wasCompletedTodayBefore) {
                        updateMedalCount(1);
                    }

                    // Trigger confetti only if it just became completed today AND (it had incomplete subtasks BEFORE OR it had no subtasks)
                    if (!wasCompletedTodayBefore && (hadIncompleteSubtasksBeforeCompletion || hasNoSubtasks) && typeof confetti === 'function') {
                         confetti({ particleCount: 150, spread: 90, origin: { y: 0.55 }});
                    }

                } else { // Becoming incomplete
                    if (wasCompletedTodayBefore) {
                        updateMedalCount(-1);
                    }
                    task.completedDate = null;
                     // Do NOT auto-uncomplete subtasks when main task is unchecked
                }
                 saveTodosToLocalStorage();
                 syncAndRender(); // Re-render after state change
            }
        }


        function moveSubtask(mainTaskId, subtaskId, direction) {
            const mainTask = findTaskById(mainTaskId);
            if (mainTask && mainTask.subtasks && !mainTask.completed) {
                const subtaskIndex = mainTask.subtasks.findIndex(sub => sub.id === subtaskId);
                if (subtaskIndex === -1) return;

                const newIndex = subtaskIndex + direction;
                if (newIndex >= 0 && newIndex < mainTask.subtasks.length) {
                    [mainTask.subtasks[subtaskIndex], mainTask.subtasks[newIndex]] =
                    [mainTask.subtasks[newIndex], mainTask.subtasks[subtaskIndex]];
                    saveTodosToLocalStorage();
                    syncAndRender();
                }
            }
        }
        function moveSubtaskUp(mainTaskId, subtaskId) { moveSubtask(mainTaskId, subtaskId, -1); }
        function moveSubtaskDown(mainTaskId, subtaskId) { moveSubtask(mainTaskId, subtaskId, 1); }

        function performManualSort() {
             todos.sort((a, b) => {
                 // 1. Sort by completion status (incomplete first)
                 if (a.completed !== b.completed) {
                     return a.completed ? 1 : -1;
                 }
                 // 2. Sort by priority (higher priority first)
                 const rankA = PRIORITY_ORDER[a.priorityColor] || PRIORITY_ORDER['none'];
                 const rankB = PRIORITY_ORDER[b.priorityColor] || PRIORITY_ORDER['none'];
                 if (rankA !== rankB) return rankA - rankB;

                 // 3. Sort by date (tasks with dates first, then by date ascending)
                 const hasDateA = a.date !== null && a.date !== undefined && a.date !== "";
                 const hasDateB = b.date !== null && b.date !== undefined && b.date !== "";

                 if (hasDateA && !hasDateB) return -1; // A has date, B doesn't -> A comes first
                 if (!hasDateA && hasDateB) return 1;  // B has date, A doesn't -> B comes first

                 if (hasDateA && hasDateB) { // Both have dates, sort by date
                     const dateA = new Date(a.date).getTime();
                     const dateB = new Date(b.date).getTime();
                     if (dateA !== dateB) return dateA - dateB; // Earlier date comes first
                 }

                 // 4. Finally, maintain original order (or current order) - Fallback sort
                 return (a.order || 0) - (b.order || 0);
             });
             // Re-assign order to maintain the new sorted order for next time
             todos.forEach((task, index) => {
                 task.order = index;
             });
             saveTodosToLocalStorage();
             syncAndRender();
        }

        function enableDarkMode() {
            body.classList.add('dark-mode');
            localStorage.setItem(THEME_STORAGE_KEY, 'dark');
            if (darkModeToggle) {
                darkModeToggle.querySelector('i').className = 'fas fa-sun';
                darkModeToggle.setAttribute('aria-label', 'Alternar a modo claro');
                darkModeToggle.title = 'Alternar a modo claro';
            }
        }

        function disableDarkMode() {
            body.classList.remove('dark-mode');
            localStorage.setItem(THEME_STORAGE_KEY, 'light');
            if (darkModeToggle) {
                 darkModeToggle.querySelector('i').className = 'fas fa-moon';
                 darkModeToggle.setAttribute('aria-label', 'Alternar a modo oscuro');
                 darkModeToggle.title = 'Alternar a modo oscuro';
            }
        }

        function toggleDarkMode() {
            body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode();
            syncAndRender(); // Re-render might be needed for some complex styles depending on setup
        }

        function exportAllDataLocal() {
            const dataToExport = {
                theme: localStorage.getItem(THEME_STORAGE_KEY) || 'dark',
                dailyMedalData: JSON.parse(localStorage.getItem(MEDALS_STORAGE_KEY) || '{}'),
                quickNotesContent: localStorage.getItem(QUICK_NOTES_STORAGE_KEY) || '',
                tasks: todos
            };

            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
            a.download = `todolist-backup-local-${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Datos exportados localmente como ' + a.download);
        }

        function applyImportedData(importedData, source = "local file") {
            try {
                if (typeof importedData !== 'object' || importedData === null || !Array.isArray(importedData.tasks)) {
                    throw new Error('El formato del archivo es inválido o no contiene tareas.');
                }

                const themeToApply = importedData.theme === 'light' ? 'light' : 'dark';
                localStorage.setItem(THEME_STORAGE_KEY, themeToApply);
                if (themeToApply === 'dark') {
                    enableDarkMode();
                } else {
                    disableDarkMode();
                }

                if (importedData.dailyMedalData && typeof importedData.dailyMedalData === 'object') {
                    // Basic validation for medal data structure
                    if (typeof importedData.dailyMedalData.date === 'string' && typeof importedData.dailyMedalData.count === 'number') {
                         localStorage.setItem(MEDALS_STORAGE_KEY, JSON.stringify(importedData.dailyMedalData));
                         displayMedalCount(importedData.dailyMedalData.count || 0);
                    } else {
                         console.warn("Invalid daily medal data format in imported file:", importedData.dailyMedalData);
                         localStorage.removeItem(MEDALS_STORAGE_KEY);
                         displayMedalCount(0);
                    }

                } else {
                    localStorage.removeItem(MEDALS_STORAGE_KEY);
                    displayMedalCount(0);
                }

                if (typeof importedData.quickNotesContent === 'string') {
                    quickNotesArea.value = importedData.quickNotesContent;
                    localStorage.setItem(QUICK_NOTES_STORAGE_KEY, importedData.quickNotesContent);
                } else {
                    quickNotesArea.value = '';
                    localStorage.removeItem(QUICK_NOTES_STORAGE_KEY);
                }

                todos = importedData.tasks.map(task => ({
                    id: task.id || generateLocalId(), // Ensure ID exists
                    text: task.text || 'Tarea importada',
                    completed: !!task.completed,
                    completedDate: task.completedDate || null,
                    subtasks: Array.isArray(task.subtasks) ? task.subtasks.map(sub => ({
                        id: sub.id || generateLocalId(), // Ensure subtask ID exists
                        text: sub.text || 'Sub-tarea importada',
                        completed: !!sub.completed
                    })) : [],
                    showSubtaskUI: !!task.showSubtaskUI,
                    priorityColor: PRIORITY_COLORS.includes(task.priorityColor) ? task.priorityColor : 'none',
                    date: (typeof task.date === 'string' && task.date.match(/^\d{4}-\d{2}-\d{2}$/)) ? task.date : null, // Validate date format
                    linkUrl: typeof task.linkUrl === 'string' ? task.linkUrl : null,
                    order: typeof task.order === 'number' ? task.order : Date.now() // Assign a default if missing
                }));

                // Simple unique ID check after mapping (could still have collisions but less likely)
                 const idMap = new Set();
                 todos.forEach(task => {
                     if (idMap.has(task.id)) {
                         task.id = generateLocalId(); // Assign new ID if duplicate
                     }
                     idMap.add(task.id);
                     if (task.subtasks) {
                         const subIdMap = new Set();
                         task.subtasks.forEach(subtask => {
                             if (subIdMap.has(subtask.id)) {
                                 subtask.id = generateLocalId(); // Assign new ID if duplicate within subtasks of this task
                             }
                             subIdMap.add(subtask.id);
                         });
                     }
                 });


                saveTodosToLocalStorage();

                // Determine which section to show based on imported tasks
                if (todos.length === 0) {
                     if (welcomeSection) welcomeSection.classList.remove('hidden');
                     if (installInstructionsSection) installInstructionsSection.classList.remove('hidden');
                     if (appMainInterface) appMainInterface.classList.add('hidden');
                } else {
                     showAppInterface(); // Calls renderTodosUI internally
                }

                // CAMBIO SOLICITADO 2: Aviso y recarga automática después de importar
                alert(`Datos importados exitosamente desde ${source}. La página se recargará para aplicar los cambios.`);
                window.location.reload(); // Forzar recarga para asegurar que todo el estado se actualice

            } catch (error) {
                console.error(`Error al procesar datos importados desde ${source}:`, error);
                alert(`Error al procesar datos importados: ${error.message}`);
            }
        }


        function importAllDataLocal(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("¡Atención! Importar datos reemplazará todos los datos actuales (tareas, notas, medallas, tema). ¿Deseas continuar?")) {
                if (importFileInput) importFileInput.value = ''; // Reset file input
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    applyImportedData(importedData, "archivo local");
                } catch (error) {
                     console.error('Error al parsear JSON del archivo local:', error);
                     alert(`Error al leer el archivo local: ${error.message}. Asegúrate de que sea un archivo JSON válido de ToDayList.`);
                } finally {
                    if (importFileInput) importFileInput.value = ''; // Reset file input
                }
            };
            reader.onerror = () => {
                alert('Error al leer el archivo local.');
                if (importFileInput) importFileInput.value = ''; // Reset file input
            };
            reader.readAsText(file);
        }


        document.addEventListener('DOMContentLoaded', () => {
            todoInput = document.getElementById('new-todo-input');
            addTodoButton = document.getElementById('add-todo-button');
            todoListContainer = document.getElementById('todo-list');
            reorderButton = document.getElementById('reorder-button');
            darkModeToggle = document.getElementById('dark-mode-toggle');
            body = document.body;
            medalCountDisplay = document.getElementById('medal-count');

            infoButton = document.getElementById('info-button');
            infoModal = document.getElementById('info-modal');
            closeModalButton = document.getElementById('close-modal-button');

            quickNotesArea = document.getElementById('quick-notes-area');
            clearNotesButton = document.getElementById('clear-notes-button');

            exportDataButton = document.getElementById('export-data-button');
            importDataButton = document.getElementById('import-data-button');
            importFileInput = document.getElementById('import-file-input');

            exportDriveButton = document.getElementById('export-drive-button');
            importDriveButton = document.getElementById('import-drive-button');

            welcomeSection = document.getElementById('welcome-section');
            startAppButton = document.getElementById('start-app-button');
            appMainInterface = document.getElementById('app-main-interface');
            installInstructionsSection = document.getElementById('install-instructions-section');

            reminderModal = document.getElementById('reminder-modal');
            closeReminderModalButton = document.getElementById('close-reminder-modal');
            reminderTaskTextElement = document.getElementById('reminder-task-text');
            reminderDateInput = document.getElementById('reminder-date');
            reminderTimeInput = document.getElementById('reminder-time');
            scheduleReminderButton = document.getElementById('schedule-reminder-button');


            // Initialize theme first
            const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            if (storedTheme === 'light') {
                disableDarkMode();
            } else {
                enableDarkMode(); // Default to dark if no theme stored or invalid value
            }

            loadTodosFromLocalStorage();

            // Determine which section to show based on stored tasks
            if (todos.length === 0) {
                // If no tasks, show welcome/install sections and hide main interface
                if (welcomeSection) welcomeSection.classList.remove('hidden');
                if (installInstructionsSection) installInstructionsSection.classList.remove('hidden');
                if (appMainInterface) appMainInterface.classList.add('hidden');
            } else {
                // If tasks exist, show main interface and hide welcome/install sections
                if (welcomeSection) welcomeSection.classList.add('hidden');
                if (installInstructionsSection) installInstructionsSection.classList.add('hidden');
                if (appMainInterface) appMainInterface.classList.remove('hidden');
                renderTodosUI(); // Render tasks only if main interface is shown
            }


            const initialMedalData = loadAndRefreshMedalData();
            displayMedalCount(initialMedalData.count);

            // Add event listeners only after elements are found
            if (addTodoButton && todoInput) {
                 addTodoButton.addEventListener('click', addTodo);
                 todoInput.addEventListener('keypress', (e) => { if (e.key==='Enter'){ e.preventDefault(); addTodo();}});
            }
            if (reorderButton) {
                 reorderButton.addEventListener('click', performManualSort);
            }
            if (darkModeToggle) {
                 darkModeToggle.addEventListener('click', toggleDarkMode);
            }


            if (startAppButton) {
                startAppButton.addEventListener('click', showAppInterface);
            }

            if (infoButton && infoModal && closeModalButton) {
                infoButton.addEventListener('click', () => {
                     infoModal.classList.add('visible');
                     // ADDED: Set focus when modal opens
                    requestAnimationFrame(() => {
                         const firstFocusableElement = infoModal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                         if (firstFocusableElement) {
                             firstFocusableElement.focus();
                         } else {
                             closeModalButton.focus(); // Fallback focus on close button
                         }
                    });
                });
                closeModalButton.addEventListener('click', () => infoModal.classList.remove('visible'));
                infoModal.addEventListener('click', (event) => {
                    if (event.target === infoModal) infoModal.classList.remove('visible');
                });
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && infoModal.classList.contains('visible')) {
                        infoModal.classList.remove('visible');
                    }
                     // Basic focus trapping for modals (optional but good)
                     // Could add more robust focus trapping here if needed
                });
            }

            if (reminderModal && closeReminderModalButton && scheduleReminderButton && reminderDateInput && reminderTimeInput && reminderTaskTextElement) {
                closeReminderModalButton.addEventListener('click', hideReminderModal);
                scheduleReminderButton.addEventListener('click', handleScheduleReminderClick);
                 // Close modal on clicking outside the content
                reminderModal.addEventListener('click', (event) => {
                    if (event.target === reminderModal) {
                        hideReminderModal();
                    }
                });
                 // Close modal on pressing Escape key
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && reminderModal.classList.contains('visible')) {
                        hideReminderModal();
                    }
                     // Basic focus trapping for modals (optional but good)
                });
            }


            if (quickNotesArea && clearNotesButton) {
                const savedNotes = localStorage.getItem(QUICK_NOTES_STORAGE_KEY);
                if (savedNotes) quickNotesArea.value = savedNotes;
                quickNotesArea.addEventListener('input', () => {
                    localStorage.setItem(QUICK_NOTES_STORAGE_KEY, quickNotesArea.value);
                });
                clearNotesButton.addEventListener('click', () => {
                    quickNotesArea.value = '';
                    localStorage.removeItem(QUICK_NOTES_STORAGE_KEY);
                    quickNotesArea.focus();
                });
            }

            if (exportDataButton) {
                exportDataButton.addEventListener('click', exportAllDataLocal);
            }
            if (importDataButton && importFileInput) {
                importDataButton.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', importAllDataLocal);
            }

            if (exportDriveButton) {
                exportDriveButton.addEventListener('click', () => handleAuthClick(exportToGoogleDrive));
            }
            if (importDriveButton) {
                importDriveButton.addEventListener('click', () => handleAuthClick(importFromGoogleDrive));
            }

            // Ensure Google API callbacks are triggered if scripts loaded before DOMContentLoaded
            // Added explicit check for window.googleApiCallbacks before accessing properties
            if (window.googleApiCallbacks && window.isGoogleGisScriptReady && typeof window.googleApiCallbacks.gisLoaded === 'function') {
                console.log("DOMContentLoaded: GIS script was ready, ensuring initialization.");
                window.googleApiCallbacks.gisLoaded();
            } else if (!window.isGoogleGisScriptReady) {
                 console.log("DOMContentLoaded: GIS script was not ready. Waiting for onload event.");
            } else {
                 console.error("DOMContentLoaded: window.googleApiCallbacks.gisLoaded is not a function or googleApiCallbacks is not defined.");
            }

            if (window.googleApiCallbacks && window.isGoogleGapiScriptReady && typeof window.googleApiCallbacks.gapiLoaded === 'function') {
                console.log("DOMContentLoaded: GAPI script was ready, ensuring initialization.");
                window.googleApiCallbacks.gapiLoaded();
            } else if (!window.isGoogleGapiScriptReady) {
                 console.log("DOMContentLoaded: GAPI script was not ready. Waiting for onload event.");
            } else {
                 console.error("DOMContentLoaded: window.googleApiCallbacks.gapiLoaded is not a function or googleApiCallbacks is not defined.");
            }


            // Double-check Drive buttons state after DOM is ready and scripts might have loaded
            maybeEnableDriveButtons();

            // REMOVED: Service Worker registration code

        });
    </script>

</body>
</html>
