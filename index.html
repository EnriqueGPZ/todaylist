<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToDayList – Simplifica tu día</title>

  <!--  Favicon & PWA basics  -->
  <link rel="icon" sizes="192x192" href="/ToDayList-192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/ToDayList-192.png" />
  
  <!--  Google Fonts & FontAwesome  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!--  Mini‑estilos (puedes moverlos a style.css)  -->
  <style>
    :root{ --bg:#f7f7f7; --fg:#222; --brand:#0077ff; --radius:12px; --gap:.4rem; }
    [data-dark="true"]{ --bg:#111; --fg:#f7f7f7; }
    *{ box-sizing:border-box; font-family:"Quicksand",sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--fg); display:flex; justify-content:center; }
    .container{ max-width:460px; width:100%; padding:2rem .8rem; }
    h1,h2{ text-align:center; margin:.2em 0; }
    button{ cursor:pointer; border:none; border-radius:var(--radius); padding:.6rem 1rem; background:var(--brand); color:#fff; font-weight:700; }
    button.app-button{ display:inline-flex; align-items:center; gap:.5rem; }
    #todo-input-container{ display:flex; gap:var(--gap); margin-top:var(--gap); }
    #new-todo-input{ flex:1; padding:.6rem; border-radius:var(--radius); border:1px solid #ccc; }
    ul{ list-style:none; margin:1rem 0 0; padding:0; }
    li.todo-item{ background:#fff; padding:.6rem; margin-bottom:var(--gap); border-radius:var(--radius); display:flex; align-items:center; justify-content:space-between; }
    li.todo-item.done{ opacity:.5; text-decoration:line-through; }
    .priority-indicator{ width:14px; height:14px; border-radius:3px; margin-right:.6rem; cursor:pointer; }
    #dark-mode-toggle{ position:fixed; bottom:1rem; right:1rem; background:#444; }
    #authBox{ display:flex; flex-direction:column; align-items:center; gap:1rem; margin-top:4rem; }
    #quick-notes-area{ width:100%; min-height:100px; border-radius:var(--radius); border:1px solid #ccc; padding:.6rem; resize:vertical; }
    footer{ text-align:center; margin-top:3rem; opacity:.7; font-size:.85rem; }
  </style>
</head>
<body>
  <!--  Caja de autenticación  -->
  <section id="authBox">
    <h2>Acceder a ToDayList</h2>
    <button id="btnGoogle" class="app-button" aria-label="Entrar con Google"><i class="fab fa-google"></i> Entrar con Google</button>
    <p id="authStatus" role="alert"></p>
  </section>

  <!--  App principal  -->
  <div id="app" class="container" hidden>
    <h1>ToDayList</h1>

    <!--  Entrada nueva tarea  -->
    <div id="todo-input-container">
      <input id="new-todo-input" type="text" placeholder="Agregar nueva tarea…" />
      <button id="add-todo-button" class="app-button" aria-label="Agregar tarea"><i class="fas fa-plus"></i></button>
    </div>

    <!--  Lista  -->
    <ul id="todo-list"></ul>

    <!--  Notas rápidas  -->
    <textarea id="quick-notes-area" placeholder="Anotaciones rápidas…"></textarea>
    <button id="clear-notes-button" class="app-button" aria-label="Borrar anotaciones"><i class="fas fa-eraser"></i> Borrar</button>

    <!--  Controles  -->
    <div style="text-align:center;margin-top:1.5rem;">
      <button id="logoutButton" class="app-button"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </div>
  </div>

  <!--  Dark‑mode  -->
  <button id="dark-mode-toggle" aria-label="Cambiar tema"><i class="fas fa-moon"></i></button>

  <!--  Firebase & lógica aplicación  -->
  <script type="module">
    /* =====================   Firebase init   ===================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyJ0DJ-4jgzyT1kf5U4mBZLZJVT_MQ2To",
      authDomain: "todaylist-43353.firebaseapp.com",
      projectId: "todaylist-43353",
      storageBucket: "todaylist-43353.appspot.com",   //  ✔️ corregido
      messagingSenderId: "673096442524",
      appId: "1:673096442524:web:8d5e35e3cb1a5a9a7c4359",
      measurementId: "G-M5TSNXX2DX"
    };

    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getFirestore(app);

    /* =====================   DOM refs   ===================== */
    const authBox  = document.getElementById('authBox');
    const btnGoogle= document.getElementById('btnGoogle');
    const authMsg  = document.getElementById('authStatus');

    const appBox   = document.getElementById('app');
    const input    = document.getElementById('new-todo-input');
    const addBtn   = document.getElementById('add-todo-button');
    const listUL   = document.getElementById('todo-list');
    const logoutBtn= document.getElementById('logoutButton');
    const notesTA  = document.getElementById('quick-notes-area');
    const clearNotesBtn = document.getElementById('clear-notes-button');
    const darkToggle    = document.getElementById('dark-mode-toggle');

    /* =====================   Helpers   ===================== */
    const show = where => {
      authBox.hidden = where !== 'auth';
      appBox.hidden  = where !== 'app';
    };
    const info = txt => authMsg.textContent = txt;

    /* =====================   Auth   ===================== */
    const provider = new GoogleAuthProvider();
    btnGoogle.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => info(err.message)) );
    logoutBtn.addEventListener('click', () => signOut(auth));

    /* =====================   Firestore logic   ===================== */
    let unsubTasks = () => {};
    let unsubNotes = () => {};

    onAuthStateChanged(auth, user => {
      if(!user){
        show('auth');
        unsubTasks();
        unsubNotes();
        return;
      }

      //  Crea doc raíz si no existe
      setDoc(doc(db, 'users', user.uid), { displayName: user.displayName, createdAt: serverTimestamp() }, { merge:true });

      /* ----  TASKS  ---- */
      const tasksRef = collection(db, 'users', user.uid, 'tasks');
      unsubTasks = onSnapshot(tasksRef, snap => {
        listUL.innerHTML = '';
        snap.docs.forEach(d => {
          const data = d.data();
          const li = document.createElement('li');
          li.className = 'todo-item' + (data.done ? ' done' : '');

          //  Done toggle
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = data.done;
          chk.addEventListener('change', () => setDoc(d.ref, { done: chk.checked }, { merge:true }));

          //  Priority indicator
          const prio = document.createElement('span');
          prio.className = 'priority-indicator';
          prio.style.background = data.priority || 'grey';
          const cycle = ['red','orange','yellow','green','grey'];
          prio.addEventListener('click', () => {
            const idx = cycle.indexOf(data.priority||'grey');
            const next = cycle[(idx+1)%cycle.length];
            setDoc(d.ref, { priority: next }, { merge:true });
          });

          //  Text
          const span = document.createElement('span');
          span.textContent = data.title;
          span.style.flex = '1';
          span.style.marginLeft = '.4rem';

          //  Delete
          const del = document.createElement('button');
          del.innerHTML = '<i class="fas fa-trash"></i>';
          del.style.background = 'transparent';
          del.style.color = 'inherit';
          del.addEventListener('click', () => deleteDoc(d.ref));

          li.append(chk, prio, span, del);
          listUL.append(li);
        });
      });

      /* ----  Notes  ---- */
      const notesDoc = doc(db, 'users', user.uid, 'meta', 'notes');
      unsubNotes = onSnapshot(notesDoc, snap => {
        if(snap.exists()) notesTA.value = snap.data().text || '';
      });
      //  Update on blur
      notesTA.addEventListener('blur', () => setDoc(notesDoc, { text: notesTA.value }, { merge:true }));
      clearNotesBtn.addEventListener('click', () => { notesTA.value=''; setDoc(notesDoc, { text:'' }, { merge:true }); });

      info('');
      show('app');
    });

    /* ----  Add task  ---- */
    const saveTask = title => {
      const id = Date.now().toString();
      setDoc(doc(db,'users',auth.currentUser.uid,'tasks',id), { title, done:false, priority:'grey', createdAt: serverTimestamp() });
    };
    addBtn.addEventListener('click', () => { if(input.value.trim()) { saveTask(input.value.trim()); input.value=''; } });
    input.addEventListener('keydown', e => { if(e.key==='Enter' && input.value.trim()){ saveTask(input.value.trim()); input.value=''; } });

    /* ----  Dark / light  ---- */
    const DARK_KEY = 'todaylist-dark';
    const setDark = v => { document.body.dataset.dark = v; localStorage.setItem(DARK_KEY,v); darkToggle.innerHTML = v?' <i class="fas fa-sun"></i> ':' <i class="fas fa-moon"></i> '; };
    setDark(localStorage.getItem(DARK_KEY)==='true');
    darkToggle.addEventListener('click', () => setDark(!(document.body.dataset.dark==='true')));
  </script>
</body>
</html>
